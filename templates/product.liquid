{% comment %}
  ================================================================
  PRODUCT TEMPLATE - THE ASSEMBLER
  ================================================================
  This file creates the final page layout.
  1. It builds the two-column grid.
  2. It calls the main 'template--product' section (which is now just content).
  3. It then calls the other sections, which will now appear correctly inside the main column.
{% endcomment %}

<div class="container--collection-page">
  <div class="collection-page__layout">
    <main class="collection-page__main">
      {%- assign back_to_collection_url = collection.url -%}
      {%- assign back_to_collection_title = collection.title -%}

      {%- if back_to_collection_url == blank -%}
        {%- assign bulk_collection = product.collections | where: 'handle', 'bulk-items' | first -%}
        {%- if bulk_collection -%}
          {%- assign back_to_collection_url = bulk_collection.url -%}
          {%- assign back_to_collection_title = bulk_collection.title -%}
        {%- elsif product.collections.size > 0 -%}
          {%- assign first_collection = product.collections.first -%}
          {%- assign back_to_collection_url = first_collection.url -%}
          {%- assign back_to_collection_title = first_collection.title -%}
        {%- else -%}
          {%- assign back_to_collection_url = routes.root_url -%}
          {%- assign back_to_collection_title = 'Menu' -%}
        {%- endif -%}
      {%- endif -%}

      <div class="collection-header">
        <a href="{{ back_to_collection_url }}" class="collection-header__title back-to-collection-link">
          <svg class="back-arrow-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
            <path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"></path>
          </svg>
          <span>{{ back_to_collection_title | default: 'Menu' }}</span>
        </a>
      </div>

      <div id="CollectionProductGrid">
        <ol class="product-grid" data-paginate-items="1">
          <li class="grid__item">
            {% comment %} This renders the main product content (image, form, etc) {% endcomment %}
            {% if product.handle == 'custom-meals' or product.handle == 'custom-breakfast' %}
              {% section 'template--product-custom-meals' %}
            {% else %}
              {% section 'template--product' %}
            {% endif %}
          </li>
        </ol>
      </div>

      {% comment %} 
        This is the new part. We render the other sections here,
        directly in the main column, after the main product info.
      {% endcomment %}
        <div class="product-page-additional-sections">
          {% section 'template--product-description' %}
          {% section 'text--text-adverts' %}
          {% section 'accordion' %}
          {% section 'apps' %}
          {% section 'template--product--recommendations' %}
        </div>

    </main>

    <aside class="collection-page__sidebar">
      {% render 'cart-preview-sidebar' %}
    </aside>
  </div>
</div>
