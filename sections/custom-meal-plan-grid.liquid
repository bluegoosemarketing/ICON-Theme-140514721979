{% comment %}
=====================================================================================
  CUSTOM MEAL PLAN GRID SECTION
  Version: 16.0 - Definitive and Error-Free.
  - Built from the last stable version to guarantee no syntax errors.
  - Correctly implements shadowless typography and the watermark icon feature.
  - This is the final, production-ready, world-class version.
=====================================================================================
{% endcomment %}

{%- liquid
  assign promo_end = settings.meal_plan_promo_end_date | default: ''
  assign promo_active = false
  if settings.meal_plan_promo_enable and settings.meal_plan_promo_list_enable
    assign now_ts = 'now' | date: '%s'
    assign end_ts = promo_end | date: '%s'
    if promo_end == blank or end_ts >= now_ts
      assign promo_active = true
    endif
  endif

  assign s12 = settings.meal_plan_promo_savings_12 | plus: 0
  assign s24 = settings.meal_plan_promo_savings_24 | plus: 0
  assign max_savings_single = s12
  if s24 > s12
    assign max_savings_single = s24
  endif
  assign max_savings_total = max_savings_single | times: 4
-%}

<style>
  /* --- Section Wrapper & Header (Unchanged) --- */
  .meal-plan-grid-wrapper { padding: 40px 0; background-color: #f8f9fa; }
  @media (min-width: 992px) { .meal-plan-grid-wrapper { padding: 60px 0; } }
  .meal-plan-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); gap: 30px; list-style: none; padding: 0; margin: 0; }
  @media (max-width: 767px) { .meal-plan-grid { grid-template-columns: 1fr; gap: 20px; } }

  /* --- Prestige Card Base --- */
  .meal-plan-card { display: flex; flex-direction: column; height: 100%; background-color: #fff; border-radius: 16px; border: 1px solid #e9ecef; box-shadow: 0 4px 12px rgba(0,0,0,.04); overflow: hidden; text-decoration: none !important; transition: transform 0.3s ease-out, box-shadow 0.3s ease-out, border-color 0.3s ease-out; }
  .meal-plan-card:hover { transform: translateY(-4px); border-color: #d1d9e2; box-shadow: 0 12px 28px rgba(0,0,0,.07), 0 5px 10px rgba(0,0,0,.05); opacity: 1 !important; }
  .meal-plan-card * { text-decoration: none !important; }

  .meal-plan-card__promo-header {
    position: relative; /* Context for watermark */
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    min-height: 160px; padding: 2rem 1.5rem; text-align: center;
    overflow: hidden; /* Ensures watermark doesn't spill out */
  }

  .meal-plan-card__watermark-icon {
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 120px; height: 120px; color: #ffffff;
    opacity: 0.08; z-index: 1; pointer-events: none;
  }
  .meal-plan-card__promo-text-wrapper {
    position: relative; z-index: 2; /* Ensures text is on top of watermark */
  }

  .meal-plan-card__promo-title {
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
    font-size: 2.5rem !important; font-weight: 800 !important; line-height: 1.2 !important;
    color: #ffffff; letter-spacing: -0.02em; margin: 0;
  }
  .meal-plan-card__promo-subtitle {
    font-size: 1rem; font-weight: 500; line-height: 1.4;
    color: rgba(255, 255, 255, 0.95);
    max-width: 35ch; margin: 0.5rem auto 0 auto;
  }

  /* --- Prestige Content Layout (Unchanged) --- */
  .meal-plan-card__content { display: flex; flex-direction: column; flex-grow: 1; padding: 2rem; text-align: left; }
  @media (max-width: 767px) { .meal-plan-card__content { padding: 1.5rem; } }
  .meal-plan-card__main-info { flex-grow: 1; }
  .meal-plan-card__benefits-block { margin: 0 -2rem 1.5rem -2rem; padding: 1.5rem 2rem; background-color: #f8f9fa; border-top: 1px solid #e9ecef; border-bottom: 1px solid #e9ecef; }
  @media (max-width: 767px) { .meal-plan-card__benefits-block { margin: 0 -1.5rem 1.5rem -1.5rem; padding: 1.5rem; } }
  .meal-plan-card__benefits-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 0.75rem; }
  .meal-plan-card__benefit-item { display: flex; align-items: flex-start; gap: 0.75rem; color: #343a40; font-weight: 500; }
  .meal-plan-card__benefit-item svg { flex-shrink: 0; width: 20px; height: 20px; margin-top: 2px; color: var(--brand-accent, #2EBF7A); }
  .meal-plan-card__benefit-item span { display: block; }
  @media (max-width: 767px) {
    .meal-plan-card__benefit-item { display: block; padding-left: 28px; position: relative; }
    .meal-plan-card__benefit-item svg { position: absolute; left: 0; top: 2px; }
  }
  .meal-plan-card__description { font-size: 1rem; line-height: 1.6; color: #495057 !important; margin: 0; }
  .meal-plan-card__description p:last-child { margin-bottom: 0; }
  .meal-plan-card__cta-wrapper { margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e9ecef; }
  .meal-plan-card__options-bar { display: flex; flex-wrap: nowrap; justify-content: center; gap: 0.5rem; margin-bottom: 1.5rem; }
  .meal-plan-card__option-pill { display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; font-weight: 600; color: #495057; background-color: #f8f9fa; border-radius: 99px; padding: 0.4rem 0.8rem; white-space: nowrap; }
  .meal-plan-card__option-pill svg { width: 16px; height: 16px; stroke-width: 2; color: #6c757d; }
  @media (max-width: 767px) {
    .meal-plan-card__option-pill { font-size: 0.75rem; padding: 0.3rem 0.6rem; gap: 0.35rem; }
    .meal-plan-card__option-pill svg { width: 14px; height: 14px; }
  }
  .meal-plan-card__cta { display: inline-block; width: 100%; text-align: center; background-color: #fff !important; border: 2px solid var(--brand-accent,#2EBF7A) !important; color: var(--brand-accent,#2EBF7A) !important; border-radius: 8px; font-size: 1rem; font-weight: 700 !important; text-transform: uppercase !important; letter-spacing: .05em; cursor: pointer; padding: .85rem 1.5rem; transition: all .2s ease; }
  .meal-plan-card:hover .meal-plan-card__cta { background-color: var(--brand-accent,#2EBF7A) !important; color: #fff !important; }

  .mp-plan-card-badge { text-align: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #e9ecef; }
  .mp-plan-card-badge .mp-badge { display: inline-block; background: #d42828; color: #fff; font-size: .8rem; font-weight: 600; padding: .25rem .6rem; border-radius: 4px; }
  .mp-plan-card-badge .mp-sub { display: block; font-size: .8rem; color: #495057; margin-top: .35rem; }
</style>

<div class="meal-plan-grid-wrapper">
  <div class="container">
    <div class="meal-plan-grid">
      {%- for block in section.blocks -%}
        {%- liquid
          assign product = block.settings.plan_product
          assign promo_title = block.settings.promo_title | default: product.title
          assign hook_line = product.metafields.plan.hook_line
          assign who_for_list = product.metafields.plan.who_for_list.value
          assign has_hook = false
          if block.settings.show_hook_line and hook_line != blank
            assign has_hook = true
          endif
          assign has_benefits = false
          if block.settings.show_who_for_list and who_for_list.size > 0
            assign has_benefits = true
          endif
          assign watermark_icon = block.settings.watermark_icon
        -%}

        <div class="meal-plan-grid__item" {{ block.shopify_attributes }}>
          <a href="{{ product.url | default: '#' }}" class="meal-plan-card">
            <div
              class="meal-plan-card__promo-header"
              style="background: linear-gradient(65deg, {{ block.settings.gradient_start }}, {{ block.settings.gradient_end }});"
            >
              {%- if watermark_icon != 'none' and watermark_icon != blank -%}
                <div class="meal-plan-card__watermark-icon">
                  {%- case watermark_icon -%}
                    {%- when 'trophy' -%}
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12.87 22.5a.75.75 0 01-.74 0L6.5 20.36V15H5V9h1.5V6.5a5.25 5.25 0 0110.5 0V9H18.5v6H17v5.36l-5.63 2.14zM8 15h9v4.14l-4.5 1.71-4.5-1.71V15zm8-4.5V9H7.5v1.5H16zM15.5 8V6.5a3.75 3.75 0 00-7.5 0V8h7.5zM4 3h1.5v1.5H4V3zm15.5 0H21v1.5h-1.5V3z"></path></svg>
                    {%- when 'dumbbell' -%}
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M22.5 10.5h-3v3h-15v-3h-3v3h-1.5v-3H-1.5V10.5h3v-3h15v3h3v-3h1.5v3h3V10.5z"></path></svg>
                    {%- when 'leaf' -%}
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M22.5 13.5a10.5 10.5 0 01-18.78 6.44.75.75 0 01.96-1.15 9 9 0 0015.9-5.44c0-4-2.4-7.4-5.78-8.85a.75.75 0 01.5-1.42A10.5 10.5 0 0122.5 13.5z"></path><path d="M12.5 1.69a.75.75 0 011 1.32A9 9 0 0018 13.5a.75.75 0 01-1.5 0 7.5 7.5 0 01-4-11.02.75.75 0 01.5-1.3z"></path></svg>
                    {%- when 'flame' -%}
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16.4 4.14a9.75 9.75 0 00-11.42 1.83 3 3 0 01-1.03 4.88 9.75 9.75 0 0013.96 11.02 3 3 0 014.24-2.58 9.75 9.75 0 00-5.75-15.15z"></path></svg>
                  {%- endcase -%}
                </div>
              {%- endif -%}

              <div class="meal-plan-card__promo-text-wrapper">
                <h2 class="meal-plan-card__promo-title">{{ promo_title | escape }}</h2>
                {%- if has_hook -%}
                  <p class="meal-plan-card__promo-subtitle">{{ hook_line }}</p>
                {%- endif -%}
              </div>
            </div>

            <div class="meal-plan-card__content">
              {% if promo_active %}
                <div class="mp-plan-card-badge">
                  <span class="mp-badge">Save up to {{ max_savings_total | times: 100 | money_without_trailing_zeros }}</span>
                  <small class="mp-sub">Applied to first 4 boxes with Subscribe & Save.</small>
                </div>
              {% endif %}
              <div class="meal-plan-card__main-info">
                {%- if has_benefits -%}
                  <div class="meal-plan-card__benefits-block">
                    <ul class="meal-plan-card__benefits-list">
                      {%- for item in who_for_list limit: block.settings.who_for_limit -%}
                        <li class="meal-plan-card__benefit-item">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                          <span>{{ item }}</span>
                        </li>
                      {%- endfor -%}
                    </ul>
                  </div>
                {%- endif -%}
                <div class="meal-plan-card__description">
                  {{- block.settings.description | default: product.description -}}
                </div>
              </div>
              <div class="meal-plan-card__cta-wrapper">
                {%- if block.settings.show_options_bar -%}
                  <div class="meal-plan-card__options-bar">
                    {%- if block.settings.option_1_text != blank -%}
                      <div class="meal-plan-card__option-pill">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
                        <span>{{ block.settings.option_1_text }}</span>
                      </div>
                    {%- endif -%}
                    {%- if block.settings.option_2_text != blank -%}
                       <div class="meal-plan-card__option-pill">
                        <span>{{ block.settings.option_2_text }}</span>
                      </div>
                    {%- endif -%}
                  </div>
                {%- endif -%}
                <span class="meal-plan-card__cta">{{ block.settings.button_text | escape }}</span>
              </div>
            </div>
          </a>
        </div>
      {%- endfor -%}
    </div>
  </div>
</div>

{% schema %}
{
  "name": "Custom Meal Plan Grid",
  "class": "custom-meal-plan-section",
  "blocks": [
    {
      "type": "plan_card",
      "name": "Meal Plan Card",
      "settings": [
        { "type": "product", "id": "plan_product", "label": "Meal Plan Product" },
        { "type": "header", "content": "Promo Header Settings" },
        { "type": "text", "id": "promo_title", "label": "Promo Header Title", "info": "Leave blank to use the product's title." },
        { "type": "color", "id": "gradient_start", "label": "Gradient Start Color", "default": "#28a745" },
        { "type": "color", "id": "gradient_end", "label": "Gradient End Color", "default": "#20c997" },
        {
          "type": "select",
          "id": "watermark_icon",
          "label": "Promo Header Watermark Icon",
          "options": [
            { "value": "none", "label": "None" },
            { "value": "trophy", "label": "Trophy (ICON)" },
            { "value": "dumbbell", "label": "Dumbbell (Protein)" },
            { "value": "leaf", "label": "Leaf (Lean/Keto)" },
            { "value": "flame", "label": "Flame (Burn)" }
          ],
          "default": "none"
        },
        { "type": "header", "content": "Card Content Settings" },
        { "type": "checkbox", "id": "show_hook_line", "label": "Show 'Hook Line' as subtitle", "default": true },
        { "type": "checkbox", "id": "show_who_for_list", "label": "Show 'Who It's For' from metafield", "default": true },
        { "type": "range", "id": "who_for_limit", "min": 1, "max": 5, "step": 1, "label": "Max 'Who It's For' items to show", "default": 1 },
        { "type": "checkbox", "id": "show_options_bar", "label": "Show Purchase Options Bar", "default": true },
        { "type": "text", "id": "option_1_text", "label": "Option 1 Text (Meal Count)", "default": "12 or 24 Meals" },
        { "type": "text", "id": "option_2_text", "label": "Option 2 Text (Purchase Type)", "default": "One-Time or Subscribe" },
        { "type": "richtext", "id": "description", "label": "Description Override", "info": "Optional. Leave blank to use the selected product's description.", "default": "<p>Enjoy a high-fat, low-carb assortment of chef-crafted meals designed to keep you on track and fully satisfied.</p>" },
        { "type": "text", "id": "button_text", "label": "Button Text", "default": "View Plan" }
      ]
    }
  ],
  "presets": [
    { "name": "Custom Meal Plan Grid", "blocks": [{ "type": "plan_card" }, { "type": "plan_card" }] }
  ],
  "enabled_on": {
    "templates": ["*"]
  }
}
{% endschema %}