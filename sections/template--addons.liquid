{%- comment -%}
  ==============================================================================
  DYNAMIC ADD-ONS SECTION V2 - BOGO PROMO REFACTORED
  - The BOGO feature is now a primary, full-width banner above the grid.
  - Schema is updated to a single product picker for simplicity.
  ==============================================================================
{%- endcomment -%}

  {%- liquid
    # --- DYNAMIC PRODUCT LOGIC ---
    assign slot1_blocks = section.blocks | where: 'settings.placement', 'slot_1'
    assign slot2_blocks = section.blocks | where: 'settings.placement', 'slot_2'
    assign slot3_blocks = section.blocks | where: 'settings.placement', 'slot_3'

    # --- BLACK FRIDAY HERO PRODUCTS ---
    assign bf_product_1 = all_products[section.settings.bf_bundle_product_1]
    assign bf_product_2 = all_products[section.settings.bf_bundle_product_2]
    assign bf_product_3 = all_products[section.settings.bf_bundle_product_3]

    # Use the 'sample' filter to randomly pick ONE block from each group for A/B testing.
    # If a group is empty, the result will be blank.
    assign slot1_block = slot1_blocks | sample
    assign slot2_block = slot2_blocks | sample
    assign slot3_block = slot3_blocks | sample

    # --- BOGO PROMO PRODUCT ---
    assign bogo_product = section.settings.pp_bogo_product

    # --- FALLBACK PRODUCT DEFINITIONS ---
    # Define the original, hard-coded products that will be used if the
    # dynamic slots above are not configured.
    assign fallback_product_1 = all_products['cinnabun-krunch-protein-popcorn']
    assign fallback_product_2 = all_products['brisket-by-pound']
    assign fallback_product_3 = all_products['butter-herb']
    assign free_delivery_target = settings.free_delivery_threshold | default: 21
  -%}

<div class="addons-page-wrapper" data-free-delivery-target="{{ free_delivery_target }}">
  <div class="container">
    <style>
      .bf-addons-hero {
        --bf-hero-mobile-gutter: 18px;
        background: radial-gradient(circle at top left, rgba(255, 255, 255, 0.04), transparent 35%), #0c0c0f;
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 18px;
        padding: 32px 28px 36px;
        color: #f7f7f9;
        box-shadow: 0 16px 38px rgba(0, 0, 0, 0.35);
        margin-bottom: 36px;
        overflow: hidden;
        position: relative;
      }

      .bf-addons-hero__header {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .bf-addons-hero__heading-row {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 16px;
      }

      .bf-addons-hero__title {
        margin: 0;
        font-size: 32px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        font-weight: 800;
      }

      .bf-addons-hero__subheading {
        margin: 0;
        color: #d7d7dc;
        max-width: 880px;
        line-height: 1.5;
      }

      .bf-addons-hero__countdown {
        background: rgba(255, 76, 76, 0.08);
        border: 1px solid rgba(255, 76, 76, 0.35);
        color: #fff;
        border-radius: 12px;
        padding: 12px 14px;
        display: inline-flex;
        flex-direction: column;
        min-width: 210px;
        gap: 6px;
      }

      .bf-addons-hero__countdown-label {
        font-size: 12px;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: #ff8b8b;
      }

      .bf-addons-hero__countdown-value {
        font-size: 20px;
        font-weight: 800;
        letter-spacing: 0.08em;
      }

      .bf-addons-hero__countdown.is-expired .bf-addons-hero__countdown-value {
        color: #f7f7f9;
      }

      .bf-addons-hero__grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 18px;
        margin: 22px 0 18px;
      }

      .bf-bundle-card {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0));
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 14px;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        position: relative;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.32);
      }

      .bf-bundle-card__badge {
        position: absolute;
        top: 12px;
        right: 12px;
        background: linear-gradient(135deg, #ff4c4c, #d41b1b);
        color: #fff;
        padding: 6px 10px;
        font-size: 11px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        border-radius: 999px;
        box-shadow: 0 6px 16px rgba(212, 27, 27, 0.35);
      }

      .bf-bundle-card__image {
        width: 100%;
        height: 240px;
        border-radius: 12px;
        overflow: hidden;
        background: #0f0f14;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .bf-bundle-card__image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.35s ease;
      }

      .bf-bundle-card:hover .bf-bundle-card__image img {
        transform: scale(1.04);
      }

      .bf-bundle-card__title {
        font-size: 18px;
        margin: 0;
        font-weight: 800;
      }

      .bf-bundle-card__tagline {
        margin: 0;
        color: #d2d2d7;
        font-size: 14px;
      }

      .bf-bundle-card__price-row {
        display: flex;
        align-items: baseline;
        gap: 8px;
        font-weight: 800;
        color: #fff;
      }

      .bf-bundle-card__price-row .price--sale {
        color: #ff4c4c;
        font-size: 18px;
      }

      .bf-bundle-card__price-row .price--compare {
        color: #8e8e95;
        text-decoration: line-through;
        font-size: 14px;
      }

      .bf-bundle-card__form {
        margin-top: auto;
      }

      .bf-bundle-card__add-btn {
        width: 100%;
        background: linear-gradient(135deg, #ff4c4c, #c81919);
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 12px 16px;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        text-decoration: none !important;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-family: inherit;
        transition: transform 0.18s ease, box-shadow 0.18s ease, opacity 0.18s ease;
      }

      .bf-bundle-card__add-btn:link,
      .bf-bundle-card__add-btn:visited {
        color: #fff;
      }

      .bf-bundle-card__add-btn:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 10px 20px rgba(255, 76, 76, 0.3);
      }

      .bf-bundle-card__add-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        box-shadow: none;
      }

      .bf-addons-hero__cta-row {
        display: flex;
        justify-content: flex-end;
        margin-top: 8px;
      }

      .bf-addons-hero__cta {
        background: transparent;
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.35);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-weight: 800;
        padding: 12px 22px;
        border-radius: 12px;
        transition: background 0.18s ease, color 0.18s ease, border-color 0.18s ease;
      }

      .bf-addons-hero__cta:hover {
        background: #ff4c4c;
        border-color: #ff4c4c;
        color: #fff;
      }

      @media (max-width: 991px) {
        .bf-addons-hero__grid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .bf-addons-hero__title {
          font-size: 28px;
        }
      }

      @media (max-width: 640px) {
        .addons-page-wrapper > .container {
          padding-left: 0;
          padding-right: 0;
        }

        .bf-addons-hero {
          padding: 26px var(--bf-hero-mobile-gutter) 30px;
          margin-left: 0;
          margin-right: 0;
          width: 100%;
          border-radius: 0;
          box-shadow: 0 24px 48px rgba(0, 0, 0, 0.42);
        }

        .bf-addons-hero__grid {
          grid-template-columns: 1fr;
          gap: 14px;
        }

        .bf-addons-hero__heading-row {
          flex-direction: column;
          align-items: flex-start;
          gap: 12px;
        }

        .bf-addons-hero__title {
          font-size: 26px;
          letter-spacing: 0.06em;
        }

        .bf-addons-hero__subheading {
          font-size: 15px;
          line-height: 1.6;
        }

        .bf-addons-hero__countdown {
          width: 100%;
          min-width: auto;
        }

        .bf-addons-hero__cta-row {
          justify-content: center;
          margin-top: 16px;
        }

        .bf-bundle-card__image {
          height: 210px;
        }
      }
    </style>
    <div class="bf-addons-hero">
      <div class="bf-addons-hero__header">
        <div class="bf-addons-hero__heading-row">
          <h2 class="bf-addons-hero__title">{{ section.settings.bf_heading | escape }}</h2>
          <div class="bf-addons-hero__countdown" data-bf-countdown data-end-date="{{ section.settings.bf_countdown_end_date }}" data-expired-text="{{ section.settings.bf_expired_label | escape }}">
            <span class="bf-addons-hero__countdown-label" data-countdown-label>{{ section.settings.bf_countdown_label | escape }}</span>
            <span class="bf-addons-hero__countdown-value" data-countdown-time></span>
          </div>
        </div>
      <p class="bf-addons-hero__subheading">{{ section.settings.bf_subheading }}</p>
    </div>

    <div class="bf-addons-hero__grid">
        {% if bf_product_1 %}
          {% render 'bf-bundle-card', product_obj: bf_product_1, card_id: 'bf-1', tagline: section.settings.bf_bundle_tagline_1, slot: 'bf-1', cta_type: section.settings.bf_bundle_cta_type_1, cta_text: section.settings.bf_bundle_cta_text_1 %}
        {% endif %}
        {% if bf_product_2 %}
          {% render 'bf-bundle-card', product_obj: bf_product_2, card_id: 'bf-2', tagline: section.settings.bf_bundle_tagline_2, slot: 'bf-2', cta_type: section.settings.bf_bundle_cta_type_2, cta_text: section.settings.bf_bundle_cta_text_2 %}
        {% endif %}
        {% if bf_product_3 %}
          {% render 'bf-bundle-card', product_obj: bf_product_3, card_id: 'bf-3', tagline: section.settings.bf_bundle_tagline_3, slot: 'bf-3', cta_type: section.settings.bf_bundle_cta_type_3, cta_text: section.settings.bf_bundle_cta_text_3 %}
        {% endif %}
      </div>

      <div class="bf-addons-hero__cta-row">
        <a class="btn bf-addons-hero__cta" href="/checkout" data-checkout-url>{{ section.settings.bf_cta_text | escape }}</a>
      </div>
    </div>

    {%- comment -%}
      WORLD-CLASS UX REVISION V15: Final version with color changes removed.
    {%- endcomment -%}
    
    {%- comment -%} RENDER THE BOGO PROMO BANNER (Now sits above the grid) {%- endcomment -%}
    {% render 'addons-pp-bogo', section: section, bogo_product: bogo_product %}

{% if settings.enable_free_delivery_promo %}
      <div class="free-shipping-upsell hidden" data-double-up-upsell data-locked-template="{{ settings.free_delivery_locked_message }}">
      
      {%- comment -%} Initial state of the banner (the offer) {%- endcomment -%}
      <div class="free-shipping-upsell__inner">
        <div class="upsell__content">
          <div class="upsell__icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-truck"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>
          </div>
          <div class="upsell__text-wrapper">
            <div class="upsell__header">
                <h3 class="upsell__title" data-upsell-title>{{ settings.free_delivery_locked_message }}</h3>
            </div>
            
            <div class="upsell__progress" aria-hidden="true">
              <div class="upsell__progress-fill" style="width:0%"></div>
            </div>

            <p class="upsell__description" data-upsell-description>
              <span class="upsell-copy--desktop"></span>
              <span class="upsell-copy--mobile"></span>
            </p>
          </div>
        </div>
        <div class="upsell__action">
          <button type="button" class="btn upsell__cta" data-upsell-button>
            Yes, Add Meals & Save
          </button>
          <p class="upsell__clarification">This will automatically update your cart.</p>
        </div>
      </div>

      {%- comment -%} Success state of the banner (post-click) {%- endcomment -%}
      <div class="upsell__success-state">
          <div class="upsell__success-icon">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
          </div>
          <div class="upsell__text-wrapper">
              <h3 class="upsell__title">{{ settings.free_delivery_unlocked_message }}</h3>
              <p class="upsell__description">{% if settings.free_delivery_discount_code != blank %}Use code {{ settings.free_delivery_discount_code }} at checkout.{% endif %}</p>
          </div>
      </div>
    </div>
    {% endif %}


    <div class="addons-grid">
      {%- comment -%} CARD FOR SLOT 1 {%- endcomment -%}
      {%- if slot1_block and slot1_block.settings.product != blank -%}
        {% render 'addons-card', product_obj: slot1_block.settings.product, card_id: 'slot-1', collection_handle: slot1_block.settings.collection_handle, card_description_points: slot1_block.settings.card_description_points, slot: 'slot-1', cta_type: slot1_block.settings.cta_type, cta_text: slot1_block.settings.cta_text %}
      {%- elsif fallback_product_1 != blank -%}
        {% render 'addons-card', product_obj: fallback_product_1, card_id: 'slot-1', collection_handle: 'proteinpopcorn', card_description_points: "10g protein per serving|Sweet cinnamon-roll crunch without the guilt|Resealable bag for easy, on-the-go snacking", slot: 'slot-1', cta_type: 'add_to_cart' %}
      {%- endif -%}

      {%- comment -%} CARD FOR SLOT 2 {%- endcomment -%}
      {%- if slot2_block and slot2_block.settings.product != blank -%}
        {% render 'addons-card', product_obj: slot2_block.settings.product, card_id: 'slot-2', collection_handle: slot2_block.settings.collection_handle, card_description_points: slot2_block.settings.card_description_points, slot: 'slot-2', cta_type: slot2_block.settings.cta_type, cta_text: slot2_block.settings.cta_text %}
      {%- elsif fallback_product_2 != blank -%}
        {% render 'addons-card', product_obj: fallback_product_2, card_id: 'slot-2', collection_handle: 'bulk-items', card_description_points: "37g protein per 4oz (16oz total)|Slow smoked 12 hours for real BBQ flavor|Fully cooked, microwave ready in 2 min", slot: 'slot-2', cta_type: 'add_to_cart' %}
      {%- endif -%}

      {%- comment -%} CARD FOR SLOT 3 {%- endcomment -%}
      {%- if slot3_block and slot3_block.settings.product != blank -%}
        {% render 'addons-card', product_obj: slot3_block.settings.product, card_id: 'slot-3', collection_handle: slot3_block.settings.collection_handle, card_description_points: slot3_block.settings.card_description_points, slot: 'slot-3', cta_type: slot3_block.settings.cta_type, cta_text: slot3_block.settings.cta_text %}
      {%- elsif fallback_product_3 != blank -%}
        {% render 'addons-card', product_obj: fallback_product_3, card_id: 'slot-3', collection_handle: 'seasonings', card_description_points: "Zero calories and carbs|Rich butter taste with garden herbs|Clean ingredients, low sodium", slot: 'slot-3', cta_type: 'add_to_cart' %}
      {%- endif -%}
    </div>

    <div class="addons-page__actions">
      <a href="/checkout" class="addons-page__skip-link" data-checkout-url>
        Continue to checkout
      </a>
    </div>
  </div>
 </div>

{% if settings.enable_free_delivery_promo %}
<script src="{{ 'addons-double-up.js' | asset_url }}" defer></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    
    function updateCheckoutLinks() {
      try {
        const discountCode = sessionStorage.getItem('deferred_discount');
        const checkoutLinks = document.querySelectorAll('[data-checkout-url]');
        
        let checkoutUrl = '/checkout';
        if (discountCode) {
          checkoutUrl = `/checkout?discount=${discountCode}`;
        }

        checkoutLinks.forEach(link => {
          link.href = checkoutUrl;
        });

      } catch (e) {
        console.warn('Could not update checkout links:', e);
      }
    }

    const addonsGrid = document.querySelector('.addons-grid');
    if (addonsGrid) {
      addonsGrid.addEventListener('click', function(event) {
        const plusButton = event.target.closest('.qty-plus');
        const minusButton = event.target.closest('.qty-minus');
        if (!plusButton && !minusButton) return;
        const controls = event.target.closest('.quantity-controls');
        const input = controls.querySelector('.quantity-selector');
        const currentValue = parseInt(input.value, 10);
        const minValue = parseInt(input.min, 10) || 1;
        if (plusButton) {
          input.value = currentValue + 1;
        }
        if (minusButton) {
          if (currentValue > minValue) {
            input.value = currentValue - 1;
          }
        }
      });
    }

    const addonForms = document.querySelectorAll('.js-addons-form');
    window.dataLayer = window.dataLayer || [];

    addonForms.forEach(function(form) {
      window.dataLayer.push({
        event: 'addon_product_view',
        slot: form.dataset.slot,
        product_handle: form.dataset.productHandle
      });

      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        const button = form.querySelector('.js-add-to-cart-btn');
        const buttonTextSpan = button ? button.querySelector('span') : null;

        if (button && buttonTextSpan && !button.dataset.originalText) {
          button.dataset.originalText = buttonTextSpan.textContent.trim();
        }

        if (button) {
          button.disabled = true;
          button.classList.add('is-loading');
        }

        try {
          const fetchResult = await window.fetch('/cart/add.js', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            body: new FormData(form)
          });

          if (fetchResult.ok) {
            const cart = await (await fetch('/cart.js')).json();
            document.dispatchEvent(new CustomEvent('cart:updated', { detail: { cart } }));

            window.dataLayer.push({
              event: 'addon_product_added',
              slot: form.dataset.slot,
              product_handle: form.dataset.productHandle
            });

            if (button) {
              button.classList.remove('is-loading');
              button.classList.add('is-added');
              if (buttonTextSpan) {
                buttonTextSpan.textContent = 'Added!';
              }
              setTimeout(function() {
                button.classList.remove('is-added');
                button.disabled = false;
                if (buttonTextSpan) {
                  const originalText = button.dataset.originalText || 'Add to Cart';
                  buttonTextSpan.textContent = originalText;
                }
              }, 1500);
            }
          } else {
            console.error('Add to cart failed');
            if (button) {
              button.classList.remove('is-loading');
              button.disabled = false;
              if (buttonTextSpan) {
                const originalText = button.dataset.originalText || 'Add to Cart';
                buttonTextSpan.textContent = originalText;
              }
            }
          }
        } catch (error) {
          console.error('Error adding addon product:', error);
          if (button) {
            button.classList.remove('is-loading');
            button.disabled = false;
            if (buttonTextSpan) {
              const originalText = button.dataset.originalText || 'Add to Cart';
              buttonTextSpan.textContent = originalText;
            }
          }
        }
      });
    });

    function ensureCheckoutArrow() {
        const actions = document.querySelector('.collection-header-section-v8__actions');
        if (!actions) return;
        const existingArrow = actions.querySelector('.collection-header-section-v8__checkout-arrow-link');
        
        if (existingArrow && !existingArrow.hasAttribute('data-checkout-url')) {
          existingArrow.setAttribute('data-checkout-url', '');
        }
        
        if (!existingArrow) {
            const arrow = document.createElement('button');
            arrow.type = 'button';
            arrow.className = 'collection-header-section-v8__checkout-arrow-link';
            arrow.setAttribute('aria-label', 'Proceed to Checkout');
            arrow.setAttribute('data-checkout-url', '');
            arrow.innerHTML = '<span class="collection-header-section-v8__action-text">Continue</span><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>';
            
            arrow.addEventListener('click', () => {
              window.location.href = arrow.href || '/checkout';
            });

            actions.querySelectorAll('.collection-header-section-v8__cart-button').forEach(btn => btn.remove());
            actions.appendChild(arrow);
        }
        updateCheckoutLinks();
    }

    ensureCheckoutArrow();
    
    document.addEventListener('cart:updated', function() { 
      setTimeout(() => {
        ensureCheckoutArrow();
        updateCheckoutLinks();
      }, 250); 
    });

    var headerSection = document.getElementById('shopify-section-header-collections');
    if (headerSection && window.MutationObserver) {
        var observer = new MutationObserver(function() { 
          ensureCheckoutArrow();
          updateCheckoutLinks();
        });
        observer.observe(headerSection, { childList: true, subtree: true });
    }
  });
</script>
{% endif %}

{% if settings.enable_free_delivery_promo %}
<script>
  /**
   * Free Shipping Upsell Conversion Enhancements V10.0 - Final, No Color Change
   * - Implements the final, user-approved copy for all text elements.
   * - Correctly fills the progress bar based on meals IN cart.
   * - Urgency is now shown only via icon animation, not color changes.
   * - Uses a safe, timeout-based initialization.
   */
  document.addEventListener('DOMContentLoaded', () => {
    const pageWrapper = document.querySelector('.addons-page-wrapper');
    const upsellWrapper = document.querySelector('.free-shipping-upsell');
    
    if (!pageWrapper || !upsellWrapper) return;

    const titleEl = upsellWrapper.querySelector('[data-upsell-title]');
    const ctaButton = upsellWrapper.querySelector('[data-upsell-button]');
    const descriptionEl = upsellWrapper.querySelector('[data-upsell-description]');
    const clarifierEl = upsellWrapper.querySelector('.upsell__clarification');
    const progressFill = upsellWrapper.querySelector('.upsell__progress-fill');
    const iconWrapper = upsellWrapper.querySelector('.upsell__icon');
    
    const descDesktopSpan = upsellWrapper.querySelector('.upsell-copy--desktop');
    const descMobileSpan = upsellWrapper.querySelector('.upsell-copy--mobile');

    if (!titleEl || !ctaButton || !descriptionEl || !progressFill || !iconWrapper || !clarifierEl || !descDesktopSpan || !descMobileSpan) {
      console.warn('Upsell banner element(s) missing. Enhancements disabled.');
      return;
    }

    function enhanceUpsellBanner() {
      const target = parseInt(pageWrapper.dataset.freeDeliveryTarget, 10) || 21;
      const digitRegex = /\d+/;
      let mealsAway = null;

      const descriptionText = descriptionEl.textContent || '';
      const descriptionMatch = descriptionText.match(digitRegex);
      if (descriptionMatch) {
        mealsAway = parseInt(descriptionMatch[0], 10);
      }

      if (mealsAway === null) {
        return; 
      }

      // 1. Correct "Fill-Up" Progress Logic
      const currentMeals = target - mealsAway;
      const progressPercentage = Math.max(0, Math.min(100, (currentMeals / target) * 100));
      progressFill.style.width = `${progressPercentage}%`;

      // 2. Targeted Urgency Animation (No Color Change)
      iconWrapper.classList.remove('has-animation');
      if (mealsAway > 0 && mealsAway <= 3) {
        iconWrapper.classList.add('has-animation');
      }
      
      // 3. Final Dynamic Text Logic
      const pluralS = mealsAway === 1 ? '' : 's';
      const commonDescFragment = `we’ll add ${mealsAway} more by evenly increasing your current meal quantities so your total hits ${target}.`;

      const lockedTemplate = upsellWrapper.dataset.lockedTemplate || '';
      titleEl.textContent = lockedTemplate.replace('{remaining}', mealsAway);
      descDesktopSpan.textContent = `Click the button and ${commonDescFragment}`;
      descMobileSpan.textContent = `Click below and ${commonDescFragment}`;
      ctaButton.textContent = `Yes, Add ${mealsAway} Meal${pluralS}`;
      clarifierEl.textContent = 'We’ll make the changes for you now.';
    }

    // SAFE INITIALIZATION
    document.addEventListener('cart:updated', enhanceUpsellBanner);
    setTimeout(enhanceUpsellBanner, 100);
    setTimeout(enhanceUpsellBanner, 300);
  });
</script>
{% endif %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const countdown = document.querySelector('[data-bf-countdown]');
    if (!countdown) return;

    const endDateString = countdown.dataset.endDate;
    const expiredLabel = countdown.dataset.expiredText || '';
    const timeEl = countdown.querySelector('[data-countdown-time]');
    const labelEl = countdown.querySelector('[data-countdown-label]');

    function pad(value) {
      return value.toString().padStart(2, '0');
    }

    function parseEndDate() {
      if (!endDateString) return null;
      const normalized = endDateString.replace(' ', 'T');
      const date = new Date(normalized);
      return isNaN(date.getTime()) ? null : date;
    }

    const endDate = parseEndDate();

    function setExpiredState() {
      countdown.classList.add('is-expired');
      if (labelEl) {
        labelEl.textContent = expiredLabel;
      }
      if (timeEl) {
        timeEl.textContent = '';
      }
    }

    function renderCountdown() {
      if (!endDate) {
        setExpiredState();
        return false;
      }

      const now = new Date();
      const diff = endDate.getTime() - now.getTime();

      if (diff <= 0) {
        setExpiredState();
        return false;
      }

      const seconds = Math.floor(diff / 1000);
      const days = Math.floor(seconds / 86400);
      const hours = Math.floor((seconds % 86400) / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const remainingSeconds = seconds % 60;

      if (timeEl) {
        timeEl.textContent = `${pad(days)}d : ${pad(hours)}h : ${pad(minutes)}m : ${pad(remainingSeconds)}s`;
      }
      return true;
    }

    renderCountdown();
    const intervalId = setInterval(function() {
      const active = renderCountdown();
      if (!active) {
        clearInterval(intervalId);
      }
    }, 1000);
  });
</script>
<script src="{{ 'addons-popcorn-bogo.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "Add-Ons Page Section",
  "settings": [
    {
      "type": "header",
      "content": "Black Friday Hero"
    },
    {
      "type": "text",
      "id": "bf_heading",
      "label": "Heading",
      "default": "Black Friday Add-On Bundles"
    },
    {
      "type": "text",
      "id": "bf_subheading",
      "label": "Subheading",
      "default": "Stock up on coffee, seasonings, and popcorn before you check out. These bundles are priced lower than our standard 30% off."
    },
    {
      "type": "text",
      "id": "bf_countdown_label",
      "label": "Countdown Label",
      "default": "Black Friday Ends In"
    },
    {
      "type": "text",
      "id": "bf_expired_label",
      "label": "Expired Label",
      "default": "Black Friday Sale Ending – Prices Subject to Change"
    },
    {
      "type": "text",
      "id": "bf_countdown_end_date",
      "label": "Countdown End Date/Time",
      "info": "Format: YYYY-MM-DD HH:MM:SS (24-hour). Example: 2024-11-29 23:59:59"
    },
    {
      "type": "product",
      "id": "bf_bundle_product_1",
      "label": "Bundle Product 1"
    },
    {
      "type": "select",
      "id": "bf_bundle_cta_type_1",
      "label": "Bundle 1 CTA Type",
      "options": [
        { "value": "add_to_cart", "label": "Add to Cart" },
        { "value": "link_to_product", "label": "Link to Product" }
      ],
      "default": "add_to_cart"
    },
    {
      "type": "text",
      "id": "bf_bundle_cta_text_1",
      "label": "Bundle 1 CTA Text (Optional)",
      "info": "Overrides the default text for the selected CTA type."
    },
    {
      "type": "text",
      "id": "bf_bundle_tagline_1",
      "label": "Bundle 1 Tagline",
      "default": "Buy 2, Get 1 Free • Morning fuel, ready to go."
    },
    {
      "type": "product",
      "id": "bf_bundle_product_2",
      "label": "Bundle Product 2"
    },
    {
      "type": "select",
      "id": "bf_bundle_cta_type_2",
      "label": "Bundle 2 CTA Type",
      "options": [
        { "value": "add_to_cart", "label": "Add to Cart" },
        { "value": "link_to_product", "label": "Link to Product" }
      ],
      "default": "add_to_cart"
    },
    {
      "type": "text",
      "id": "bf_bundle_cta_text_2",
      "label": "Bundle 2 CTA Text (Optional)",
      "info": "Overrides the default text for the selected CTA type."
    },
    {
      "type": "text",
      "id": "bf_bundle_tagline_2",
      "label": "Bundle 2 Tagline",
      "default": "Any 2 for $12 • Perfect movie-night add-on."
    },
    {
      "type": "product",
      "id": "bf_bundle_product_3",
      "label": "Bundle Product 3"
    },
    {
      "type": "select",
      "id": "bf_bundle_cta_type_3",
      "label": "Bundle 3 CTA Type",
      "options": [
        { "value": "add_to_cart", "label": "Add to Cart" },
        { "value": "link_to_product", "label": "Link to Product" }
      ],
      "default": "add_to_cart"
    },
    {
      "type": "text",
      "id": "bf_bundle_cta_text_3",
      "label": "Bundle 3 CTA Text (Optional)",
      "info": "Overrides the default text for the selected CTA type."
    },
    {
      "type": "text",
      "id": "bf_bundle_tagline_3",
      "label": "Bundle 3 Tagline",
      "default": "Any 4 for $25 • Season every meal like a pro."
    },
    {
      "type": "text",
      "id": "bf_cta_text",
      "label": "Checkout CTA Text",
      "default": "Continue to Checkout"
    },
    {
      "type": "header",
      "content": "BOGO Popcorn Promo"
    },
    {
      "type": "checkbox",
      "id": "enable_pp_bogo",
      "label": "Enable BOGO Promo Banner",
      "default": false
    },
    {
      "type": "product",
      "id": "pp_bogo_product",
      "label": "BOGO Product (The 'Buy One')",
      "info": "The main product displayed in the banner that the user adds to their cart."
    },
    {
      "type": "product",
      "id": "pp_bogo_gift_product",
      "label": "Free Gift Product (The 'Get One')",
      "info": "The FREE ($0) product that is automatically added to the cart."
    },
    {
      "type": "header",
      "content": "Banner Content"
    },
    {
      "type": "text",
      "id": "pp_bogo_headline",
      "label": "Promo Headline",
      "default": "GET A FREE SAVORY STARTER PACK!"
    },
    {
      "type": "text",
      "id": "pp_bogo_countdown_end_date",
      "label": "Countdown End Date",
      "info": "Format: YYYY-MM-DD HH:MM:SS. Example: 2024-08-27 23:59:59"
    },
    {
      "type": "textarea",
      "id": "pp_bogo_flavors",
      "label": "Flavors in Pack",
      "info": "List each flavor included, separated by a pipe character (|). Example: Cheddar Cheese|Movie Time|Salsa Cheddar"
    },
    {
      "type": "textarea",
      "id": "pp_bogo_benefits",
      "label": "Benefit List",
      "default": "10g Protein Per Bag",
      "info": "List each benefit, separated by a pipe character (|)."
    }
  ],
  "max_blocks": 50,
  "blocks": [
    {
      "type": "addon_product",
      "name": "Add-on Product",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        },
        {
          "type": "select",
          "id": "placement",
          "label": "Placement Slot",
          "options": [
            { "value": "slot_1", "label": "Slot 1 (Left)" },
            { "value": "slot_2", "label": "Slot 2 (Middle)" },
            { "value": "slot_3", "label": "Slot 3 (Right)" }
          ],
          "default": "slot_1"
        },
        {
          "type": "text",
          "id": "collection_handle",
          "label": "Collection Handle (Optional)"
        },
        {
          "type": "select",
          "id": "cta_type",
          "label": "CTA Type",
          "options": [
            { "value": "add_to_cart", "label": "Add to Cart" },
            { "value": "link_to_product", "label": "Link to Product" }
          ],
          "default": "add_to_cart"
        },
        {
          "type": "text",
          "id": "cta_text",
          "label": "CTA Text (Optional)",
          "info": "Overrides the default text for the selected CTA type."
        },
        {
          "type": "textarea",
          "id": "card_description_points",
          "label": "Benefit Points",
          "info": "Separate points with a pipe character (|)."
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Add-Ons Page Section"
    }
  ]
}
{% endschema %}