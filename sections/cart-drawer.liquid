{%- comment -%}
  Cart Drawer - Dual Logic V1.2
  - FIXED: Restored the necessary div structure within the footer to ensure theme JavaScript compatibility,
    preventing components from disappearing.
  - RETAINED: Clear before/after pricing, discount lines, and a savings summary in the cart footer.
{%- endcomment -%}

{%- liquid
  if settings.enable_free_delivery_promo
    assign free_delivery_target = settings.free_delivery_threshold | default: 21
    assign meal_target = 8
    assign progress_current = 0
    assign excluded_collections = 'proteinpopcorn,butters,proteincoffee,seasonings' | split: ','
    for progress_item in cart.items
      assign item_collections = progress_item.product.collections | map: 'handle'
      assign is_excluded = false
      for excluded in excluded_collections
        if item_collections contains excluded
          assign is_excluded = true
          break
        endif
      endfor
      assign product_type_lower = progress_item.product.type | downcase
      if product_type_lower contains 'meal plan' or progress_item.product.handle contains 'meal-plan' or progress_item.product.type == 'OPTIONS_HIDDEN_PRODUCT'
        assign is_excluded = true
      endif
      unless is_excluded
        assign item_multiplier = 1
        if progress_item.variant.title contains 'Meal'
          assign potential = progress_item.variant.title | split: ' ' | first | times: 1
          if potential > 0
            assign item_multiplier = potential
          endif
        endif
        assign item_meals = progress_item.quantity | times: item_multiplier
        assign progress_current = progress_current | plus: item_meals
      endunless
    endfor
    if progress_current < meal_target
      assign remaining_meals = meal_target | minus: progress_current
      if remaining_meals < 0
        assign remaining_meals = 0
      endif
      assign progress_percentage = progress_current | times: 100.0 | divided_by: meal_target
      assign progress_target = meal_target
      capture progress_message
        echo "Add " | append: remaining_meals | append: " more meals to checkout."
      endcapture
      assign checkout_url = '/pages/add-ons'
    else
      assign remaining_free_delivery = free_delivery_target | minus: progress_current
      if remaining_free_delivery < 0
        assign remaining_free_delivery = 0
      endif
      assign progress_percentage = progress_current | times: 100.0 | divided_by: free_delivery_target
      assign progress_target = free_delivery_target
      if progress_current >= free_delivery_target and settings.free_delivery_discount_code != blank
        assign checkout_url = '/pages/add-ons?discount=' | append: settings.free_delivery_discount_code
      else
        assign checkout_url = '/pages/add-ons'
      endif
      capture progress_message
        if progress_current >= free_delivery_target
          echo settings.free_delivery_unlocked_message
          if settings.free_delivery_discount_code != blank
            echo " Use code " | append: settings.free_delivery_discount_code | append: " at checkout."
          endif
        else
          echo settings.free_delivery_locked_message | replace: '{remaining}', remaining_free_delivery
        endif
      endcapture
    endif
  else
    assign meal_target = 8
    assign progress_current = 0
    assign non_meal_types = 'peanut butter,protein popcorn,seasoning,beverage,options_hidden_product' | split: ','
    for progress_item in cart.items
      assign product_type_lower = progress_item.product.type | downcase
      if non_meal_types contains product_type_lower
        continue
      endif
      assign item_multiplier = 1
      if progress_item.variant.title contains 'Meal'
        assign potential = progress_item.variant.title | split: ' ' | first | times: 1
        if potential > 0
          assign item_multiplier = potential
        endif
      endif
      assign item_meals = progress_item.quantity | times: item_multiplier
      assign progress_current = progress_current | plus: item_meals
    endfor
    assign remaining_meals = meal_target | minus: progress_current
    if remaining_meals < 0
      assign remaining_meals = 0
    endif
    assign progress_percentage = progress_current | times: 100.0 | divided_by: meal_target
    assign progress_target = meal_target

    if progress_current >= meal_target
      assign progress_message = "Great! You have enough meals to checkout."
    else
      assign progress_message = "Add " | append: remaining_meals | append: " more meals to checkout."
    endif
    assign checkout_url = '/pages/add-ons'
  endif

  if progress_percentage > 100
    assign progress_percentage = 100
  endif
-%}
<style>
  .cart-drawer__summary-wrapper {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #e9ecef;
  }
  .cart-drawer__subtotal, .cart-drawer__discount-line, .cart-drawer__savings-summary {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9rem;
  }
  .cart-drawer__subtotal-label, .cart-drawer__discount-label, .cart-drawer__savings-label {
    color: #495057;
  }
  .cart-drawer__subtotal-price, .cart-drawer__discount-amount {
    font-weight: 600;
  }
  .cart-drawer__subtotal-price del {
    color: #6c757d;
    font-weight: 400;
    margin-right: 8px;
  }
  .cart-drawer__discount-amount, .cart-drawer__savings-amount {
    color: #28a745;
  }
  .cart-drawer__savings-summary {
    font-weight: 700;
    font-size: 1rem;
    margin-top: 4px;
    padding-top: 8px;
    border-top: 1px dashed #ced4da;
  }
</style>

<script class="cartFlagX"></script><aside id="cartSlideoutAside">
  <form action="{{ routes.cart_url }}" method="post" novalidate class="cart-drawer-form">
    <div id="cartSlideoutWrapper" class="cart-drawer fresh-shopping-right slideout-panel-hidden cart-drawer-right" role="dialog" aria-labelledby="cart_dialog_label" aria-modal="true">
      <div class="cart-drawer__content-host">
        <div class="cart-drawer__header">
          <div class="cart-drawer__title-bar">
            <h2 class="cart-drawer__title" id="cart_dialog_label">{{ 'cart.general.title' | t }}</h2>
            <button class="cart-drawer__close-btn alt-focus" aria-label="{{ 'cart.general.close_cart' | t }}" type="button">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
          </div>
          
          {%- if cart.item_count > 0 -%}
            <div class="cart-progress cart-progress--green">
              <p class="cart-progress__text" aria-live="polite">{{ progress_message | strip }}</p>
              <div class="cart-progress__bar" role="progressbar" aria-label="Meal progress toward order minimum" aria-valuenow="{{ progress_current }}" aria-valuemin="0" aria-valuemax="{{ progress_target }}" aria-valuetext="{{ progress_current }} of {{ progress_target }} meals">
                <div class="cart-progress__bar-inner" style="width: {{ progress_percentage }}%;"></div>
              </div>
            </div>
          {%- endif -%}
        </div>

        <div class="cart-drawer__body">
          {% render 'cart-item-list', context: 'drawer' %}
          <div class="cart-error-box"></div>
          <div class="cart-drawer__footer">
            {%- if cart.item_count > 0 -%}
              <div class="cart-drawer__summary">
                <div class="cart-drawer__summary-wrapper">
                  {%- if cart.total_discount > 0 -%}
                    {%- for discount in cart.cart_level_discounts -%}
                      <div class="cart-drawer__discount-line">
                        <span class="cart-drawer__discount-label">
                          <svg aria-hidden="true" focusable="false" role="presentation" style="width: 12px; height: 12px; vertical-align: middle; margin-right: 4px;" viewBox="0 0 12 12"><path fill-rule="evenodd" clip-rule="evenodd" d="M7 0h3a2 2 0 012 2v3a1 1 0 01-.29.71l-4 4a1 1 0 01-1.42 0l-3-3a1 1 0 010-1.42l4-4A1 1 0 017 0zm2 2a1 1 0 100 2 1 1 0 000-2z" fill="currentColor"></path></svg>
                          {{ discount.title }}
                        </span>
                        <span class="cart-drawer__discount-amount money">-{{ discount.total_allocated_amount | money }}</span>
                      </div>
                    {%- endfor -%}

                    <div class="cart-drawer__subtotal">
                      <span class="cart-drawer__subtotal-label">{{ 'cart.general.subtotal' | t }}</span>
                      <span class="cart-drawer__subtotal-price" id="cart_drawer_subtotal">
                        <del class="money">{{ cart.original_total_price | money }}</del>
                        <span class="money"><span style="display:none" class="tdf-cart-total-flag"></span>{{ cart.total_price | money }}</span>
                      </span>
                    </div>
                    
                    <div class="cart-drawer__savings-summary">
                      <span class="cart-drawer__savings-label">You saved</span>
                      <span class="cart-drawer__savings-amount money">{{ cart.total_discount | money }}</span>
                    </div>
                  {%- else -%}
                    <div class="cart-drawer__subtotal">
                      <span class="cart-drawer__subtotal-label">{{ 'cart.general.subtotal' | t }}</span>
                      <span class="cart-drawer__subtotal-price" id="cart_drawer_subtotal">
                        <span class="money"><span style="display:none" class="tdf-cart-total-flag"></span>{{ cart.total_price | money }}</span>
                      </span>
                    </div>
                  {%- endif -%}
                </div>
                {% comment %} This div is restored for JS compatibility {% endcomment %}
                <div class="cart-drawer__discounts cart--order-discount-wrapper custom-font ajax-cart-discount-wrapper" style="display: none;"></div>
              </div>
              <a href="{{ routes.cart_url }}" class="cart-drawer__view-cart-link">View Cart</a>
              {%- capture taxes_shipping_checkout -%}
                {%- if cart.taxes_included and shop.shipping_policy.body != blank -%}
                  {{ 'cart.general.taxes_included_and_shipping_policy_html' | t: link:shop.shipping_policy.url }}
                {%- elsif cart.taxes_included -%}
                  {{ 'cart.general.taxes_included_but_shipping_at_checkout' | t }}
                {%- elsif shop.shipping_policy.body != blank -%}
                  {{ 'cart.general.taxes_and_shipping_policy_at_checkout_html' | t: link:shop.shipping_policy.url }}
                {%- else -%}
                  {{ 'cart.general.taxes_and_shipping_at_checkout' | t }}
                {%- endif -%}
              {%- endcapture -%}
              <p class="cart-drawer__subtext">{{ taxes_shipping_checkout }}</p>
              <div class="cart-drawer__actions">
                <button type="button" class="btn cart-drawer__checkout-btn alt-focus" data-checkout-url="{{ checkout_url }}">
                  <span class="cart-button-checkout-text">Proceed to Checkout</span>
                  <span class="cart-button-checkout-spinner lds-dual-ring hide"></span>
                </button>
                {% if additional_checkout_buttons and settings.enable-additional-checkout-buttons %}
                  <div class="additional-checkout-buttons">{{ content_for_additional_checkout_buttons }}</div>
                {% endif %}
              </div>
              <div class="cart-drawer__continue-action">
                <button class="cart-drawer__continue-btn cart-drawer__secondary-link" type="button">
                  {{ 'layout.cart.continue_shopping' | t }}
                </button>
              </div>
            {%- endif -%}
            <h2 id="cart_dialog_status" role="status" class="js-cart-drawer-status sr-only"></h2>
          </div>
        </div>
        <div class="cart-sidebar__loader-overlay"><div class="cart-sidebar__spinner"></div></div>
      </div>
    </div>
  </form>
</aside>
{% schema %}
  { "name": "Cart Drawer", "settings": [] }
{% endschema %}