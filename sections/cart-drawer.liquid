{%- comment -%}
  Cart Drawer - V2.2 (Custom Meal Logic Fix)
  - FIXED: The `has_meal_plan` check is now more specific and no longer incorrectly identifies custom meals as meal plans.
  - RETAINED: The complete V2 visual refresh and all functional elements.
{%- endcomment -%}

{%- liquid
  assign meal_target = 8

  assign has_meal_plan = false
  for progress_item in cart.items
    assign product_type_lower = progress_item.product.type | downcase
    if product_type_lower contains 'meal plan' or progress_item.product.handle contains 'meal-plan'
      assign has_meal_plan = true
      break
    endif
  endfor

  if has_meal_plan
    assign progress_current = meal_target
    assign progress_target = meal_target
    assign progress_percentage = 100
    assign checkout_url = '/pages/add-ons'
    assign progress_message = "Great! You have enough meals to checkout."
  elsif settings.enable_free_delivery_promo
    assign free_delivery_target = settings.free_delivery_threshold | default: 21
    assign progress_current = 0
    assign excluded_collections = 'proteinpopcorn,butters,proteincoffee,seasonings' | split: ','
    assign rc_progress_bundles = '|'
    for progress_item in cart.items
      assign rc_bundle_id = progress_item.properties._rc_bundle
      if rc_bundle_id != blank
        assign rc_bundle_token = '|' | append: rc_bundle_id | append: '|'
        if rc_progress_bundles contains rc_bundle_token
          continue
        endif
        assign rc_progress_bundles = rc_progress_bundles | append: rc_bundle_id | append: '|'
        assign bundle_quantity = progress_item.quantity | times: 1
        assign progress_current = progress_current | plus: bundle_quantity
        continue
      endif
      assign item_collections = progress_item.product.collections | map: 'handle'
      assign is_excluded = false
      for excluded in excluded_collections
        if item_collections contains excluded
          assign is_excluded = true
          break
        endif
      endfor
      assign product_type_lower = progress_item.product.type | downcase
      if product_type_lower contains 'meal plan' or progress_item.product.handle contains 'meal-plan' or progress_item.product.type == 'OPTIONS_HIDDEN_PRODUCT'
        assign is_excluded = true
      endif
      unless is_excluded
        assign item_multiplier = 1
        if progress_item.variant.title contains 'Meal'
          assign potential = progress_item.variant.title | split: ' ' | first | times: 1
          if potential > 0
            assign item_multiplier = potential
          endif
        endif
        assign item_meals = progress_item.quantity | times: item_multiplier
        assign progress_current = progress_current | plus: item_meals
      endunless
    endfor
    if progress_current < meal_target
      assign remaining_meals = meal_target | minus: progress_current
      if remaining_meals < 0
        assign remaining_meals = 0
      endif
      assign progress_percentage = progress_current | times: 100.0 | divided_by: meal_target
      assign progress_target = meal_target
      capture progress_message
        echo "Add " | append: remaining_meals | append: " more meals to checkout."
      endcapture
      assign checkout_url = '/pages/add-ons'
    else
      assign remaining_free_delivery = free_delivery_target | minus: progress_current
      if remaining_free_delivery < 0
        assign remaining_free_delivery = 0
      endif
      assign progress_percentage = progress_current | times: 100.0 | divided_by: free_delivery_target
      assign progress_target = free_delivery_target
      if progress_current >= free_delivery_target and settings.free_delivery_discount_code != blank
        assign checkout_url = '/pages/add-ons?discount=' | append: settings.free_delivery_discount_code
      else
        assign checkout_url = '/pages/add-ons'
      endif
      capture progress_message
        if progress_current >= free_delivery_target
          echo settings.free_delivery_unlocked_message
          if settings.free_delivery_discount_code != blank
            echo " Use code " | append: settings.free_delivery_discount_code | append: " at checkout."
          endif
        else
          echo settings.free_delivery_locked_message | replace: '{remaining}', remaining_free_delivery
        endif
      endcapture
    endif
  else
    assign progress_current = 0
    assign non_meal_types = 'peanut butter,protein popcorn,seasoning,beverage,options_hidden_product' | split: ','
    assign rc_progress_bundles = '|'
    for progress_item in cart.items
      assign rc_bundle_id = progress_item.properties._rc_bundle
      if rc_bundle_id != blank
        assign rc_bundle_token = '|' | append: rc_bundle_id | append: '|'
        if rc_progress_bundles contains rc_bundle_token
          continue
        endif
        assign rc_progress_bundles = rc_progress_bundles | append: rc_bundle_id | append: '|'
        assign bundle_quantity = progress_item.quantity | times: 1
        assign progress_current = progress_current | plus: bundle_quantity
        continue
      endif
      assign product_type_lower = progress_item.product.type | downcase
      if non_meal_types contains product_type_lower
        continue
      endif
      assign item_multiplier = 1
      if progress_item.variant.title contains 'Meal'
        assign potential = progress_item.variant.title | split: ' ' | first | times: 1
        if potential > 0
          assign item_multiplier = potential
        endif
      endif
      assign item_meals = progress_item.quantity | times: item_multiplier
      assign progress_current = progress_current | plus: item_meals
    endfor
    assign remaining_meals = meal_target | minus: progress_current
    if remaining_meals < 0
      assign remaining_meals = 0
    endif
    assign progress_percentage = progress_current | times: 100.0 | divided_by: meal_target
    assign progress_target = meal_target

    if progress_current >= meal_target
      assign progress_message = "Great! You have enough meals to checkout."
    else
      assign progress_message = "Add " | append: remaining_meals | append: " more meals to checkout."
    endif
    assign checkout_url = '/pages/add-ons'
  endif

  if progress_percentage > 100
    assign progress_percentage = 100
  endif
-%}

<script class="cartFlagX"></script><aside id="cartSlideoutAside">
  <form action="{{ routes.cart_url }}" method="post" novalidate class="cart-drawer-form">
    <div id="cartSlideoutWrapper" class="cart-drawer fresh-shopping-right slideout-panel-hidden cart-drawer-right" role="dialog" aria-labelledby="cart_dialog_label" aria-modal="true" data-cart-drawer>
      <div class="cart-drawer__content-host">
        <div class="cart-drawer__header">
          <div class="cart-drawer__title-bar">
            <h2 class="cart-drawer__title" id="cart_dialog_label" data-cart-drawer-heading>Your Cart</h2>
            <button class="cart-drawer__close-btn alt-focus" aria-label="{{ 'cart.general.close_cart' | t }}" type="button">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
          </div>
          {%- if cart.item_count > 0 -%}
            <div class="cart-progress cart-progress--green">
              <p class="cart-progress__text" aria-live="polite">{{ progress_message | strip }}</p>
              <div class="cart-progress__bar" role="progressbar" aria-label="Meal progress" aria-valuenow="{{ progress_current }}" aria-valuemin="0" aria-valuemax="{{ progress_target }}">
                <div class="cart-progress__bar-inner" style="width: {{ progress_percentage }}%;"></div>
              </div>
            </div>
          {%- endif -%}
        </div>

        <div class="cart-drawer__body">
          {% render 'cart-item-list', context: 'drawer' %}
          <div class="cart-error-box"></div>
        </div>

        {%- if cart.item_count > 0 -%}
          <div class="cart-drawer__footer">
            <div class="cart-drawer__summary-wrapper">
              {%- for discount in cart.cart_level_discounts -%}
                <div class="cart-drawer__discount-line">
                  <span class="cart-drawer__discount-label">
                    <svg aria-hidden="true" focusable="false" role="presentation" viewBox="0 0 12 12"><path fill-rule="evenodd" clip-rule="evenodd" d="M7 0h3a2 2 0 012 2v3a1 1 0 01-.29.71l-4 4a1 1 0 01-1.42 0l-3-3a1 1 0 010-1.42l4-4A1 1 0 017 0zm2 2a1 1 0 100 2 1 1 0 000-2z" fill="currentColor"></path></svg>
                    {{ discount.title }}
                  </span>
                  <span class="cart-drawer__discount-amount money">-{{ discount.total_allocated_amount | money }}</span>
                </div>
              {%- endfor -%}

              <div class="cart-drawer__subtotal">
                <span class="cart-drawer__subtotal-label">{{ 'cart.general.subtotal' | t }}</span>
                <span class="cart-drawer__subtotal-price" id="cart_drawer_subtotal">
                  {% if cart.total_discount > 0 %}<del class="money">{{ cart.original_total_price | money }}</del>{% endif %}
                  <span class="money"><span style="display:none" class="tdf-cart-total-flag"></span>{{ cart.total_price | money }}</span>
                </span>
              </div>
            </div>

            {%- capture taxes_shipping_checkout -%}
              {%- if cart.taxes_included and shop.shipping_policy.body != blank -%}
                {{ 'cart.general.taxes_included_and_shipping_policy_html' | t: link: shop.shipping_policy.url }}
              {%- elsif cart.taxes_included -%}
                {{ 'cart.general.taxes_included_but_shipping_at_checkout' | t }}
              {%- elsif shop.shipping_policy.body != blank -%}
                {{ 'cart.general.taxes_and_shipping_policy_at_checkout_html' | t: link: shop.shipping_policy.url }}
              {%- else -%}
                {{ 'cart.general.taxes_and_shipping_at_checkout' | t }}
              {%- endif -%}
            {%- endcapture -%}
            <p class="cart-drawer__subtext">{{ taxes_shipping_checkout }}</p>

            <div class="cart-drawer__actions">
              <button type="button" class="btn cart-drawer__checkout-btn" data-checkout-url="{{ checkout_url }}">
                <span class="cart-button-checkout-text">Proceed to Checkout</span>
                <span class="cart-button-checkout-spinner lds-dual-ring hide"></span>
              </button>
               {% if additional_checkout_buttons and settings.enable-additional-checkout-buttons %}
                <div class="additional-checkout-buttons">{{ content_for_additional_checkout_buttons }}</div>
              {% endif %}
              <div class="cart-drawer__continue-action">
                <a href="{{ routes.cart_url }}" class="cart-drawer__secondary-link">View Full Cart</a>
              </div>
            </div>
            <h2 id="cart_dialog_status" role="status" class="js-cart-drawer-status sr-only"></h2>
            <div class="cart-drawer__discounts cart--order-discount-wrapper custom-font ajax-cart-discount-wrapper" style="display: none;"></div>
          </div>
        {%- endif -%}

        <!-- Loader overlay remains inside the positioned host -->
        <div class="cart-sidebar__loader-overlay"><div class="cart-sidebar__spinner"></div></div>
      </div>
    </div>
  </form>
</aside>
{% schema %}
  { "name": "Cart Drawer", "settings": [] }
{% endschema %}