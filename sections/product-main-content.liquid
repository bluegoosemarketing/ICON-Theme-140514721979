{% comment %}
<!--
************************************************************************************
*
*  Product Page - Main Content (v25.1 - DEFINITIVE DESIGN + CONVERSION CTA)
*  --------------------------------------------------------------------------------
*  - DIAGNOSIS: Previous header designs for the reference cards were not premium
*    enough. A bold, confident, and unique solution was required. The primary
*    Call-to-Action (CTA) block felt stylistically disconnected and lacked the
*    visual polish of the main product card.
*  - THE FIX (DEFINITIVE VERSION):
*    1. ELEGANT TAB HEADERS: All icons and simple lines are removed. The headers
*       are now redesigned as sophisticated, colored "tabs" attached to the top
*       of each card. This creates a premium, architectural, and custom feel.
*    2. BOLD HIERARCHY: The new design uses brand color to create strong visual
*       anchors for each section, guiding the user's eye and adding rhythm to the
*       layout. The header text is now white for maximum contrast.
*    3. CONVERSION-OPTIMIZED CTA (NEW): The entire "Action" card has been
*       redesigned to match the premium aesthetic of the "Hook" card.
*         - It now features a similar gradient background and shadow treatment.
*         - Subscription options are large, clear, clickable buttons.
*         - The active state is highlighted with a bold brand-color border.
*         - The quantity selector and "Add" button are unified in a final,
*           high-contrast action step, making the "Add" button the primary focal point.
*    4. CODE CLEANUP: All unused icon HTML and CSS have been completely removed,
*       resulting in a cleaner and more maintainable final product.
*    5. HOLISTIC PERFECTION: This change provides the final, elegant solution,
*       unifying the entire page under a single, world-class design language.
*
************************************************************************************
-->
{% endcomment %}

{%- liquid
  assign current_variant = product.selected_or_first_available_variant | default: product.first_available_variant
  assign featured_image = current_variant.featured_image | default: product.featured_image
  assign macros = product.metafields.macros
  assign nutrition = product.metafields.nutrition
  assign macros_exist = false
  if macros.macros_calories != blank or macros.macros_protein != blank or macros.macros_carbs != blank or macros.macros_fats != blank or macros.macros_fiber != blank or macros.macros_sodium != blank
    assign macros_exist = true
  endif
  assign ingredient_highlights = product.metafields.custom.ingredient_highlights
  assign hero_badge = product.metafields.custom.hero_badge
-%}

{% if template contains 'product' %}
<script type="application/ld+json">
{
  "@context": "https://schema.org/",
  "@type": "Product",
  "name": {{ product.title | json }},
  "image": [{% for image in product.images %}{{ image | image_url: width: 1200 | json }}{% unless forloop.last %}, {% endunless %}{% endfor %}],
  "description": {{ product.description | strip_html | json }},
  "sku": {{ product.selected_or_first_available_variant.sku | json }},
  "brand": { "@type": "Brand", "name": "ICON Meals" },
  "nutrition": {
    "@type": "NutritionInformation",
    {% assign m = product.metafields.macros %}
    {% if m.macros_calories != blank %}
      "calories": {{ m.macros_calories | append: ' calories' | json }}
    {% endif %}
    {% if m.macros_protein != blank %}
      {% if m.macros_calories != blank %}, {% endif %}"proteinContent": {{ m.macros_protein | append: ' g' | json }}
    {% endif %}
    {% if m.macros_carbs != blank %}
      {% if m.macros_calories != blank or m.macros_protein != blank %}, {% endif %}"carbohydrateContent": {{ m.macros_carbs | append: ' g' | json }}
    {% endif %}
    {% if m.macros_fats != blank %}
      {% if m.macros_calories != blank or m.macros_protein != blank or m.macros_carbs != blank %}, {% endif %}"fatContent": {{ m.macros_fats | append: ' g' | json }}
    {% endif %}
    {% if m.macros_fiber != blank %}
      {% if m.macros_calories != blank or m.macros_protein != blank or m.macros_carbs != blank or m.macros_fats != blank %}, {% endif %}"fiberContent": {{ m.macros_fiber | append: ' g' | json }}
    {% endif %}
    {% if m.macros_sodium != blank %}
      {% if m.macros_calories != blank or m.macros_protein != blank or m.macros_carbs != blank or m.macros_fats != blank or m.macros_fiber != blank %}, {% endif %}"sodiumContent": {{ m.macros_sodium | append: ' mg' | json }}
    {% endif %}
  },
  "offers": {
    "@type": "Offer",
    "url": {{ request.origin | append: product.url | json }},
    "priceCurrency": {{ localization.country.currency.iso_code | default: cart.currency.iso_code | default: shop.currency | json }},
    "price": {{ current_variant.price | divided_by: 100.0 | json }},
    "itemCondition": "https://schema.org/NewCondition"
  }
}
</script>
{% endif %}

{% unless template.suffix contains 'recharge-bundle' %}
  <script>
    (function () {
      var applyPdpMobileLock = function () {
        var lockClass = 'pdp-mobile-lock';
        var optionalWrappers = ['.main-body-wrapper', '#PageContainer', '#MainContent', '.shopify-section--main-product', '.product-template-wrapper'];

        document.documentElement.classList.add(lockClass);
        document.body.classList.add(lockClass);

        optionalWrappers.forEach(function (selector) {
          var nodes = document.querySelectorAll(selector);
          if (nodes && nodes.length) {
            nodes.forEach(function (node) {
              node.classList.add(lockClass + '--wrapper');
            });
          }
        });
      };

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', applyPdpMobileLock);
      } else {
        applyPdpMobileLock();
      }
    })();
  </script>
{% else %}
  <script>
    (function () {
      var removePdpMobileLock = function () {
        var lockClass = 'pdp-mobile-lock';
        var optionalWrappers = ['.main-body-wrapper', '#PageContainer', '#MainContent', '.shopify-section--main-product', '.product-template-wrapper'];

        document.documentElement.classList.remove(lockClass);
        document.body.classList.remove(lockClass);

        optionalWrappers.forEach(function (selector) {
          var nodes = document.querySelectorAll(selector);
          if (nodes && nodes.length) {
            nodes.forEach(function (node) {
              node.classList.remove(lockClass + '--wrapper');
            });
          }
        });
      };

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', removePdpMobileLock);
      } else {
        removePdpMobileLock();
      }
    })();
  </script>
{% endunless %}

<style>
  :root{
    --brand-primary: #2a9d8f;
    --brand-primary-light: #f0fdfa;
    --brand-primary-border: rgba(42, 157, 143, 0.4);
    --text-on-brand: #ffffff;
    --macro-color-calories: #6c757d;
    --macro-color-protein: #2a9d8f;
    --macro-color-carbs: #e9c46a;
    --macro-color-fats: #8ab17d;
    --macro-color-fiber: #b58db6;
    --macro-color-sodium: #f4a261;
    --border-color-soft: #e9ecef;
    --background-soft: #f8f9fa;
    --text-primary: #212529;
    --text-secondary: #495057;
    --brand-accent-faded: #f7fdfa;
  }

  #product-main-{{ section.id }} {
    --product-mobile-gutter: clamp(1rem, 4vw, 1.5rem);
  }

  {% unless template.suffix contains 'recharge-bundle' %}
  @media (max-width: 749px) {
    html.pdp-mobile-lock,
    body.pdp-mobile-lock {
      overflow-x: hidden;
      overscroll-behavior-x: none;
    }

    body.pdp-mobile-lock #product-main-{{ section.id }} {
      max-width: 100vw;
      overflow-x: hidden;
      overscroll-behavior-x: none;
    }

    body.pdp-mobile-lock .main-body-wrapper,
    body.pdp-mobile-lock #PageContainer,
    body.pdp-mobile-lock #MainContent,
    body.pdp-mobile-lock .shopify-section--main-product,
    body.pdp-mobile-lock .product-template-wrapper,
    body.pdp-mobile-lock .pdp-mobile-lock--wrapper {
      max-width: 100vw;
      overflow-x: hidden;
      overscroll-behavior-x: none;
    }
  }
  {% endunless %}

  /* Core Layout - PRESERVED */
  #product-main-{{ section.id }} .product-main__layout{display:flex;flex-direction:column;gap:1.5rem;padding:1.5rem 1.2rem; max-width: 100%; overflow-x: hidden;}
  #product-main-{{ section.id }} .product-main__visuals-wrapper,
  #product-main-{{ section.id }} .product-main__info-column{display:flex;flex-direction:column;gap:1.5rem;}

  /* 1. The "Hook" Card - DEFINITIVE POLISH */
  #product-main-{{ section.id }} .product-intro-card {position:relative;overflow:hidden;background:linear-gradient(135deg,#ffffff 0%,#f8fffb 55%,#f0fdfa 100%);border:1px solid rgba(42,157,143,0.14);border-radius:18px;padding:clamp(1.75rem,4vw,2.75rem);display:flex;flex-direction:column;gap:clamp(1.75rem, 3vw, 2.5rem);box-shadow:0 28px 45px rgba(15,23,42,0.08);}
  #product-main-{{ section.id }} .product-intro-card::before{content:"";position:absolute;inset:auto -35% 20% auto;width:340px;height:340px;background:radial-gradient(circle at center,rgba(42,157,143,0.18) 0%,rgba(42,157,143,0) 70%);opacity:.9;pointer-events:none;}
  #product-main-{{ section.id }} .product-intro-card::after{content:"";position:absolute;top:-120px;left:-120px;width:240px;height:240px;border-radius:50%;background:radial-gradient(circle at center,rgba(236,72,153,0.12) 0%,rgba(236,72,153,0) 70%);pointer-events:none;}
  #product-main-{{ section.id }} .product-main__header{position:relative;z-index:1;display:flex;flex-direction:column;gap:1.25rem;align-items:flex-start;}
  /* PDP Meta Line (Eyebrow + Diet Tags) */
  #product-main-{{ section.id }} .product-main__meta-line {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.75rem; /* Creates nice spacing between eyebrow and tags */
  }
  /* Override default spacing on the tag wrapper */
  #product-main-{{ section.id }} .product-main__meta-line .product-card__diet-tags {
    margin-top: 0;
  }
  /* DEFINITIVE FIX: Make diet tags match the eyebrow size on PDP */
  #product-main-{{ section.id }} .product-main__meta-line .diet-tag {
    font-size: 0.85rem !important;
    padding: 0.25rem 0.85rem !important;
    letter-spacing: 0.08em !important;
    line-height: 1.4; /* Ensures consistent vertical alignment */
  }
  #product-main-{{ section.id }} .product-main__eyebrow{display:inline-flex;align-items:center;gap:0.5rem;padding:0.25rem 0.85rem;border-radius:999px;background:rgba(42,157,143,0.12);color:#1f766b;font-weight:700;font-size:0.85rem;letter-spacing:0.08em;text-transform:uppercase;text-decoration:none;}
  #product-main-{{ section.id }} .product-main__eyebrow:hover,#product-main-{{ section.id }} .product-main__eyebrow:focus{color:#1f766b;text-decoration:none;}
  #product-main-{{ section.id }} .product-main__title{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif!important;font-size:clamp(2.2rem,3vw,3rem)!important;font-weight:800!important;line-height:1.05!important;color:#0f172a!important;letter-spacing:-0.025em;margin:0;text-wrap:balance;}
  #product-main-{{ section.id }} .product-main__price{position:relative;z-index:1;display:inline-flex;align-items:center;padding:0.6rem 1.25rem;border-radius:999px;background:#fff;border:1px solid rgba(15,23,42,0.1);box-shadow:inset 0 1px 2px rgba(0,0,0,0.05), 0 8px 20px rgba(15,23,42,0.08);font-size:clamp(1.3rem,1.8vw,1.6rem);font-weight:800;color:#0f172a;transition:all .2s ease;}
  #product-main-{{ section.id }} .product-main__price.price--live{border-color:rgba(42,157,143,0.3);color:#0b3a34;box-shadow:inset 0 1px 2px rgba(42,157,143,0.1), 0 10px 25px rgba(42,157,143,0.12);}
  #product-main-{{ section.id }} .product-main__price.price--live .price-note{font-size:0.9rem;font-weight:600;color:#1f766b;margin-left:0.5rem;}
  #product-main-{{ section.id }} .product-summary-content{position:relative;z-index:1;display:flex;flex-direction:column;gap:1.65rem;}
  #product-main-{{ section.id }} .product-description{margin:0;color:#334155;font-size:clamp(1.05rem,1.5vw,1.22rem);line-height:1.8;font-weight:500;}
  #product-main-{{ section.id }} .product-description p{margin-bottom:1.1rem;}
  #product-main-{{ section.id }} .product-description p:last-child{margin-bottom:0;}
  #product-main-{{ section.id }} .product-summary-content .product-description ul,
  #product-main-{{ section.id }} .product-summary-content .product-description ol {margin:0;padding-left:1.35rem;}
  #product-main-{{ section.id }} .product-summary-content .product-description li{margin-bottom:0.75rem;}
  #product-main-{{ section.id }} .product-summary-content .product-description li:last-child{margin-bottom:0;}
  #product-main-{{ section.id }} .product-highlights{padding-top:2.5rem;border-top:1px solid rgba(15,23,42,0.08);}
  #product-main-{{ section.id }} .product-highlights__title{margin: 0 0 2rem;font-size:1.1rem;font-weight:750;letter-spacing:0.09em;text-transform:uppercase;color:#0f172a;}
  #product-main-{{ section.id }} .product-highlights ul {list-style:none;padding:0;margin:0;display:flex;flex-wrap:wrap;gap:0.85rem;}
  #product-main-{{ section.id }} .product-highlights li {display:inline-flex;align-items:center;gap:0.65rem;background-color:rgba(255,255,255,0.95);border:1px solid rgba(42,157,143,0.2);border-radius:999px;padding:0.55rem 1.35rem;font-size:1rem;font-weight:600;color:#0f172a;line-height:1.4;letter-spacing:0.02em;box-shadow:0 10px 18px rgba(15,23,42,0.06);transition:transform 0.2s ease,box-shadow 0.2s ease,border-color 0.2s ease;}
  #product-main-{{ section.id }} .product-highlights li:hover {transform:translateY(-3px);box-shadow:0 14px 22px rgba(15,23,42,0.12);border-color:rgba(31,118,107,0.45);}
  #product-main-{{ section.id }} .product-highlights .ingredient-indicator {width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg,rgba(31,118,107,1) 0%,rgba(42,157,143,0.8) 100%);flex-shrink:0;box-shadow:0 0 0 2px #fff;}

  /* Visuals Column - ENHANCED */
  #product-main-{{ section.id }} .product-main__gallery-image-wrapper {background:#fff;border-radius:12px;border:1px solid var(--border-color-soft);box-shadow:0 4px 12px rgba(0,0,0,.05);padding:0.5rem;position:relative;}
  #product-main-{{ section.id }} .product-main__gallery-image-wrapper::after {content:'';position:absolute;top:0;left:0;right:0;bottom:0;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.6) 0%,rgba(255,255,255,0) 25%);pointer-events:none;}
  #product-main-{{ section.id }} .product-main__gallery-image {width:100%;height:auto;border-radius:8px;display:block;}
  #product-main-{{ section.id }} .product-macros-block{display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;border:1px solid var(--border-color-soft);border-radius:12px;overflow:hidden;padding:0.75rem;background:var(--background-soft);}
  #product-main-{{ section.id }} .macro-stat{padding:1rem .5rem;text-align:center;background-color:#fff;border-radius:8px;border-top-width:4px;border-top-style:solid;transition:transform 0.2s ease,box-shadow 0.2s ease;}
  #product-main-{{ section.id }} .macro-stat:hover {transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,0.04);}
  #product-main-{{ section.id }} .macro-stat--secondary{grid-column:1 / -1;display:grid;grid-template-columns:repeat(4,1fr);gap:0.75rem;margin-top:0;}
  #product-main-{{ section.id }} .macro-stat--calories{border-top-color:var(--macro-color-calories);}
  #product-main-{{ section.id }} .macro-stat--protein{border-top-color:var(--macro-color-protein);}
  #product-main-{{ section.id }} .macro-stat--carbs{border-top-color:var(--macro-color-carbs);}
  #product-main-{{ section.id }} .macro-stat--fats{border-top-color:var(--macro-color-fats);}
  #product-main-{{ section.id }} .macro-stat--fiber{border-top-color:var(--macro-color-fiber);}
  #product-main-{{ section.id }} .macro-stat--sodium{border-top-color:var(--macro-color-sodium);}
  #product-main-{{ section.id }} .macro-stat__value{font-size:1.1rem;font-weight:700;color:var(--text-primary);line-height:1.2;display:block;margin-bottom:.25rem;}
  #product-main-{{ section.id }} .macro-stat__label{font-size:.7rem;color:#6c757d;text-transform:uppercase;letter-spacing:.05em;display:block;font-weight:600;}
  #product-main-{{ section.id }} .macro-stat--primary .macro-stat__value {font-size:1.5rem;}
  #product-main-{{ section.id }} .macro-stat--primary .macro-stat__label {font-size:0.8rem;}

  /* 2. The "Action" Card - REVISED & CORRECTED */
  #product-main-{{ section.id }} .product-main__form {
    border-radius: 18px;
    background: linear-gradient(135deg, #fdfdfd 0%, #f7fdfb 60%, #f5fbf9 100%);
    border: 1px solid rgba(42, 157, 143, 0.1);
    box-shadow: 0 20px 40px rgba(15, 23, 42, 0.07);
    padding: clamp(1.25rem, 4vw, 2rem);
    display: flex;
    flex-direction: column;
    gap: 1.5rem; /* CORRECTED SPACING */
  }
  #product-main-{{ section.id }} .product-main__options .rc-widget-injection-parent > div {
    display: flex;
    flex-direction: column;
    gap: 0.85rem;
  }
  #product-main-{{ section.id }} .product-main__options .rc-option {
    border: 2px solid var(--border-color-soft);
    border-radius: 12px;
    padding: 1.25rem;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    background-color: #fff;
  }
  #product-main-{{ section.id }} .product-main__options .rc-option:hover {
    border-color: var(--brand-primary-border);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(15, 23, 42, 0.06);
  }
  #product-main-{{ section.id }} .product-main__options .rc-option.rc-option--active {
    border-color: var(--brand-primary) !important;
    background-color: var(--brand-primary-light) !important;
    box-shadow: 0 0 0 4px rgba(42, 157, 143, 0.15) !important;
  }
  #product-main-{{ section.id }} .product-main__options .rc-option__selector { margin-right: 1.15rem; transform: scale(1.1); }
  #product-main-{{ section.id }} .product-main__options .rc-option-wrapper { display: flex; align-items: center; }
  #product-main-{{ section.id }} .product-main__options .rc-option__title { font-weight: 700; font-size: 1.1rem; color: var(--text-primary); }
  #product-main-{{ section.id }} .product-main__options .rc-option__price { font-weight: 800; font-size: 1.15rem; margin-left: auto; color: var(--text-primary); }

  /* Actions Wrapper - Universal Grid Layout */
  #product-main-{{ section.id }} .product-main__actions {
    display: grid;
    grid-template-columns: 140px 1fr;
    gap: 1rem;
    align-items: stretch; /* This ensures both items fill the height of the row */
  }

  /* Quantity Selector - REVERTED TO ORIGINAL STYLE */
#product-main-{{ section.id }} .integrated-quantity {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background-color: var(--brand-primary);
  border-radius: 8px;
  color: var(--text-on-brand);
  height: 50px !important; /* DEFINITIVE FIX: Overrides custom.css */
  box-sizing: border-box; /* Ensures consistent height */
}
  #product-main-{{ section.id }} .integrated-quantity__button {
    background: transparent;
    border: none;
    font-size: 1.5rem;
    line-height: 1;
    color: var(--text-on-brand);
    cursor: pointer;
    transition: opacity 0.2s ease;
    padding: 0 1rem;
  }
  #product-main-{{ section.id }} .integrated-quantity__button:hover { opacity: 0.8; }
  #product-main-{{ section.id }} .integrated-quantity__text {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--text-on-brand);
  }
  #product-main-{{ section.id }} .integrated-quantity__input { display: none; }

  /* Add to Cart Button - REVERTED TO ORIGINAL STYLE */
#product-main-{{ section.id }} .product-main-add-to-cart {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.75rem;
  width: 100%;
  background-color: transparent;
  color: var(--brand-primary);
  border: 2px solid var(--brand-primary);
  border-radius: 8px;
  height: 50px !important; /* DEFINITIVE FIX: Ensures consistency */
  padding: 1rem;
  font-size: 1rem;
  font-weight: 700;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  cursor: pointer;
  transition: all 0.2s ease;
  box-sizing: border-box; /* Ensures consistent height */
}
  #product-main-{{ section.id }} .product-main-add-to-cart:hover {
    background-color: var(--brand-primary-light);
  }
  #product-main-{{ section.id }} .product-main-add-to-cart svg {
    stroke: var(--brand-primary);
    stroke-width: 2.5;
  }
  
  /* 3. The "Reference" Cards - DEFINITIVE ACCENT BORDER DESIGN */
  #product-main-{{ section.id }} .product-visible-details{display:flex;flex-direction:column;gap:1.5rem;}
  #product-main-{{ section.id }} .product-detail-block {
    background: #fff;
    border: 1px solid var(--border-color-soft);
    border-radius: 12px;
    padding: 1.5rem;
  }
  #product-main-{{ section.id }} .product-detail-block h3 {
    margin: 0 0 1.25rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid var(--macro-color-protein);
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--text-primary);
    text-transform: uppercase;
    letter-spacing: .05em;
  }
  #product-main-{{ section.id }} .product-detail-block .rte{color:var(--text-secondary);line-height:1.6;}
  #product-main-{{ section.id }} .meal-component{margin-bottom:1.25rem;}
  #product-main-{{ section.id }} .meal-component:last-child{margin-bottom:0;}
  #product-main-{{ section.id }} .meal-component strong{display:block;margin-bottom:.35rem;color:var(--text-primary);font-weight:600;}
  #product-main-{{ section.id }} .meal-component p{margin:0;color:var(--text-secondary);line-height:1.5;}
  #product-main-{{ section.id }} .full-ingredients-collapsible {margin-top:1.5rem;padding-top:1.5rem;border-top:1px solid var(--border-color-soft);}
  #product-main-{{ section.id }} .full-ingredients-collapsible summary {display:flex;justify-content:space-between;align-items:center;cursor:pointer;list-style:none;font-weight:600;color:var(--text-secondary);transition:color 0.2s ease;}
  #product-main-{{ section.id }} .full-ingredients-collapsible summary:hover {color:var(--text-primary);}
  #product-main-{{ section.id }} .full-ingredients-collapsible summary::-webkit-details-marker {display:none;}
  #product-main-{{ section.id }} .full-ingredients-collapsible[open] > summary {margin-bottom:1rem;}
  #product-main-{{ section.id }} .full-ingredients-collapsible .collapsible-icon {width:1rem;height:1rem;transition:transform 0.2s ease-in-out;}
  #product-main-{{ section.id }} .full-ingredients-collapsible[open] > summary .collapsible-icon {transform:rotate(180deg);}
  #product-main-{{ section.id }} .full-ingredients-collapsible .rte {font-size:0.9rem;color:#6c757d;}

  /* Live Nutrition Calculator (for Custom Meals) */
  #product-main-{{ section.id }} .nutrition-facts-live {background:#fff;border:1px solid var(--border-color-soft);border-radius:12px;padding:1.5rem;}
  #product-main-{{ section.id }} .nutrition-facts-live h3 {margin:0 0 1rem;font-size:1rem;font-weight:700;letter-spacing:.03em;text-transform:uppercase;color:#343a40;border-bottom:1px solid var(--border-color-soft);padding-bottom:1rem;}
  #product-main-{{ section.id }} .nutrition-facts__list {list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:0.85rem;}
  #product-main-{{ section.id }} .nutrition-facts__item {display:flex;justify-content:space-between;align-items:center;font-size:0.95rem;}
  #product-main-{{ section.id }} .nutrition-facts__label {display:flex;align-items:center;gap:0.65rem;color:var(--text-secondary);}
  #product-main-{{ section.id }} .nutrition-facts__value {font-weight:600;color:var(--text-primary);font-feature-settings:"tnum";}
  #product-main-{{ section.id }} .nutrition-facts__label::before {content:'';width:8px;height:8px;border-radius:50%;display:inline-block;}
  #product-main-{{ section.id }} .nutrition-facts__item--calories .nutrition-facts__label::before { background-color: var(--macro-color-calories); }
  #product-main-{{ section.id }} .nutrition-facts__item--protein .nutrition-facts__label::before { background-color: var(--macro-color-protein); }
  #product-main-{{ section.id }} .nutrition-facts__item--carbs .nutrition-facts__label::before { background-color: var(--macro-color-carbs); }
  #product-main-{{ section.id }} .nutrition-facts__item--fats .nutrition-facts__label::before { background-color: var(--macro-color-fats); }
  #product-main-{{ section.id }} .nutrition-facts__item--fiber .nutrition-facts__label::before { background-color: var(--macro-color-fiber); }
  #product-main-{{ section.id }} .nutrition-facts__item--sodium .nutrition-facts__label::before { background-color: var(--macro-color-sodium); }

  /* Desktop Layout - PRESERVED */
  @media (min-width:1024px){
    #product-main-{{ section.id }} .product-main__layout{display:grid;grid-template-columns:45fr 55fr;grid-template-areas:"visuals info";gap:2rem;padding:1.5rem 0;}
    #product-main-{{ section.id }} .product-main__visuals-wrapper{grid-area:visuals;position:sticky;top:1.5rem;}
    #product-main-{{ section.id }} .product-main__info-column{grid-area:info;}
    #product-main-{{ section.id }} .product-intro-card {padding:clamp(2.5rem,3vw,3.2rem);}
    #product-main-{{ section.id }} .product-main__title{font-size:3.15rem!important;}
    #product-main-{{ section.id }} .macro-stat__value{font-size:1.25rem;}
    #product-main-{{ section.id }} .macro-stat__label{font-size:.75rem;}
  }

  /* MOBILE HERO STYLES - PRESERVED */
  @media (max-width: 1023px) {
    #product-main-{{ section.id }} .product-main__layout {padding:0;gap:0;}
    #product-main-{{ section.id }} .product-main__visuals-wrapper {gap:0;border-bottom:1px solid var(--border-color-soft);padding-bottom:1.5rem;background:#fff;}
    #product-main-{{ section.id }} .product-main__gallery-image-wrapper {border-radius:0;border-left:0;border-right:0;border-top:0;box-shadow:none;padding:0;}
    #product-main-{{ section.id }} .product-main__gallery-image {border-radius:0;}
    #product-main-{{ section.id }} .product-macros-block {border:0;border-radius:0;padding:1.5rem var(--product-mobile-gutter) 0 var(--product-mobile-gutter);background:transparent;}
    #product-main-{{ section.id }} .product-main__info-column {padding:1.5rem var(--product-mobile-gutter);background:var(--background-soft);}
  }
</style>
<div id="product-main-{{ section.id }}" class="product-main" data-section-id="{{ section.id }}">
  <div class="product-main__layout">
    <div class="product-main__visuals-wrapper">
      <div class="product-main__gallery">
        {%- if featured_image -%}
          <div class="product-main__gallery-image-wrapper">
            <img src="{{ featured_image | image_url: width: 800, height: 800, crop: 'center' }}" alt="{{ featured_image.alt | escape }}" class="product-main__gallery-image" loading="eager" width="800" height="{{ 800 | divided_by: featured_image.aspect_ratio | round }}">
          </div>
        {%- endif -%}
      </div>
      {%- if macros_exist -%}
        <div class="product-macros-block">
          {%- if macros.macros_calories != blank -%}<div class="macro-stat macro-stat--primary macro-stat--calories"><span class="macro-stat__value">{{ macros.macros_calories }}</span><span class="macro-stat__label">Calories</span></div>{%- endif -%}
          {%- if macros.macros_protein != blank -%}<div class="macro-stat macro-stat--primary macro-stat--protein"><span class="macro-stat__value">{{ macros.macros_protein }}g</span><span class="macro-stat__label">Protein</span></div>{%- endif -%}
          <div class="macro-stat--secondary">
              {%- if macros.macros_carbs != blank -%}<div class="macro-stat macro-stat--carbs"><span class="macro-stat__value">{{ macros.macros_carbs }}g</span><span class="macro-stat__label">Carbs</span></div>{%- endif -%}
              {%- if macros.macros_fats != blank -%}<div class="macro-stat macro-stat--fats"><span class="macro-stat__value">{{ macros.macros_fats }}g</span><span class="macro-stat__label">Fats</span></div>{%- endif -%}
              {%- if macros.macros_fiber != blank -%}<div class="macro-stat macro-stat--fiber"><span class="macro-stat__value">{{ macros.macros_fiber }}g</span><span class="macro-stat__label">Fiber</span></div>{%- endif -%}
              {%- if macros.macros_sodium != blank -%}<div class="macro-stat macro-stat--sodium"><span class="macro-stat__value">{{ macros.macros_sodium }}mg</span><span class="macro-stat__label">Sodium</span></div>{%- endif -%}
          </div>
        </div>
      {%- endif -%}
      <div id="nutrition-container"></div>
    </div>

    <div class="product-main__info-column">
      <!-- 1. The "Hook" Card -->
      <div class="product-intro-card">
        {%- liquid
          assign hero_badge_text = ''
          assign hero_badge_url = ''
          assign is_custom_product = false
          if product.handle == 'custom-meals' or product.handle == 'custom-breakfast'
            assign is_custom_product = true
          endif

          if is_custom_product
            if product.handle == 'custom-meals'
              assign hero_badge_text = 'Build Custom Meals'
            else
              assign hero_badge_text = 'Build Custom Breakfasts'
            endif
          else
            assign base_badge_text = ''
            assign base_badge_url = ''
            if collection.title != blank
              assign base_badge_text = collection.title
              assign base_badge_url = collection.url
            elsif product.collections.size > 0
              assign first_collection = product.collections.first
              assign base_badge_text = first_collection.title
              assign base_badge_url = first_collection.url
            elsif product.vendor != blank
              assign base_badge_text = product.vendor
            endif

            if base_badge_text != blank
              assign hero_badge_text = base_badge_text | append: ' • ICON Meals'
              assign hero_badge_url = base_badge_url
            endif
          endif
        -%}
        <div class="product-main__header">
          <div class="product-main__meta-line">
            {% if hero_badge_text != blank %}
              {% if hero_badge_url != blank %}
                <a class="product-main__eyebrow" href="{{ hero_badge_url }}">{{ hero_badge_text }}</a>
              {% else %}
                <span class="product-main__eyebrow">{{ hero_badge_text }}</span>
              {% endif %}
            {% endif %}
            {% render 'diet-tags', prod: product %}
          </div>
          <h1 class="product-main__title">
            {% if product.handle == 'custom-meals' %}
              Build Custom Meals
            {% elsif product.handle == 'custom-breakfast' %}
              Build Custom Breakfasts
            {% else %}
              {{ product.title }}
            {% endif %}
          </h1>
          <div class="product-review-stars">
            <div
              class="yotpo-widget-instance"
              data-yotpo-instance-id="{{ settings.yotpo_star_instance_id }}"
              data-yotpo-product-id="{{ product.id }}"
              data-yotpo-name="{{ product.title | escape }}"
              data-yotpo-url="{{ shop.url }}{{ product.url }}"
              {% if product.featured_image %}
                data-yotpo-image-url="{{ product.featured_image | image_url: width: 1024 }}"
              {% endif %}
              data-yotpo-description="{{ product.description | strip_html | truncate: 300 | escape }}"
            ></div>
          </div>
          <div class="product-main__price"{% if product.handle == 'custom-meals' or product.handle == 'custom-breakfast' %} data-legacy-pricing="true"{% endif %}>
            <span
              data-product-price
              {% if product.handle == 'custom-meals' or product.handle == 'custom-breakfast' %}data-base-price="{{ current_variant.price }}"{% endif %}
            >{{ current_variant.price | money }}</span>
          </div>
        </div>
        
        {%- assign has_highlights = false -%}
        {%- if ingredient_highlights and ingredient_highlights.value != blank -%}
          {%- assign has_highlights = true -%}
        {%- endif -%}

        {%- if product.description != blank or has_highlights -%}
          <div class="product-summary-content">
            {%- if product.description != blank -%}
              <div class="product-description rte">{{ product.description }}</div>
            {%- endif -%}
            {%- if has_highlights -%}
              <div class="product-highlights">
                <h3 class="product-highlights__title">Main Ingredients</h3>
                <ul>
                  {%- for item in ingredient_highlights.value -%}
                    <li>
                      <span class="ingredient-indicator"></span>
                      <span>{{ item }}</span>
                    </li>
                  {%- endfor -%}
                </ul>
              </div>
            {%- endif -%}
          </div>
        {%- endif -%}
      </div>

      <!-- 2. The "Action" Card -->
      {%- form 'product', product, class: 'product-main__form product-purchase-card', data-product-form: '' -%}
        <div class="product-main__options">
          <input type="hidden" name="id" value="{{ current_variant.id }}" data-product-variant-id>
          {%- unless product.has_only_default_variant -%}
            {%- for option in product.options_with_values -%}
              <div class="product-form__option">
                <label for="Option-{{ section.id }}-{{ forloop.index0 }}">{{ option.name }}</label>
                <select id="Option-{{ section.id }}-{{ forloop.index0 }}" name="options[{{ option.name | escape }}]">
                  {%- for value in option.values -%}<option value="{{ value | escape }}" {% if option.selected_value == value %}selected="selected"{% endif %}>{{ value }}</option>{%- endfor -%}
                </select>
              </div>
            {%- endfor -%}
          {%- endunless -%}
          <div class="rc-widget-injection-parent"></div>
          {% render 'recharge-bundle' %}
        </div>
        <div class="product-main__actions">
          <div class="integrated-quantity">
            <button type="button" class="integrated-quantity__button" name="minus" aria-label="{{ 'products.product.quantity_decrease' | t }}">－</button>
            <span class="integrated-quantity__text" aria-live="polite">1</span>
            <input class="integrated-quantity__input" type="number" name="quantity" value="1" min="1" aria-label="{{ 'products.product.quantity_label' | t }}" data-quantity-input>
            <button type="button" class="integrated-quantity__button" name="plus" aria-label="{{ 'products.product.quantity_increase' | t }}">＋</button>
          </div>
          <button type="submit" name="add" class="product-card__add-btn alt-focus product-main-add-to-cart" {% unless current_variant.available %}disabled{% endunless %}>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            <span data-add-to-cart-text>{%- if current_variant.available -%}Add{%- else -%}{{ 'products.product.sold_out' | t }}{%- endif -%}</span>
          </button>
        </div>
      {%- endform -%}

      <!-- 3. The "Reference" Cards -->
      {%- assign structured_ingredients = product.metafields.custom.structured_ingredients -%}
      {%- assign instructions_html = '' -%}
      {%- if nutrition.instructions != blank -%}
        {%- assign instructions_html = nutrition.instructions -%}
      {%- elsif section.settings.default_heating_instructions != blank -%}
        {%- assign instructions_html = section.settings.default_heating_instructions -%}
      {%- endif -%}
      
      <div class="product-visible-details">
        {%- if structured_ingredients and structured_ingredients.value != blank -%}
          <section class="product-detail-block">
            <h3>Ingredient Breakdown</h3>
            {%- for component in structured_ingredients.value -%}
              <div class="meal-component">
                <strong>{{ component.component_name }}:</strong>
                <p>{{ component.ingredient_list }}</p>
              </div>
            {%- endfor -%}

            {%- if nutrition.ingredients != blank -%}
              <details class="full-ingredients-collapsible">
                <summary>
                  <span>All Ingredients (Consolidated)</span>
                  <svg class="collapsible-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </summary>
                <div class="rte">{{ nutrition.ingredients }}</div>
              </details>
            {%- endif -%}
          </section>
        {%- elsif nutrition.ingredients != blank -%}
          <section class="product-detail-block">
            <h3>Ingredients</h3>
            <div class="rte">{{ nutrition.ingredients }}</div>
          </section>
        {%- endif -%}

        {%- if nutrition.allergens != blank -%}
          <section class="product-detail-block">
            <h3>Allergens</h3>
            <div class="rte">{{ nutrition.allergens }}</div>
          </section>
        {%- endif -%}

        {%- if instructions_html != blank -%}
          <section class="product-detail-block">
            <h3>Heating Instructions</h3>
            <div class="rte">{{ instructions_html }}</div>
          </section>
        {%- endif -%}
      </div>
    </div>
  </div>
</div>

{%- render 'product-reviews-fullwidth',
  heading: section.settings.reviews_heading,
  subheading: section.settings.reviews_subheading,
  boxed_container: section.settings.reviews_boxed_container
-%}
{%- render 'footer-minimal-ordering' -%}
<script type="application/json" data-product-json>{{ product | json }}</script>
{% if product.handle == 'custom-meals' or product.handle == 'custom-breakfast' %}
  <script src="{{ 'legacy-dynamic-price.js' | asset_url }}" defer></script>
{% endif %}

<script>
(function() {
  function uniqueAnchor() {
    const anchors = Array.from(document.querySelectorAll('#yotpo-main-widget'));
    if (anchors.length > 1) {
      anchors.slice(1).forEach((anchor) => anchor.remove());
    }
  }

  function coerceYotpoHref() {
    const selectors = [
      '.yotpo.bottomLine a[href^="#"]',
      '.yotpo-widget-instance a[href^="#"]',
    ];

    selectors.forEach((selector) => {
      Array.from(document.querySelectorAll(selector)).forEach((link) => {
        if (link.getAttribute('href') !== '#yotpo-main-widget') {
          link.setAttribute('href', '#yotpo-main-widget');
        }
      });
    });
  }

  function hydrateYotpo() {
    if (window.Yotpo) {
      const fn = window.Yotpo.refreshWidgets || window.Yotpo.initWidgets;
      if (typeof fn === 'function') {
        fn.call(window.Yotpo);
      }
    }
  }

  function manageScrollPadding() {
    const header = document.querySelector('.collection-header');
    if (!header) return;

    const setPadding = () => {
      const headerHeight = header.offsetHeight;
      document.documentElement.style.scrollPaddingTop = `${headerHeight + 16}px`;
    };

    setPadding();
    window.addEventListener('resize', setPadding);
  }

  function wireSmoothScroll() {
    const selector = '.yotpo.bottomLine a[href^="#"], .yotpo-widget-instance a[href^="#"]';

    document.addEventListener('click', (event) => {
        const link = event.target.closest(selector);
        if (!link) return;

        const targetId = link.getAttribute('href').replace(/^#/, '');
        if (!targetId) return;

        const target = document.getElementById(targetId);
        if (!target) return;

        event.preventDefault();

        const prefersReducedMotion =
            typeof window.matchMedia === 'function' &&
            window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            
        target.scrollIntoView({
            behavior: prefersReducedMotion ? 'auto' : 'smooth',
            block: 'start'
        });

        if (history.replaceState) {
          history.replaceState(null, '', `#${targetId}`);
        } else {
          window.location.hash = targetId;
        }
    }, { passive: false });
  }

  function init() {
    uniqueAnchor();
    coerceYotpoHref();
    hydrateYotpo();
    manageScrollPadding(); 

    document.addEventListener('shopify:section:load', () => {
      uniqueAnchor();
      coerceYotpoHref();
      hydrateYotpo();
    });

    document.addEventListener('yotpo:widgetLoaded', () => {
      uniqueAnchor();
      coerceYotpoHref();
    });
  }

  wireSmoothScroll();

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init, { once: true });
  } else {
    init();
  }
})();
</script>

<script>
  function initRechargeGapGuard(root) {
    if (!root) return;
    root.querySelectorAll('.product-purchase-card .rc-widget-injection-parent').forEach((slot) => {
      if (slot.dataset.gapGuard === 'true') return;
      slot.dataset.gapGuard = 'true';
      slot.classList.add('is-hydrating');

      const applyState = (forceCollapse = false) => {
        const hasContent = slot.childElementCount > 0 || slot.textContent.trim() !== '';
        if (hasContent) {
          slot.classList.add('is-ready');
          slot.classList.remove('is-empty', 'is-hydrating');
        } else if (forceCollapse) {
          slot.classList.remove('is-ready', 'is-hydrating');
          slot.classList.add('is-empty');
        }
      };

      applyState(false);

      const observer = new MutationObserver(() => {
        applyState(!slot.classList.contains('is-hydrating'));
      });

      observer.observe(slot, { childList: true, subtree: true });

      window.setTimeout(() => applyState(true), 1800);
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    const sectionEl = document.querySelector('.product-main[data-section-id="{{ section.id }}"]');
    if (!sectionEl) return;
    initRechargeGapGuard(sectionEl);
    new AjaxFormHandler(sectionEl);
    new IntegratedQuantityController(sectionEl);
  });

  document.addEventListener('shopify:section:load', (event) => {
    initRechargeGapGuard(event.target);
  });

  class AjaxFormHandler {
    constructor(sectionEl) {
      this.form = sectionEl.querySelector('.product-main__form');
      this.addButton = sectionEl.querySelector('.product-main-add-to-cart');
      if (!this.form || !this.addButton) return;
      this.addButton.addEventListener('click', this.onButtonClick.bind(this));
    }
    async onButtonClick(e) {
      e.preventDefault();
      this.setLoading(true);
      try {
        const formData = new FormData(this.form);
        const response = await fetch('/cart/add.js', { method: 'POST', body: formData });
        if (!response.ok) throw new Error(await response.text());
        const cart = await response.json();
        document.dispatchEvent(new CustomEvent('cart:updated', { detail: { cart } }));
        this.setSuccess();
      } catch (error) {
        console.error('AJAX Cart Error:', error);
        this.revert();
      }
    }
    setLoading(isLoading) {
      this.addButton.classList.toggle('is-loading', isLoading);
      this.addButton.disabled = isLoading;
    }
    setSuccess() {
      this.addButton.classList.remove('is-loading');
      this.addButton.classList.add('is-added');
      setTimeout(() => this.revert(), 2000);
    }
    revert() {
      this.addButton.classList.remove('is-added');
      this.addButton.disabled = false;
    }
  }

  class IntegratedQuantityController {
    constructor(sectionEl) {
      this.wrap = sectionEl.querySelector('.integrated-quantity');
      if (!this.wrap) return;

      this.input = this.wrap.querySelector('.integrated-quantity__input[name="quantity"]');
      this.text  = this.wrap.querySelector('.integrated-quantity__text');
      this.minus = this.wrap.querySelector('[name="minus"], [data-qty-minus]');
      this.plus  = this.wrap.querySelector('[name="plus"], [data-qty-plus]');

      if (!this.input) return;

      this.bindEvents();
      this.sync();
    }
    bindEvents() {
      this.minus?.addEventListener('click', (event) => {
        event.preventDefault();
        this.adjust(-1);
      });
      this.plus?.addEventListener('click', (event) => {
        event.preventDefault();
        this.adjust(1);
      });
      this.input.addEventListener('input', () => this.sync());
      this.input.addEventListener('change', () => this.sync({ emitChange: false }));
    }
    adjust(delta) {
      const currentValue = parseInt(this.input.value, 10) || 1;
      const nextValue = Math.max(1, currentValue + delta);
      if (nextValue === currentValue) return;
      this.input.value = nextValue;
      this.sync({ emitChange: true });
    }
    sync(options = {}) {
      const { emitChange = false } = options;
      const value = Math.max(1, parseInt(this.input.value, 10) || 1);
      this.input.value = value;
      if (this.text) {
        this.text.textContent = value;
      }
      if (emitChange) {
        this.input.dispatchEvent(new Event('change', { bubbles: true }));
      }
    }
  }
</script>

{% schema %}
{
  "name": "Product Main Content",
  "tag": "section",
  "class": "product-main-content-section",
  "settings": [
    {
      "type": "richtext",
      "id": "default_heating_instructions",
      "label": "Default heating instructions"
    },
    {
      "type": "richtext",
      "id": "default_faq",
      "label": "Default FAQ content"
    },
    {
      "type": "text",
      "id": "reviews_heading",
      "label": "Reviews heading",
      "default": "Real Customer Reviews"
    },
    {
      "type": "text",
      "id": "reviews_subheading",
      "label": "Reviews subheading",
      "default": "Real meals. Real change."
    },
    {
      "type": "checkbox",
      "id": "reviews_boxed_container",
      "label": "Box reviews content",
      "default": true
    }
  ],
  "blocks": [
    { "type": "@app" }
  ],
  "max_blocks": 6
}
{% endschema %}