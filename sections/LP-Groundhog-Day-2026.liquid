{%- comment -%}
  Section: ICON Meals Groundhog Day Master Build v16.0
  Technical: Grouped AJAX Add (SKU-safe)
  Theme: The Shadow / Break the Loop
{%- endcomment -%}

{%- liquid
  assign s = section.settings
  assign promo_code = s.promo_code | default: "SHADOW31"
  assign end_date = s.end_date_v15 | default: "Feb 3, 2026 03:00:00"
  assign popcorn_products = s.popcorn_list
-%}

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

<style>
:root {
  --l-red: #D11F1F;
  --l-charcoal: #222222;
  --l-kale: #1E3A23;       
  --l-mint: #F0F7F4;       
  --l-font: 'Inter', sans-serif;
  --l-shadow: rgba(0, 0, 0, 0.15);
}

#gh-master-v16 {
  font-family: var(--l-font);
  color: var(--l-charcoal);
  background: #fff;
  line-height: 1.6;
  text-transform: none !important; 
}

/* --- THEMATIC OVERRIDES --- */
#gh-master-v16 h1, #gh-master-v16 h2, #gh-master-v16 h3 { letter-spacing: -0.04em !important; text-transform: none !important; }

.gh-container-v16 { max-width: 1400px; margin: 0 auto; padding: 0 40px; position: relative; }

/* --- HERO: SHADOW THEME --- */
.gh-hero-v16 { padding: 120px 0 180px; background: #fff; position: relative; }
.gh-hero-grid-v16 { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 60px; align-items: center; }
.gh-h1-v16 { font-size: clamp(3rem, 7vw, 5rem); font-weight: 900; line-height: 0.95; margin-bottom: 24px; }
.gh-h1-v16 span { color: var(--l-red); display: block; }

/* --- CONTENT DEPTH: THE LOOP VS THE SYSTEM --- */
.gh-loop-break { background: var(--l-charcoal); color: #fff; padding: 100px 0; border-radius: 40px 40px 0 0; margin-top: -60px; position: relative; z-index: 10; }
.gh-loop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 50px; }
.gh-loop-box { padding: 40px; border-radius: 24px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); }
.gh-loop-box.highlight { border-color: var(--l-kale); background: rgba(30, 58, 35, 0.3); }
.gh-loop-box h3 { font-size: 1.8rem; margin-bottom: 15px; }
.gh-loop-box ul { list-style: none; padding: 0; }
.gh-loop-box li { margin-bottom: 12px; display: flex; align-items: center; gap: 10px; font-weight: 500; }

/* --- CATEGORY HUB REFINED --- */
.gh-hub-nav { margin-top: -80px; padding-bottom: 80px; z-index: 20; position: relative; }
.gh-hub-inner-v16 { background: #fff; border-radius: 24px; box-shadow: 0 30px 60px var(--l-shadow); display: grid; grid-template-columns: repeat(3, 1fr); overflow: hidden; border: 1px solid #eee; }
.gh-hub-btn { padding: 40px; text-align: center; border-right: 1px solid #eee; transition: 0.3s; text-decoration: none !important; color: inherit; }
.gh-hub-btn:last-child { border-right: none; }
.gh-hub-btn:hover { background: var(--l-mint); }
.gh-hub-btn img { width: 60px; height: auto; margin-bottom: 15px; }

/* --- POPCORN LADDER --- */
.gh-ladder-v16 { padding: 100px 0; background: var(--l-mint); }
.gh-card-v16 { 
    background: #fff; border-radius: 32px; padding: 40px; border: 1px solid #e0e0e0; 
    transition: transform 0.4s cubic-bezier(0.165, 0.84, 0.44, 1), box-shadow 0.4s;
    position: relative;
    display: flex; flex-direction: column;
}
.gh-card-v16:hover { transform: translateY(-10px); box-shadow: 0 40px 80px rgba(0,0,0,0.1); }
.gh-best-value { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); background: var(--l-red); color: #fff; padding: 8px 20px; border-radius: 50px; font-weight: 900; font-size: 0.8rem; z-index: 5; }

.gh-flavor-row-v16 {
  display: grid; grid-template-columns: 60px 1fr 40px; align-items: center; gap: 15px;
  padding: 10px; border: 1px solid #eee; border-radius: 12px; margin-bottom: 8px; cursor: pointer; transition: 0.2s;
}
.gh-flavor-row-v16.selected { border-color: var(--l-kale); background: var(--l-mint); }
.gh-flavor-row-v16 img { width: 100%; border-radius: 6px; }
.gh-check-circle { width: 20px; height: 20px; border: 2px solid #ddd; border-radius: 50%; position: relative; }
.gh-flavor-row-v16.selected .gh-check-circle { border-color: var(--l-kale); background: var(--l-kale); }
.gh-flavor-row-v16.selected .gh-check-circle::after { content: '✓'; color: #fff; font-size: 12px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }

.gh-atc-v16 {
  background: var(--l-charcoal); color: #fff; border: none; padding: 20px; border-radius: 14px;
  font-weight: 800; font-size: 1rem; cursor: pointer; margin-top: 20px; transition: 0.3s; opacity: 0.4; pointer-events: none;
}
.gh-atc-v16.active { opacity: 1; pointer-events: auto; background: var(--l-red); }

@media (max-width: 900px) {
  .gh-hero-grid-v16, .gh-loop-grid, .gh-hub-inner-v16 { grid-template-columns: 1fr; }
  .gh-hub-btn { border-right: none; border-bottom: 1px solid #eee; }
}
</style>

<div id="gh-master-v16">
  <section class="gh-hero-v16">
    <div class="gh-container-v16">
      <div class="gh-hero-grid-v16">
        <div>
          <h1 class="gh-h1-v16">Stop Chasing<span>Your Shadow.</span></h1>
          <p style="font-size: 1.3rem; color: #666; max-width: 600px;">If you do what you've always done, you'll get what you've always got. Break the loop with the ICON System.</p>
        </div>
        <div class="gh-offer-card" style="background: var(--l-kale); color: #fff; padding: 50px; border-radius: 30px; text-align: center;">
          <span style="text-transform: uppercase; font-weight: 800; letter-spacing: 2px; font-size: 0.8rem; opacity: 0.8;">The Groundhog Sitewide Sale</span>
          <div style="font-size: 5rem; font-weight: 900; line-height: 1;">31% OFF</div>
          <div style="margin: 20px 0; border: 1px dashed rgba(255,255,255,0.4); padding: 15px; border-radius: 10px; font-weight: 700; font-size: 1.2rem;">CODE: {{ promo_code }}</div>
          <p style="font-size: 0.9rem; opacity: 0.7;">Excludes Popcorn Bundles (Already Discounted + Free Shipping)</p>
        </div>
      </div>
    </div>
  </section>

  <section class="gh-loop-break">
    <div class="gh-container-v16">
      <h2 style="text-align: center; font-size: 3rem;">Routine vs. System</h2>
      <div class="gh-loop-grid">
        <div class="gh-loop-box">
          <h3 style="color: #888;">The Old Routine</h3>
          <ul>
            <li>✕ Inconsistent macros & energy levels</li>
            <li>✕ High retail prices per item</li>
            <li>✕ Paying for shipping every time</li>
          </ul>
        </div>
        <div class="gh-loop-box highlight">
          <h3>The ICON System</h3>
          <ul>
            <li>✓ Batch-prepped performance meals</li>
            <li>✓ Tiered wholesale pricing built-in</li>
            <li>✓ Free shipping on every system</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <nav class="gh-hub-nav">
    <div class="gh-container-v16">
      <div class="gh-hub-inner-v16">
        <a href="{{ s.nav_1_link }}" class="gh-hub-btn">
          <img src="https://cdn.shopify.com/s/files/1/1957/2713/files/Signature-Meals_UI-Icon_v2.webp?v=1768410637">
          <div style="font-weight: 800;">Signature Menu</div>
        </a>
        <a href="{{ s.nav_2_link }}" class="gh-hub-btn">
          <img src="https://cdn.shopify.com/s/files/1/1957/2713/files/Custom-Meals_UI-Icon_v2.webp?v=1768410637">
          <div style="font-weight: 800;">Custom Meals</div>
        </a>
        <a href="{{ s.nav_3_link }}" class="gh-hub-btn">
          <img src="https://cdn.shopify.com/s/files/1/1957/2713/files/Bulk-Items_UI-Icon_v2.webp?v=1768410637">
          <div style="font-weight: 800;">Bulk Market</div>
        </a>
      </div>
    </div>
  </nav>

  <section class="gh-ladder-v16">
    <div class="gh-container-v16">
      <div style="text-align: center; margin-bottom: 60px;">
        <h2 style="font-size: 3.5rem;">Stock The System</h2>
        <p>Select your tier to unlock bulk pricing and automatic free shipping.</p>
      </div>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px;">
        {% assign counts = "3,5,10" | split: "," %}
        {% assign prices = s.tier_prices | split: "," %}
        {% assign totals = s.tier_totals | split: "," %}
        {% for count in counts %}
          <div class="gh-card-v16" data-tier="{{ count }}">
            {% if count == "10" %}<div class="gh-best-value">MOST POPULAR</div>{% endif %}
            <div style="margin-bottom: 25px;">
              <span style="font-size: 2.5rem; font-weight: 900; display: block;">{{ count }} Bags</span>
              <span style="font-size: 1.1rem; color: #666;">${{ prices[forloop.index0] }} / bag</span>
              <div style="margin-top: 15px; background: var(--l-mint); padding: 10px; border-radius: 8px; font-weight: 700; color: var(--l-kale); font-size: 0.85rem; display: inline-block;">
                ✓ Free Shipping Included
              </div>
            </div>

            <div style="background: #f9f9f9; padding: 15px; border-radius: 12px; margin-bottom: 20px; font-weight: 800; font-size: 0.8rem; text-align: center;">
              SELECT <span class="needed-count">{{ count }}</span> FLAVORS: (<span class="current-count">0</span>/{{ count }})
            </div>

            <div class="gh-flavors-list">
              {% for prod in popcorn_products %}
                <div class="gh-flavor-row-v16" data-id="{{ prod.first_available_variant.id }}" data-name="{{ prod.title | replace: 'Protein Popcorn - ', '' }}">
                  <img src="{{ prod.featured_image | image_url: width: 100 }}">
                  <span style="font-size: 0.9rem; font-weight: 600;">{{ prod.title | replace: "Protein Popcorn - ", "" }}</span>
                  <div class="gh-check-circle"></div>
                </div>
              {% endfor %}
            </div>

            <div style="margin-top: auto; border-top: 1px solid #eee; padding-top: 20px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <span style="font-weight: 700; color: #888;">Bundle Total:</span>
                <span style="font-size: 1.5rem; font-weight: 900;">${{ totals[forloop.index0] }}</span>
              </div>
              <button class="gh-atc-v16" onclick="addBundleGroup(this)">Add To System</button>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </section>
</div>

<script>
function addBundleGroup(btn) {
    const card = btn.closest('.gh-card-v16');
    const selected = card.querySelectorAll('.gh-flavor-row-v16.selected');
    const bundleId = "BNDL-" + Date.now();
    const tierName = card.getAttribute('data-tier') + " Bag Bundle";

    let items = [];
    selected.forEach(row => {
        items.push({
            id: parseInt(row.getAttribute('data-id')),
            quantity: 1,
            properties: {
                "_bundle_group": bundleId,
                "Bundle Tier": tierName
            }
        });
    });

    btn.innerText = "UPDATING CART...";
    btn.disabled = true;

    fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items: items })
    })
    .then(res => res.json())
    .then(data => {
        window.location.href = '/cart';
    })
    .catch(err => {
        console.error(err);
        btn.innerText = "ERROR - TRY AGAIN";
        btn.disabled = false;
    });
}

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.gh-card-v16').forEach(card => {
        const tier = parseInt(card.getAttribute('data-tier'));
        const atc = card.querySelector('.gh-atc-v16');
        const currentLabel = card.querySelector('.current-count');
        let count = 0;

        card.querySelectorAll('.gh-flavor-row-v16').forEach(row => {
            row.addEventListener('click', () => {
                if(row.classList.contains('selected')) {
                    row.classList.remove('selected');
                    count--;
                } else {
                    if(count < tier) {
                        row.classList.add('selected');
                        count++;
                    }
                }
                currentLabel.innerText = count;
                if(count === tier) atc.classList.add('active');
                else atc.classList.remove('active');
            });
        });
    });
});
</script>

{% schema %}
{
  "name": "Groundhog Master v16",
  "settings": [
    { "type": "text", "id": "promo_code", "label": "Promo Code", "default": "SHADOW31" },
    { "type": "product_list", "id": "popcorn_list", "label": "Popcorn Flavors", "limit": 6 },
    { "type": "text", "id": "tier_prices", "label": "Per Bag Prices (3,5,10)", "default": "10.00,7.50,7.00" },
    { "type": "text", "id": "tier_totals", "label": "Total Prices (3,5,10)", "default": "30.00,37.50,70.00" },
    { "type": "url", "id": "nav_1_link", "label": "Nav 1 Link" },
    { "type": "url", "id": "nav_2_link", "label": "Nav 2 Link" },
    { "type": "url", "id": "nav_3_link", "label": "Nav 3 Link" }
  ],
  "presets": [{ "name": "Groundhog Master v16" }]
}
{% endschema %}