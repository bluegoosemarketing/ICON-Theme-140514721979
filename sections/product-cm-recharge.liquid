{% comment %}
  **
  * File: sections/product-cm-recharge.liquid
  * Version: 3.0 (Two-Step Selection UI)
  * Description: Implements a two-step selection process (Product -> Variant) for a better UX.
  * Adds new user-facing dropdowns and containers for variant option buttons.
  * Hides the original select elements, which are now controlled by the JS to preserve functionality.
  **
{% endcomment %}

{% assign protein_collection = collections[section.settings.protein_collection_handle] %}
{% assign side_collection = collections[section.settings.side_collection_handle] %}

<div
  id="cm-recharge-root-{{ section.id }}"
  class="cm-recharge product product--with-sidebar product-template"
  data-section-id="{{ section.id }}"
  data-product-handle="{{ product.handle }}"
  data-bundle-product-id="{{ product.id }}"
  data-bundle-variant-id="{{ product.selected_or_first_available_variant.id }}"
  data-protein-collection-handle="{{ section.settings.protein_collection_handle }}"
  data-side-collection-handle="{{ section.settings.side_collection_handle }}"
  data-protein-collection-id="{{ protein_collection.id | default: '' }}"
  data-side-collection-id="{{ side_collection.id | default: '' }}"
>
  <div class="product-page container">
    <div class="product-page__grid">
      {% liquid
        assign hero_media = product.selected_or_first_available_variant.featured_media | default: product.featured_media
        if hero_media == blank and product.media.size > 0
          assign hero_media = product.media.first
        endif
      %}

      <!-- LEFT: Media / Hero Image -->
      <section class="product-page__media cm-recharge__media card card--soft">
        {% if hero_media %}
          {% assign hero_alt = hero_media.alt | default: product.title %}
          <div class="cm-recharge__media-frame">
            {% case hero_media.media_type %}
              {% when 'image' %}
                {% render 'responsive-image' with hero_media, class: 'cm-recharge__image', alt: hero_alt, default_size: '1024x', blur: false %}
              {% when 'external_video' %}
                <div class="cm-recharge__media-video">
                  {{ hero_media | external_video_tag: class: 'cm-recharge__external-video' }}
                </div>
              {% when 'video' %}
                <div class="cm-recharge__media-video">
                  {{ hero_media | video_tag: controls: true, playsinline: true, class: 'cm-recharge__video' }}
                </div>
              {% when 'model' %}
                <div class="cm-recharge__media-model">
                  {{ hero_media | model_viewer_tag: class: 'cm-recharge__model-viewer', reveal: 'interaction', toggleable: true, image_size: "1024x", data-model-id: hero_media.id }}
                </div>
              {% else %}
                <div class="cm-recharge__media-generic">
                  {{ hero_media | media_tag }}
                </div>
            {% endcase %}
          </div>
        {% else %}
          <div class="cm-recharge__media-placeholder">
            {{ 'product-1' | placeholder_svg_tag: 'icon--placeholder' }}
          </div>
        {% endif %}
      </section>

      <!-- RIGHT: Builder Panel -->
      <section class="product-page__details cm-recharge__panel">
        <div class="cm-recharge__intro">
          <h1 class="cm-recharge__title h2">{{ product.title | escape }}</h1>
          <div class="product-price--placeholder">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="16" y2="18"></line><line x1="12" y1="14" x2="12" y2="18"></line><line x1="8" y1="14" x2="8" y2="18"></line><line x1="8" y1="10" x2="16" y2="10"></line></svg>
            <div>
              <span class="placeholder-main-text" data-total-price>{{ 0 | money }}</span>
              <span class="placeholder-sub-text">Your total will update here.</span>
            </div>
          </div>
          {%- if product.description != blank -%}
            <div class="cm-recharge__description rte">{{ product.description }}</div>
          {%- endif -%}
        </div>

        <form class="cm-recharge__form" data-cm-form>
          <div class="form-grid">
            <!-- Protein Selection -->
            <div class="field" data-selection-group="protein">
              <label class="label" for="cm-product-protein-{{ section.id }}">Protein</label>
              <div class="select-wrapper">
                <select id="cm-product-protein-{{ section.id }}" data-product-select="protein" disabled>
                  <option value="">Loading proteins...</option>
                </select>
                <svg class="select-wrapper__arrow" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
              </div>
              <div class="variant-options" data-variant-options="protein"></div>
              <select class="visually-hidden" id="cm-protein-{{ section.id }}" name="protein" data-protein-select></select>
            </div>

            <!-- Side 1 Selection -->
            <div class="field" data-selection-group="side1">
              <label class="label" for="cm-product-side1-{{ section.id }}">Side 1</label>
              <div class="select-wrapper">
                <select id="cm-product-side1-{{ section.id }}" data-product-select="side1" disabled>
                  <option value="">Loading sides...</option>
                </select>
                <svg class="select-wrapper__arrow" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
              </div>
              <div class="variant-options" data-variant-options="side1"></div>
              <select class="visually-hidden" id="cm-side1-{{ section.id }}" name="side1" data-side1-select></select>
            </div>

            <!-- Side 2 Selection -->
            <div class="field" data-selection-group="side2">
              <label class="label" for="cm-product-side2-{{ section.id }}">Side 2</label>
              <div class="select-wrapper">
                <select id="cm-product-side2-{{ section.id }}" data-product-select="side2" disabled>
                  <option value="">Loading sides...</option>
                </select>
                <svg class="select-wrapper__arrow" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
              </div>
              <div class="variant-options" data-variant-options="side2"></div>
              <select class="visually-hidden" id="cm-side2-{{ section.id }}" name="side2" data-side2-select></select>
            </div>
            
            <!-- Frequency -->
            <div class="field">
              <label class="label" for="cm-frequency-{{ section.id }}">Delivery Frequency</label>
              <div class="select-wrapper">
                <select id="cm-frequency-{{ section.id }}" name="frequency" data-frequency-select disabled>
                   <option value="">Loading frequencies...</option>
                </select>
                <svg class="select-wrapper__arrow" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
              </div>
            </div>
          </div>

          <div class="cm-recharge__cta">
            <div class="integrated-quantity" data-quantity-wrapper>
              <button type="button" class="integrated-quantity__button" data-qty-minus aria-label="Decrease quantity">âˆ’</button>
              <input class="integrated-quantity__input" type="number" name="quantity" min="1" value="1" readonly data-qty-input>
              <button type="button" class="integrated-quantity__button" data-qty-plus aria-label="Increase quantity">+</button>
            </div>
            <button type="submit" class="product-card__add-btn" data-add-to-cart-button disabled>
              <span data-add-to-cart-text>Select Options</span>
            </button>
          </div>

          <div class="cm-recharge__error" data-error-message></div>
        </form>
      </section>
    </div>
  </div>
</div>

<script id="RechargeSellingPlans-{{ section.id }}" type="application/json">
  {{ product.selling_plan_groups | json }}
</script>

<script>
  (function loadRechargeBundleScript() {
    if (window.__iconRechargeBundleScriptRequested) return;
    if (typeof window.recharge !== 'undefined' && typeof window.recharge.bundle !== 'undefined') return;
    var existingScript = document.querySelector('script[data-icon-recharge-bundle]');
    if (existingScript) {
      window.__iconRechargeBundleScriptRequested = true;
      return;
    }
    window.__iconRechargeBundleScriptRequested = true;
    var script = document.createElement('script');
    script.src = 'https://static.rechargecdn.com/assets/bundling-widget/src/js';
    script.defer = true;
    script.referrerPolicy = 'origin';
    script.setAttribute('data-icon-recharge-bundle', 'true');
    document.head.appendChild(script);
  })();
</script>

<link rel="stylesheet" href="{{ 'cm-recharge.css' | asset_url }}">
<script src="{{ 'cm-recharge.js' | asset_url }}" defer="defer"></script>

{% schema %}
{
  "name": "Custom Meal Recharge",
  "settings": [
    {
      "type": "header",
      "content": "Collection Handles"
    },
    {
      "type": "text",
      "id": "protein_collection_handle",
      "label": "Protein Collection Handle",
      "default": "recharge-cm-proteins",
      "info": "The handle for the collection containing protein options."
    },
    {
      "type": "text",
      "id": "side_collection_handle",
      "label": "Sides Collection Handle",
      "default": "recharge-cm-sides",
      "info": "The handle for the collection containing side options."
    }
  ],
  "presets": [
    {
      "name": "Custom Meal Recharge"
    }
  ]
}
{% endschema %}