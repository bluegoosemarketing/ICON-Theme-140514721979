{% comment %}
  Custom Meal Recharge Product Template
  - Purpose: Present the "build your own" custom meal builder that integrates with Recharge bundles.
  - Notes: This template feeds the `assets/cm-recharge.js` controller which expects specific
    data attributes and markup hooks. The previous version of this file was replaced with a
    blog layout which caused Liquid pagination errors on product pages.
{% endcomment %}

{{ 'cm-recharge.css' | asset_url | stylesheet_tag }}
{{ 'cm-recharge.js' | asset_url | script_tag }}

{%- liquid
  assign display_title = product.metafields.custom.display_title | default: product.title
  assign subheading = product.metafields.custom.subtitle
  assign hero_copy = product.metafields.custom.hero_copy

  assign featured_media = product.selected_or_first_available_variant.featured_media | default: product.featured_media
  if featured_media and featured_media.preview_image
    assign hero_image = featured_media.preview_image
  else
    assign hero_image = featured_media
  endif
  if hero_image == blank
    assign hero_image = product.featured_image
  endif

  assign price_placeholder = product.selected_or_first_available_variant.price | default: product.price

  assign bundle_product_id = product.metafields.bundle.bundle_product_id | default: product.metafields.custom.bundle_product_id | default: section.settings.bundle_product_id
  assign bundle_variant_id = product.metafields.bundle.bundle_variant_id | default: product.metafields.custom.bundle_variant_id | default: section.settings.bundle_variant_id
  assign protein_collection_handle = product.metafields.bundle.protein_collection_handle | default: product.metafields.custom.protein_collection_handle | default: section.settings.protein_collection_handle
  assign side_collection_handle = product.metafields.bundle.side_collection_handle | default: product.metafields.custom.side_collection_handle | default: section.settings.side_collection_handle
  assign protein_collection_id = product.metafields.bundle.protein_collection_id | default: product.metafields.custom.protein_collection_id | default: section.settings.protein_collection_id
  assign side_collection_id = product.metafields.bundle.side_collection_id | default: product.metafields.custom.side_collection_id | default: section.settings.side_collection_id

  assign protein_heading = section.settings.protein_heading | default: 'Choose your protein'
  assign side1_heading = section.settings.side1_heading | default: 'Pick your first side'
  assign side2_heading = section.settings.side2_heading | default: 'Pick an optional second side'
  assign frequency_heading = section.settings.frequency_heading | default: 'Delivery frequency'
  assign quantity_heading = section.settings.quantity_heading | default: 'Quantity'
  assign add_to_cart_label = section.settings.add_to_cart_label | default: 'Add to Cart'

  assign selling_plan_json = product.selling_plan_groups | json
-%}

<section id="product-cm-recharge" class="section section--cm-recharge">
  <div class="page-width">
    <div
      class="cm-recharge cm-recharge__main container"
      data-section-id="{{ section.id }}"
      data-product-handle="{{ product.handle }}"
      data-bundle-product-id="{{ bundle_product_id | default: '' }}"
      data-bundle-variant-id="{{ bundle_variant_id | default: '' }}"
      data-protein-collection-handle="{{ protein_collection_handle | default: '' }}"
      data-side-collection-handle="{{ side_collection_handle | default: '' }}"
      data-protein-collection-id="{{ protein_collection_id | default: '' }}"
      data-side-collection-id="{{ side_collection_id | default: '' }}"
    >
      <div class="cm-recharge__layout product-main__layout">
        <div class="cm-recharge__panel">
          <header class="cm-recharge__intro">
            <p class="product__vendor" aria-hidden="true">{{ product.vendor }}</p>
            <h1 class="h2">{{ display_title }}</h1>
            <div class="product-price product-price--placeholder" aria-live="polite">
              <span data-total-price>{{ price_placeholder | money }}</span>
            </div>
            {% if subheading != blank %}
              <p class="cm-recharge__subheading">{{ subheading }}</p>
            {% endif %}
            {% if hero_copy != blank %}
              <p class="cm-recharge__hook">{{ hero_copy }}</p>
            {% endif %}
          </header>

          <form class="cm-recharge__form" data-cm-form>
            <fieldset class="cm-selection-step" data-selection-group="protein">
              <legend class="cm-step__legend"><span>1</span>{{ protein_heading }}</legend>
              <div class="cm-visual-options" data-visual-options-for="protein"></div>
              <label class="visually-hidden" for="ProteinProduct-{{ section.id }}">{{ protein_heading }}</label>
              <select id="ProteinProduct-{{ section.id }}" data-product-select="protein" disabled>
                <option value="">Loading proteins…</option>
              </select>
              <div class="variant-options" aria-live="polite"></div>
              <select class="visually-hidden" data-protein-select aria-hidden="true"></select>
            </fieldset>

            <fieldset class="cm-selection-step" data-selection-group="side1">
              <legend class="cm-step__legend"><span>2</span>{{ side1_heading }}</legend>
              <div class="cm-visual-options" data-visual-options-for="side1"></div>
              <label class="visually-hidden" for="Side1Product-{{ section.id }}">{{ side1_heading }}</label>
              <select id="Side1Product-{{ section.id }}" data-product-select="side1" disabled>
                <option value="">Loading sides…</option>
              </select>
              <div class="variant-options" aria-live="polite"></div>
              <select class="visually-hidden" data-side1-select aria-hidden="true"></select>
            </fieldset>

            <fieldset class="cm-selection-step" data-selection-group="side2">
              <legend class="cm-step__legend"><span>3</span>{{ side2_heading }}<small>(optional)</small></legend>
              <div class="cm-visual-options" data-visual-options-for="side2"></div>
              <label class="visually-hidden" for="Side2Product-{{ section.id }}">{{ side2_heading }}</label>
              <select id="Side2Product-{{ section.id }}" data-product-select="side2" disabled>
                <option value="">Add another side…</option>
              </select>
              <div class="variant-options" aria-live="polite"></div>
              <select class="visually-hidden" data-side2-select aria-hidden="true"></select>
            </fieldset>

            <div class="cm-selection-step">
              <label class="cm-step__label" for="Frequency-{{ section.id }}">{{ frequency_heading }}</label>
              <select id="Frequency-{{ section.id }}" data-frequency-select disabled>
                <option value="">One-time purchase</option>
              </select>
            </div>

            <div class="cm-recharge__cta">
              <div class="integrated-quantity">
                <button type="button" class="integrated-quantity__button" data-qty-minus aria-label="Decrease quantity">−</button>
                <input type="number" class="integrated-quantity__input" value="1" min="1" data-qty-input aria-live="polite" aria-label="{{ quantity_heading }}">
                <button type="button" class="integrated-quantity__button" data-qty-plus aria-label="Increase quantity">+</button>
              </div>
              <button type="submit" class="btn btn--primary product-card__add-btn" data-add-to-cart-button>
                <span data-add-to-cart-text>{{ add_to_cart_label }}</span>
              </button>
            </div>

            <p class="cm-recharge__error" data-error-message role="alert"></p>
          </form>

          {% if product.description != blank %}
            <div class="cm-recharge__description rte">{{ product.description }}</div>
          {% endif %}
        </div>

        <aside class="cm-recharge__visuals">
          <div class="cm-recharge__media">
            {% if hero_image %}
              <div class="cm-recharge__media-frame">
                {% render 'responsive-image' with hero_image, class: 'cm-recharge__image', alt: display_title %}
              </div>
            {% else %}
              <div class="cm-recharge__media-placeholder">
                {{ 'product-1' | placeholder_svg_tag: 'cm-recharge__media-generic' }}
              </div>
            {% endif %}
          </div>

          {% if section.settings.show_macros %}
            <div class="cm-recharge__macros">
              {% render 'product-macros', product: product %}
            </div>
          {% endif %}
        </aside>
      </div>

      <script type="application/json" id="RechargeSellingPlans-{{ section.id }}">{{ selling_plan_json | default: '[]' }}</script>
      <script type="application/json" data-product-json>{{ product | json }}</script>
    </div>
  </div>
</section>

{% schema %}
{
  "name": "Custom meal (Recharge)",
  "settings": [
    {
      "type": "header",
      "content": "Recharge bundle configuration"
    },
    {
      "type": "text",
      "id": "bundle_product_id",
      "label": "Bundle product ID",
      "info": "Numeric product ID used for the Recharge dynamic bundle."
    },
    {
      "type": "text",
      "id": "bundle_variant_id",
      "label": "Bundle variant ID",
      "info": "Variant ID associated with the bundle product."
    },
    {
      "type": "text",
      "id": "protein_collection_handle",
      "label": "Protein collection handle"
    },
    {
      "type": "text",
      "id": "protein_collection_id",
      "label": "Protein collection ID"
    },
    {
      "type": "text",
      "id": "side_collection_handle",
      "label": "Side collection handle"
    },
    {
      "type": "text",
      "id": "side_collection_id",
      "label": "Side collection ID"
    },
    {
      "type": "header",
      "content": "UI copy"
    },
    {
      "type": "text",
      "id": "protein_heading",
      "label": "Protein step heading",
      "default": "Choose your protein"
    },
    {
      "type": "text",
      "id": "side1_heading",
      "label": "Side 1 step heading",
      "default": "Pick your first side"
    },
    {
      "type": "text",
      "id": "side2_heading",
      "label": "Side 2 step heading",
      "default": "Pick an optional second side"
    },
    {
      "type": "text",
      "id": "frequency_heading",
      "label": "Frequency label",
      "default": "Delivery frequency"
    },
    {
      "type": "text",
      "id": "quantity_heading",
      "label": "Quantity label",
      "default": "Quantity"
    },
    {
      "type": "text",
      "id": "add_to_cart_label",
      "label": "Add to cart label",
      "default": "Add to Cart"
    },
    {
      "type": "checkbox",
      "id": "show_macros",
      "label": "Show macro snapshot",
      "default": true
    }
  ]
}
{% endschema %}
