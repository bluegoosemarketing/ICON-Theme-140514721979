{% comment %}
  **
  * File: sections/product-cm-recharge.liquid
  * Version: 8.0 (Final & Complete)
  * Description: All features implemented and bugs fixed.
  * - FIX: Updated the initial price sub-text to be more instructive for the user.
  **
{% endcomment %}

{% assign protein_collection = collections[section.settings.protein_collection_handle] %}
{% assign side_collection = collections[section.settings.side_collection_handle] %}

<div
  id="cm-recharge-root-{{ section.id }}"
  class="cm-recharge product product-template"
  data-section-id="{{ section.id }}"
  data-product-handle="{{ product.handle }}"
  data-bundle-product-id="{{ product.id }}"
  data-bundle-variant-id="{{ product.selected_or_first_available_variant.id }}"
  data-base-fee-cents="{{ product.selected_or_first_available_variant.price }}"
  data-protein-collection-handle="{{ section.settings.protein_collection_handle }}"
  data-side-collection-handle="{{ section.settings.side_collection_handle }}"
  data-protein-collection-id="{{ protein_collection.id | default: '' }}"
  data-side-collection-id="{{ side_collection.id | default: '' }}"
>
  <div class="cm-recharge__inner pad-safe-bottom">
    <div class="cm-recharge__main container">
      <div class="cm-recharge__layout">
        {% liquid
          assign hero_media = product.selected_or_first_available_variant.featured_media | default: product.featured_media
          if hero_media == blank and product.media.size > 0
            assign hero_media = product.media.first
          endif
        %}

        <!-- LEFT COLUMN (Visuals) -->
        <div class="cm-recharge__visuals">
          <section class="cm-recharge__media card card--soft">
            {% if hero_media %}
              {% assign hero_alt = hero_media.alt | default: product.title %}
              <div class="cm-recharge__media-frame">
                {% case hero_media.media_type %}
                  {% when 'image' %}
                    {% render 'responsive-image' with hero_media, class: 'cm-recharge__image', alt: hero_alt, default_size: '1024x', blur: false %}
                  {% else %}
                    <div class="cm-recharge__media-generic">
                      {{ hero_media | media_tag }}
                    </div>
                {% endcase %}
              </div>
            {% else %}
              <div class="cm-recharge__media-placeholder">
                {{ 'product-1' | placeholder_svg_tag: 'icon--placeholder' }}
              </div>
            {% endif %}
          </section>
          <div class="cm-recharge__nutrition-shell" data-desktop-nutrition-slot>
            <div
              id="nutrition-container-v2"
              class="cm-recharge-macro-container nutrition-container-v8"
              data-nutrition-block
            ></div>
          </div>
        </div>

        <!-- RIGHT COLUMN (Panel) -->
        <section class="cm-recharge__panel">
          <div class="cm-recharge__intro">
            <h1 class="cm-recharge__title h2">{{ product.title | escape }}</h1>
            <div class="product-price--placeholder" data-price-wrapper>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="16" y2="18"></line><line x1="12" y1="14" x2="12" y2="18"></line><line x1="8" y1="14" x2="8" y2="18"></line><line x1="8" y1="10" x2="16" y2="10"></line></svg>
              <div>
                <span class="placeholder-main-text" data-total-price>{{ 0 | money }}</span>
                <!-- MODIFIED: More instructive initial text -->
                <span class="placeholder-sub-text" data-price-sub-text>Select a Protein & Side to see price</span>
              </div>
            </div>
            {%- if product.description != blank -%}
              <div class="cm-recharge__description rte">{{ product.description }}</div>
            {%- endif -%}
          </div>

          <form class="cm-recharge__form" data-cm-form>
            <fieldset class="cm-selection-step is-open" data-collapsible-step data-selection-group="protein">
              <legend class="cm-step__legend" data-collapsible-toggle><div class="cm-step__legend-main"><span>1</span><div class="cm-step__legend-text">Choose Protein<span class="cm-step__selection-summary" data-selection-summary></span></div></div><svg class="cm-step__chevron" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg></legend>
              <div class="cm-step__collapsible-content"><div class="cm-step__content"><div class="select-wrapper visually-hidden"><select id="cm-product-protein-{{ section.id }}" data-product-select="protein" disabled><option value="">Loading...</option></select></div><div class="cm-visual-options" data-visual-options-for="protein"></div><div class="variant-options" data-variant-options-for="protein"></div><select class="visually-hidden" id="cm-protein-{{ section.id }}" name="protein" data-protein-select></select></div></div>
            </fieldset>
            <fieldset class="cm-selection-step" data-collapsible-step data-selection-group="side1">
              <legend class="cm-step__legend" data-collapsible-toggle><div class="cm-step__legend-main"><span>2</span><div class="cm-step__legend-text">Choose Side 1<span class="cm-step__selection-summary" data-selection-summary></span></div></div><svg class="cm-step__chevron" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg></legend>
              <div class="cm-step__collapsible-content"><div class="cm-step__content"><div class="select-wrapper visually-hidden"><select id="cm-product-side1-{{ section.id }}" data-product-select="side1" disabled><option value="">Loading...</option></select></div><div class="cm-visual-options" data-visual-options-for="side1"></div><div class="variant-options" data-variant-options-for="side1"></div><select class="visually-hidden" id="cm-side1-{{ section.id }}" name="side1" data-side1-select></select></div></div>
            </fieldset>
            <fieldset class="cm-selection-step" data-collapsible-step data-selection-group="side2">
              <legend class="cm-step__legend" data-collapsible-toggle><div class="cm-step__legend-main"><span>3</span><div class="cm-step__legend-text">Choose Side 2 <small>(Optional)</small><span class="cm-step__selection-summary" data-selection-summary></span></div></div><svg class="cm-step__chevron" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg></legend>
              <div class="cm-step__collapsible-content"><div class="cm-step__content"><div class="select-wrapper visually-hidden"><select id="cm-product-side2-{{ section.id }}" data-product-select="side2" disabled><option value="">Loading...</option></select></div><div class="cm-visual-options" data-visual-options-for="side2"></div><div class="variant-options" data-variant-options-for="side2"></div><select class="visually-hidden" id="cm-side2-{{ section.id }}" name="side2" data-side2-select></select></div></div>
            </fieldset>

            <div class="cm-recharge__nutrition-shell cm-recharge__nutrition-shell--mobile" data-mobile-nutrition-slot></div>

            <div class="cm-selection-step--standalone">
              <label class="cm-step__label" for="cm-frequency-{{ section.id }}">Delivery Frequency</label>
              <div class="select-wrapper">
                <select id="cm-frequency-{{ section.id }}" name="frequency" data-frequency-select disabled><option value="">Loading frequencies...</option></select>
                <svg class="select-wrapper__arrow" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
              </div>
            </div>

            <div class="cm-recharge__cta">
              <div class="integrated-quantity" data-quantity-wrapper>
                <button type="button" class="integrated-quantity__button" data-qty-minus aria-label="Decrease quantity">âˆ’</button>
                <span class="integrated-quantity__text" data-qty-text>1</span>
                <input class="integrated-quantity__input" type="number" name="quantity" min="1" value="1" data-qty-input>
                <button type="button" class="integrated-quantity__button" data-qty-plus aria-label="Increase quantity">+</button>
              </div>
              <button type="submit" class="product-card__add-btn" data-add-to-cart-button disabled>
                <span data-add-to-cart-text>Select Options</span>
              </button>
            </div>

            <div class="cm-recharge__error" data-error-message></div>
          </form>
        </section>
      </div>
    </div>

    <div class="cm-recharge__footer">
      {% render 'footer-minimal-ordering' %}
    </div>
  </div>
</div>

<script id="RechargeSellingPlans-{{ section.id }}" type="application/json">
  {{ product.selling_plan_groups | json }}
</script>

<script>
  (function loadRechargeBundleScript() { if (window.__iconRechargeBundleScriptRequested) return; if (typeof window.recharge !== 'undefined' && typeof window.recharge.bundle !== 'undefined') return; var existingScript = document.querySelector('script[data-icon-recharge-bundle]'); if (existingScript) { window.__iconRechargeBundleScriptRequested = true; return; } window.__iconRechargeBundleScriptRequested = true; var script = document.createElement('script'); script.src = 'https://static.rechargecdn.com/assets/bundling-widget/src/js'; script.defer = true; script.referrerPolicy = 'origin'; script.setAttribute('data-icon-recharge-bundle', 'true'); document.head.appendChild(script); })();
</script>

<script>
  (function() { const setHeaderOffsets = function() { const header = document.querySelector('#shopify-section-header-collections') || document.querySelector('#shopify-section-header'); if (!header) return; var height = header.getBoundingClientRect().height; document.documentElement.style.setProperty('--app-header-min-height', height + 'px'); document.documentElement.style.setProperty('--header-offset', height + 'px'); document.documentElement.style.setProperty('--dynamic-header-h', height + 'px'); }; const registerListeners = function() { if (!window.__cmRechargeHeaderOffsetListenersRegistered) { window.__cmRechargeHeaderOffsetListenersRegistered = true; window.addEventListener('resize', setHeaderOffsets); document.addEventListener('shopify:section:load', setHeaderOffsets); document.addEventListener('shopify:section:reorder', setHeaderOffsets); } setHeaderOffsets(); }; if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', registerListeners); } else { registerListeners(); } })();
</script>

<link rel="stylesheet" href="{{ 'cm-recharge.css' | asset_url }}">
<script src="{{ 'cm-recharge.js' | asset_url }}" defer="defer"></script>

{% schema %}
{
  "name": "Custom Meal Recharge",
  "settings": [
    { "type": "header", "content": "Collection Handles" },
    { "type": "text", "id": "protein_collection_handle", "label": "Protein Collection Handle", "default": "recharge-cm-proteins" },
    { "type": "text", "id": "side_collection_handle", "label": "Sides Collection Handle", "default": "recharge-cm-sides" }
  ],
  "presets": [ { "name": "Custom Meal Recharge" } ]
}
{% endschema %}