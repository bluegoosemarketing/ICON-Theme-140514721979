{%- comment -%}
  ==========================================================================
  REVISION: V27 - BUNDLE UNIT DISPLAY FIX
  - MODIFIED: The Recharge Custom Meal (rc_bundle) rendering logic has
    been completely rewritten to support variable units (oz, c, ea, sl).
  - REMOVED: The old logic that manually parsed variant titles and
    hard-coded "oz" has been removed.
  - ADDED: The template now first finds the parent bundle line item, which
    contains new structured properties (e.g., `_rc_cm_protein_name`,
    `_rc_cm_protein_qty`, `_rc_cm_protein_unit`) set by `cm-recharge.js`.
  - ADDED: A new rendering loop iterates through the components (protein,
    side_1, side_2) and displays them using this structured data, ensuring
    the correct quantity and unit are always shown.
  - ADDED: A fallback to the old rendering logic is included to gracefully
    handle any custom meals that were added to a cart before this update.
  ==========================================================================
{%- endcomment -%}
{%- liquid
  assign class_prefix = 'cart-sidebar'
  if context == 'drawer'
    assign class_prefix = 'cart-drawer'
  endif
  assign rc_processed_bundles = '|'  
-%}

<div class="{{ class_prefix }}__content">
  {% if cart.item_count > 0 %}
    <ul class="{{ class_prefix }}__items cart-items" aria-label="Cart items">

      {% for item in cart.items %}
        {%- assign rc_bundle_id = item.properties._rc_bundle -%}
        {%- if rc_bundle_id != blank -%}
          {%- assign rc_bundle_token = '|' | append: rc_bundle_id | append: '|' -%}
          {%- if rc_processed_bundles contains rc_bundle_token -%}
            {% continue %}
          {%- endif -%}

          {%- assign rc_bundle_handle = item.properties._rc_bundle_parent -%}
          {%- assign rc_bundle_variant_id = item.properties._rc_bundle_variant | plus: 0 -%}
          {%- assign rc_bundle_product = all_products[rc_bundle_handle] -%}
          {%- assign rc_bundle_variant = nil -%}
          {%- assign rc_bundle_price = 0 -%}
          {%- assign rc_bundle_original_total = 0 -%}
          {%- assign rc_bundle_compare_total = 0 -%}
          {%- assign rc_bundle_remove_parts = '' -%}
          {%- assign rc_bundle_subscription_name = '' -%}
          {%- assign rc_bundle_subscription_frequency = '' -%}
          {%- assign rc_bundle_primary_key = item.key -%}
          {%- assign rc_bundle_parent_props = '' -%}
          
          {%- for sib in cart.items -%}
            {%- if sib.properties._rc_bundle == rc_bundle_id -%}
              {%- assign rc_bundle_price = rc_bundle_price | plus: sib.final_line_price -%}
              {%- assign rc_bundle_original_total = rc_bundle_original_total | plus: sib.original_line_price -%}
              
              {%- assign compare_each = inner_item.selling_plan_allocation.compare_at_price | default: 0 -%}
              {%- assign compare_total = compare_each | times: inner_item.quantity -%}
              {%- assign rc_bundle_compare_total = rc_bundle_compare_total | plus: compare_total -%}

              {%- assign rc_bundle_remove_parts = rc_bundle_remove_parts | append: '&updates[' | append: sib.key | append: ']=0' -%}

              {%- comment %} Check if this sibling is the designated parent line item to get its properties and subscription info {% endcomment %}
              {%- if sib.product.handle == rc_bundle_handle and sib.variant.id == rc_bundle_variant_id -%}
                {%- assign rc_bundle_parent_props = sib.properties -%}
                {%- if sib.selling_plan_allocation -%}
                  {%- assign parent_sp = sib.selling_plan_allocation.selling_plan -%}
                  {%- if parent_sp and rc_bundle_subscription_name == '' -%}{%- assign rc_bundle_subscription_name = parent_sp.name -%}{%- endif -%}
                  
                  {%- assign freq = '' -%}
                  {%- if parent_sp.delivery_policy -%}
                    {%- assign ic = parent_sp.delivery_policy.interval_count -%}
                    {%- assign iu = parent_sp.delivery_policy.interval | replace: '_',' ' | strip | capitalize -%}
                    {%- if ic and iu != '' -%}{%- assign freq = ic | append: ' ' | append: iu | append: 's' -%}{%- endif -%}
                  {%- endif -%}
                  {%- if rc_bundle_subscription_frequency == '' and freq != '' -%}{%- assign rc_bundle_subscription_frequency = freq -%}{%- endif -%}
                {%- endif -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {%- comment -%} END: REWRITTEN BUNDLE DATA AGGREGATION {%- endcomment -%}

          {%- assign rc_bundle_remove_query = rc_bundle_remove_parts | remove_first: '&' -%}
          {%- if rc_bundle_remove_query != '' -%}
            {%- assign rc_bundle_remove_url = '/cart/update?' | append: rc_bundle_remove_query -%}
          {%- else -%}
            {%- assign rc_bundle_remove_url = routes.cart_url -%}
          {%- endif -%}
          {%- if rc_bundle_compare_total == 0 -%}
            {%- assign rc_bundle_compare_total = rc_bundle_original_total -%}
          {%- endif -%}
          
          {%- assign rc_bundle_variant = nil -%}
          {%- if rc_bundle_product and rc_bundle_variant_id > 0 -%}
            {%- for variant in rc_bundle_product.variants -%}
              {%- if variant.id == rc_bundle_variant_id -%}
                {%- assign rc_bundle_variant = variant -%}
                {%- break -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endif -%}
          
          {%- assign has_new_props = false -%}
          {%- assign component_keys = 'protein,side_1,side_2' | split: ',' -%}
          {%- for comp in component_keys -%}
            {%- assign comp_name_key = '_rc_cm_' | append: comp | append: '_name' -%}
            {%- if rc_bundle_parent_props[comp_name_key] != blank -%}
              {%- assign has_new_props = true -%}
              {%- break -%}
            {%- endif -%}
          {%- endfor -%}

          {%- if rc_bundle_primary_key == '' -%}
            {%- assign rc_bundle_primary_key = item.key -%}
          {%- endif -%}

          <li
            class="{{ class_prefix }}__item {{ class_prefix }}__item--bundle"
            data-line-key="{{ rc_bundle_primary_key }}"
            data-rc-bundle-id="{{ rc_bundle_id }}"
          >
            <div class="{{ class_prefix }}__item-image">
              {%- if rc_bundle_product and rc_bundle_product.featured_image -%}
                <a href="{{ rc_bundle_product.url }}" tabindex="-1">
                  <img
                    src="{{ rc_bundle_product.featured_image | img_url: '200x' }}"
                    alt="{{ rc_bundle_product.title | escape }}"
                    loading="lazy"
                    width="72"
                    height="72"
                  >
                </a>
              {%- else -%}
                <span class="{{ class_prefix }}__item-placeholder" aria-hidden="true"></span>
              {%- endif -%}
            </div>
            <div class="{{ class_prefix }}__item-details">
              <a
                href="{{ rc_bundle_product.url | default: item.url }}"
                class="{{ class_prefix }}__item-title"
                title="{{ rc_bundle_product.title | default: item.product.title }}"
              >
                {{ rc_bundle_product.title | default: item.product.title }}
              </a>

              <div class="{{ class_prefix }}__item-meta">
                <div class="{{ class_prefix }}__item-top-row">
                  <div class="{{ class_prefix }}__item-actions">
                    <div class="{{ class_prefix }}__quantity-selector">
                      <button type="button" class="{{ class_prefix }}__quantity-btn" data-action="minus" data-line-key="{{ rc_bundle_primary_key }}" data-associated="bundle" aria-label="Decrease quantity">－</button>
                      <input
                        type="text"
                        class="{{ class_prefix }}__quantity-value"
                        value="{{ item.quantity }}"
                        readonly
                        inputmode="numeric"
                        aria-label="Quantity"
                      >
                      <button type="button" class="{{ class_prefix }}__quantity-btn" data-action="plus" data-line-key="{{ rc_bundle_primary_key }}" data-associated="bundle" aria-label="Increase quantity">＋</button>
                    </div>
                  </div>
                  <div class="{{ class_prefix }}__item-price-wrapper">
                    {%- if rc_bundle_compare_total > rc_bundle_price and rc_bundle_compare_total > 0 -%}
                      <span class="{{ class_prefix }}__item-price--final money">{{ rc_bundle_price | money }}</span>
                      <del class="{{ class_prefix }}__item-price--original money">{{ rc_bundle_compare_total | money }}</del>
                    {%- else -%}
                      <span class="{{ class_prefix }}__item-price money">{{ rc_bundle_price | money }}</span>
                    {%- endif -%}
                  </div>
                </div>

                {%- if rc_bundle_subscription_name != '' or rc_bundle_subscription_frequency != '' -%}
                  <div class="{{ class_prefix }}__subscription-info">
                    <svg class="{{ class_prefix }}__subscription-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0114.83-3.36L23 10"></path><path d="M20.49 15A9 9 0 015.67 18.36L1 14"></path></svg>
                    <span>
                      {%- if rc_bundle_subscription_frequency != '' -%}
                        Renews every {{ rc_bundle_subscription_frequency }}
                      {%- else -%}
                        {{ rc_bundle_subscription_name }}
                      {%- endif -%}
                    </span>
                  </div>
                {%- endif -%}

                <ul class="{{ class_prefix }}__properties {{ class_prefix }}__properties--custom">
                  {%- if has_new_props -%}
                    {%- comment -%} NEW LOGIC: Read structured properties from parent line item {%- endcomment -%}
                    {%- assign components = 'protein,side_1,side_2' | split: ',' -%}
                    {%- for comp in components -%}
                        {%- assign name_key = '_rc_cm_' | append: comp | append: '_name' -%}
                        {%- assign qty_key = '_rc_cm_' | append: comp | append: '_qty' -%}
                        {%- assign unit_key = '_rc_cm_' | append: comp | append: '_unit' -%}
                        {%- assign name = rc_bundle_parent_props[name_key] -%}

                        {%- if name != blank -%}
                            {%- assign qty = rc_bundle_parent_props[qty_key] -%}
                            {%- assign unit = rc_bundle_parent_props[unit_key] -%}
                            <li class="{{ class_prefix }}__property">
                              <span class="ingredient-line {{ class_prefix }}__property-value">
                                <span class="ingredient-qty">{{ qty }}{{ unit }}</span>
                                <span class="ingredient-name">{{ name }}</span>
                              </span>
                            </li>
                        {%- endif -%}
                    {%- endfor -%}
                  {%- else -%}
                      {%- comment -%} FALLBACK LOGIC: For items added before the JS update {%- endcomment -%}
                      {%- if rc_bundle_contents_list.size > 0 and rc_bundle_contents_list[0] != '' -%}
                        {%- for label in rc_bundle_contents_list -%}
                          {%- assign parts = label | split: 'oz ' -%}
                          {%- assign oz  = parts[0] -%}
                          {%- assign name = parts[1] -%}
                          <li class="{{ class_prefix }}__property">
                            <span class="ingredient-line {{ class_prefix }}__property-value">
                              <span class="ingredient-qty">{{ oz }}oz</span>
                              <span class="ingredient-name">{{ name }}</span>
                            </span>
                          </li>
                        {%- endfor -%}
                      {%- endif -%}
                  {%- endif -%}
                </ul>
              </div>

            </div>
            <button type="button" class="{{ class_prefix }}__remove-btn" data-action="remove" aria-label="Remove item">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor" aria-hidden="true">
                <path d="M17 12C17 11.4477 16.5523 11 16 11H8C7.44772 11 7 11.4477 7 12C7 12.5523 7.44771 13 8 13H16C16.5523 13 17 12.5523 17 12Z"></path>
                <path fill-rule="evenodd" clip-rule="evenodd" d="M12 23C18.0751 23 23 18.0751 23 12C23 5.92487 18.0751 1 12 1C5.92487 1 1 5.92487 1 12C1 18.0751 5.92487 23 12 23ZM12 20.9932C7.03321 20.9932 3.00683 16.9668 3.00683 12C3.00683 7.03321 7.03321 3.00683 12 3.00683C16.9668 3.00683 20.9932 7.03321 20.9932 12C20.9932 16.9668 16.9668 20.9932 12 20.9932Z"></path>
              </svg>
            </button>
          </li>

          {%- assign rc_processed_bundles = rc_processed_bundles | append: rc_bundle_id | append: '|' -%}
          {% continue %}
        {%- endif -%}

        {%- if item.product.type == 'OPTIONS_HIDDEN_PRODUCT' -%}
          {%- assign builder_id = item.properties._boldBuilderId | default: item.properties.builder_id -%}
          <div data-builder-id="{{ builder_id }}" data-bold-builder-id="{{ builder_id }}" style="display:none">
            <input type="hidden" class="cart-item-quantity" name="updates[]" value="{{ item.quantity }}" data-line-key="{{ item.key }}" data-builder-id="{{ builder_id }}" data-bold-builder-id="{{ builder_id }}">
          </div>
          {% continue %}
        {%- endif -%}

        {%- liquid
          assign is_custom_meal = false
          assign builder_id = item.properties._boldBuilderId | default: item.properties.builder_id
          if builder_id != blank or item.product.handle == 'custom-meals' or item.product.handle == 'custom-breakfast' or item.product.type == 'CUSTOM MEALS' or item.product.type == 'CUSTOM BREAKFAST'
            assign is_custom_meal = true
          endif

          assign product_type_lower = item.product.type | downcase
          assign is_meal_plan = false
          if product_type_lower contains 'meal plan' or item.product.handle contains 'meal-plan'
            assign is_meal_plan = true
          endif
          assign included_meals = nil
          if is_meal_plan
            assign included_meals = item.product.metafields.custom.included_meals.value | default: item.product.metafields.custom.meal_plan_products.value
          endif

          assign subscription_frequency = ''
          if item.selling_plan_allocation
            assign sp = item.selling_plan_allocation.selling_plan
            assign opt = sp.options | first
            assign opt_val = ''
            if opt and opt.value
              assign opt_val = opt.value | strip
            endif

            assign opt_is_numeric = opt_val | remove: '0' | remove: '1' | remove: '2' | remove: '3' | remove: '4' | remove: '5' | remove: '6' | remove: '7' | remove: '8' | remove: '9'
            if opt_val != '' and opt_is_numeric != ''
              assign subscription_frequency = opt_val
            else
              assign name_down = sp.name | downcase
              if name_down contains 'every '
                assign after = name_down | split: 'every ' | last
                assign parts = after | split: ' '
                if parts.size >= 2
                  assign ic = parts[0] | strip
                  assign iu = parts[1] | strip
                  assign iu_title = iu | replace: 'weeks','Week' | replace: 'week','Week' | replace: 'months','Month' | replace: 'month','Month' | replace: 'days','Day' | replace: 'day','Day'
                  assign subscription_frequency = ic | append: ' ' | append: iu_title | append: '(s)'
                endif
              elsif sp.delivery_policy
                assign ic = sp.delivery_policy.interval_count
                assign iu = sp.delivery_policy.interval | replace: '_',' ' | strip
                if ic and iu
                  assign iu_title = iu | capitalize
                  assign subscription_frequency = ic | append: ' ' | append: iu_title | append: '(s)'
                endif
              endif
            endif
          endif

          assign final_line_price = item.final_line_price
          assign original_line_price = item.original_line_price | default: item.final_line_price
          assign is_bogo_gift = item.properties._bogo_gift

          if is_custom_meal
            for hidden_item in cart.items
              assign hidden_item_builder_id = hidden_item.properties._boldBuilderId | default: hidden_item.properties.builder_id
              if hidden_item.product.type == 'OPTIONS_HIDDEN_PRODUCT' and hidden_item_builder_id == builder_id
                assign final_line_price = final_line_price | plus: hidden_item.final_line_price
                assign hidden_original_price = hidden_item.original_line_price | default: hidden_item.final_line_price
                assign original_line_price = original_line_price | plus: hidden_original_price
              endif
            endfor
          endif
        -%}

        <li class="{{ class_prefix }}__item" data-line-key="{{ item.key }}"{% if builder_id %} data-builder-id="{{ builder_id }}" data-bold-builder-id="{{ builder_id }}"{% endif %}>
          <div class="{{ class_prefix }}__item-image">
            <a href="{{ item.url }}" tabindex="-1">
              <img src="{{ item.image | img_url: '200x' }}" alt="{{ item.image.alt | escape }}" loading="lazy" width="72" height="72">
            </a>
          </div>
          <div class="{{ class_prefix }}__item-details">
            <a href="{{ item.url }}" class="{{ class_prefix }}__item-title" title="{{ item.product.title }}">{{ item.product.title }}</a>

            <div class="{{ class_prefix }}__item-meta">
              <div class="{{ class_prefix }}__item-top-row">
                <div class="{{ class_prefix }}__item-actions">
                  <div class="{{ class_prefix }}__quantity-selector{% if is_bogo_gift %} {{ class_prefix }}__quantity-selector--static{% endif %}">
                    <button
                      type="button"
                      class="{{ class_prefix }}__quantity-btn"
                      data-action="minus"
                      aria-label="Decrease quantity"
                      {% if is_bogo_gift %}disabled aria-disabled="true"{% endif %}
                    >－</button>
                    <input
                      type="number"
                      class="{{ class_prefix }}__quantity-value"
                      value="{{ item.quantity }}"
                      min="0"
                      inputmode="numeric"
                      aria-label="Quantity"
                      {% if is_bogo_gift %}readonly disabled{% endif %}
                    >
                    <button
                      type="button"
                      class="{{ class_prefix }}__quantity-btn"
                      data-action="plus"
                      aria-label="Increase quantity"
                      {% if is_bogo_gift %}disabled aria-disabled="true"{% endif %}
                    >＋</button>
                  </div>
                </div>
                <div class="{{ class_prefix }}__item-price-wrapper">
                  {%- if final_line_price < original_line_price -%}
                    <span class="{{ class_prefix }}__item-price--final money">{{ final_line_price | money }}</span>
                    <del class="{{ class_prefix }}__item-price--original money">{{ original_line_price | money }}</del>
                  {%- else -%}
                    <span class="{{ class_prefix }}__item-price money">{{ final_line_price | money }}</span>
                  {%- endif -%}
                </div>
              </div>

              {%- if item.line_level_discounts.size > 0 -%}
                <ul class="{{ class_prefix }}__item-discounts" aria-label="Discounts">
                  {%- for discount in item.line_level_discounts -%}
                    <li class="{{ class_prefix }}__item-discount">
                      <span class="discount-badge">
                        <svg aria-hidden="true" focusable="false" role="presentation" class="icon icon-discount" viewBox="0 0 12 12"><path fill-rule="evenodd" clip-rule="evenodd" d="M7 0h3a2 2 0 012 2v3a1 1 0 01-.29.71l-4 4a1 1 0 01-1.42 0l-3-3a1 1 0 010-1.42l4-4A1 1 0 017 0zm2 2a1 1 0 100 2 1 1 0 000-2z" fill="currentColor"></path></svg>
                        {{ discount.title }}
                      </span>
                    </li>
                  {%- endfor -%}
                </ul>
              {%- endif -%}
            </div>

            {% if subscription_frequency != '' %}
              <div class="{{ class_prefix }}__subscription-info">
                <svg class="{{ class_prefix }}__subscription-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0114.83-3.36L23 10"></path><path d="M20.49 15A9 9 0 015.67 18.36L1 14"></path></svg>
                <span>Renews every {{ subscription_frequency }}</span>
              </div>
            {% endif %}

            {%- if is_meal_plan and included_meals != blank -%}
              {%- assign num_meal_types = included_meals | map: 'title' | compact | size -%}
              {%- if num_meal_types > 0 -%}
                {%- comment -%} Robust meal-count parse from option1 (fallback to title) {%- endcomment -%}
                {%- assign variant_string = item.variant.option1 | default: item.variant.title -%}
                {%- assign tokens = variant_string | split: ' ' -%}
                {%- assign total_meals_per_plan = 0 -%}
                {%- for token in tokens -%}
                  {%- assign clean = token | remove: '(' | remove: ')' | remove: '[' | remove: ']' | remove: ',' | remove: '.' | remove: '+' | remove: '–' | remove: '—' | remove: '-' | remove: 'Meal' | remove: 'Meals' | remove: 'meal' | remove: 'meals' -%}
                  {%- assign maybe_num = clean | times: 1 -%}
                  {%- if maybe_num > 0 -%}
                    {%- assign total_meals_per_plan = maybe_num -%}
                    {%- break -%}
                  {%- endif -%}
                {%- endfor -%}

                {%- assign total_meals_in_cart = total_meals_per_plan | times: item.quantity -%}
                {%- assign base_qty_per_meal = total_meals_in_cart | divided_by: num_meal_types -%}
                {%- assign remainder = total_meals_in_cart | modulo: num_meal_types -%}

                <ul class="{{ class_prefix }}__properties {{ class_prefix }}__properties--custom">
                  {%- for meal in included_meals -%}
                    {%- assign current_meal_qty = base_qty_per_meal -%}
                    {%- if remainder > 0 and forloop.index0 < remainder -%}
                      {%- assign current_meal_qty = current_meal_qty | plus: 1 -%}
                    {%- endif -%}
                    <li class="{{ class_prefix }}__property">
                      <span class="ingredient-line {{ class_prefix }}__property-value">
                        {%- if current_meal_qty > 0 -%}<span class="ingredient-qty">{{ current_meal_qty }}x</span>{%- endif -%}
                        <span class="ingredient-name">{{ meal.title | truncate: 25 }}</span>
                      </span>
                    </li>
                  {%- endfor -%}
                </ul>
              {%- endif -%}
            {%- endif -%}

            {%- assign property_size = item.properties | size -%}
            {%- if property_size > 0 and is_meal_plan == false -%}
              <ul class="{{ class_prefix }}__properties{% if is_custom_meal %} {{ class_prefix }}__properties--custom{% endif %}">
                {%- if is_custom_meal -%}
                  {%- for p in item.properties -%}
                    {%- liquid
                      assign hidden_property = false
                      if p.first.first == '_' or p.last == blank
                        assign hidden_property = true
                      endif

                      assign is_quantity_property = false
                      if p.first contains ' OZ' or p.first contains ' C' or p.first contains ' EA' or p.first contains ' SL'
                        assign is_quantity_property = true
                      endif
                    -%}
                    {%- if hidden_property == false and is_quantity_property == false -%}
                      {%- liquid
                        assign ingredient_name = p.last | strip
                        assign ingredient_key = ingredient_name | upcase
                        if ingredient_key == 'CHICKEN BREAST'
                          assign ingredient_key = 'CHICKEN'
                        endif

                        assign qty_value = ''
                        assign qty_unit = ''
                        assign units = 'OZ,C,EA,SL' | split: ','
                        for unit in units
                          assign key_simple = ingredient_key | append: ' ' | append: unit
                          assign key_with_1 = key_simple | append: ' 1'
                          assign key_with_2 = key_simple | append: ' 2'
                          assign temp_val = item.properties[key_simple]
                          if temp_val == blank
                            assign temp_val = item.properties[key_with_1]
                          endif
                          if temp_val == blank
                            assign temp_val = item.properties[key_with_2]
                          endif
                          if temp_val != blank
                            assign qty_value = temp_val
                            assign qty_unit = unit
                            break
                          endif
                        endfor
                      -%}
                      <li class="{{ class_prefix }}__property">
                        <span class="ingredient-line {{ class_prefix }}__property-value">
                          {%- if qty_value != '' -%}
                            <span class="ingredient-qty">{{ qty_value }}{{ qty_unit | downcase }}</span>
                          {%- endif -%}
                          <span class="ingredient-name">{{ ingredient_name | truncate: 25 }}</span>
                        </span>
                      </li>
                    {%- endif -%}
                  {%- endfor -%}
                {%- else -%}
                  {%- for p in item.properties -%}
                    {%- unless p.first.first == '_' or p.last == blank -%}
                      <li class="{{ class_prefix }}__property">
                        <span class="{{ class_prefix }}__property-name">{{ p.first }}:</span>
                        <span class="{{ class_prefix }}__property-value">
                          {%- if p.last contains '/uploads/' -%}
                            <a href="{{ p.last }}">{{ p.last | split: '/' | last }}</a>
                          {%- else -%}
                            {{ p.last }}
                          {%- endif -%}
                        </span>
                      </li>
                    {%- endunless -%}
                  {%- endfor -%}
                {%- endif -%}
              </ul>
            {%- endif -%}
          </div>
          <button type="button" class="{{ class_prefix }}__remove-btn" data-action="remove" aria-label="Remove item">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor" aria-hidden="true">
              <path d="M17 12C17 11.4477 16.5523 11 16 11H8C7.44772 11 7 11.4477 7 12C7 12.5523 7.44771 13 8 13H16C16.5523 13 17 12.5523 17 12Z"></path>
              <path fill-rule="evenodd" clip-rule="evenodd" d="M12 23C18.0751 23 23 18.0751 23 12C23 5.92487 18.0751 1 12 1C5.92487 1 1 5.92487 1 12C1 18.0751 5.92487 23 12 23ZM12 20.9932C7.03321 20.9932 3.00683 16.9668 3.00683 12C3.00683 7.03321 7.03321 3.00683 12 3.00683C16.9668 3.00683 20.9932 7.03321 20.9932 12C20.9932 16.9668 16.9668 20.9932 12 20.9932Z"></path>
            </svg>
          </button>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <div aria-live="polite" class="{{ class_prefix }}__empty-state cart-empty-box">
      <svg class="{{ class_prefix }}__empty-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <path d="M16 10a4 4 0 0 1-8 0"></path>
      </svg>
      <p class="{{ class_prefix }}__empty-text">{{ 'cart.general.empty' | t }}</p>
    </div>
  {% endif %}
</div>

<style>
  /* =================================================================== */
  /*  DEFINITIVE CART ITEM STYLES (V7 - Tooltip Badge)
  /* =================================================================== */

  .{{ class_prefix }}__item-details { min-width: 0; }
  .{{ class_prefix }}__item-meta {
    display: flex !important; flex-direction: column !important;
    align-items: flex-start !important; gap: 8px !important;
    margin-top: 4px !important; width: 100% !important;
  }
  .{{ class_prefix }}__item-top-row {
    display: flex; flex-wrap: wrap; align-items: center;
    gap: 1.25rem; row-gap: 8px;
  }
  .{{ class_prefix }}__item-discounts {
    list-style: none; padding: 0; margin: 0;
    display: flex; flex-wrap: wrap; gap: 6px;
  }

  /* --- Price Styling --- */
  .{{ class_prefix }}__item-price.money,
  .{{ class_prefix }}__item-price--final.money,
  .{{ class_prefix }}__item-price--original.money {
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
  }
  .{{ class_prefix }}__item-price-wrapper { display: flex; align-items: baseline; gap: 0.5rem; }
  .{{ class_prefix }}__item-price.money { font-size: 0.9rem !important; font-weight: 500 !important; color: #212529 !important; }
  .{{ class_prefix }}__item-price--final.money { font-size: 0.95rem !important; font-weight: 600 !important; color: #212529 !important; }
  .{{ class_prefix }}__item-price--original.money { font-size: 0.9rem !important; font-weight: 500 !important; color: #6c757d !important; text-decoration: line-through; }

  /* --- Fallback/Standard Discount Badge --- */
  .discount-badge {
    display: inline-flex; align-items: center; gap: 4px;
    background-color: #e9f9f0; color: #0b793d !important;
    font-size: 0.75rem; font-weight: 500;
    padding: 2px 6px; border-radius: 4px; white-space: nowrap;
  }
  .discount-badge .icon-discount {
    width: 10px; height: 10px;
  }

  .{{ class_prefix }}__item-placeholder {
    display: block;
    width: 72px;
    height: 72px;
    background-color: #f1f3f5;
    border-radius: 8px;
  }

  .{{ class_prefix }}__bundle-options { font-size: 0.85rem; color: #495057; display: flex; flex-direction: column; gap: 2px; }
  .{{ class_prefix }}__bundle-remove { margin-top: 4px; }
  .{{ class_prefix }}__bundle-remove a {
    font-size: 0.85rem;
    color: #c01923;
    text-decoration: underline;
  }
  .{{ class_prefix }}__bundle-remove a:hover { color: #9a131b; }

</style>
