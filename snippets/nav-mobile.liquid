{%- comment -%}
  ICON Meals Mobile Navigation - V10.1 (Refined UX)
  - "Quick Links" replaces dev-y wording; styled to stand out
  - Larger touch targets (primary = 60px)
  - Single-open accordions to reduce scroll friction
  - Sticky footer CTA stays visible
  - Faster close animation while respecting reduced motion
  - Defensive !important overrides to beat theme defaults
{%- endcomment -%}

<style>
  :root {
    --nav-light-bg: #FFFFFF;
    --nav-light-surface: #F7F7F7;
    --nav-light-border: #E5E7EB;
    --nav-light-text-primary: #1A1A1A;
    --nav-light-text-secondary: #6B7280;
    --nav-accent-red: #d42828;
  }

  /* --- Base Container & Overlay --- */
  .mobile-nav-v10 {
    background-color: var(--nav-light-surface) !important;
    color: var(--nav-light-text-primary) !important;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    max-width: 400px !important;
    height: 100% !important;
    z-index: 1000 !important;
    transform: translateX(-100%) !important;
    transition: transform 0.40s cubic-bezier(0.23, 1, 0.32, 1) !important; /* open */
    display: flex !important;
    flex-direction: column !important;
    font-family: var(--font-stack-header) !important;
    will-change: transform !important;
    box-shadow: 0 10px 30px rgba(0,0,0,0.12) !important;
  }
  .mobile-nav-v10.is-open { transform: translateX(0) !important; }
  .mobile-nav-v10.is-closing { transition: transform 0.25s ease-out !important; } /* snappier close */

  @media (prefers-reduced-motion: reduce) {
    .mobile-nav-v10,
    .mobile-nav-overlay-v10 {
      transition: none !important;
    }
  }

  .mobile-nav-overlay-v10 {
    position: fixed !important;
    top: 0 !important; left: 0 !important;
    width: 100% !important; height: 100% !important;
    background-color: rgba(0, 0, 0, 0.5) !important;
    z-index: 999 !important;
    opacity: 0 !important; visibility: hidden !important;
    transition: opacity 0.40s ease, visibility 0s 0.40s !important;
  }
  .mobile-nav-overlay-v10.is-open {
    opacity: 1 !important; visibility: visible !important; transition-delay: 0s !important;
  }

  /* --- Header --- */
  .mobile-nav-v10__header {
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    padding: 0 20px !important;
    height: var(--header-height-mobile) !important;
    border-bottom: 1px solid var(--nav-light-border) !important;
    background-color: var(--nav-light-bg) !important;
    flex-shrink: 0 !important;
  }
  .mobile-nav-v10__logo-link { display: block !important; line-height: 0 !important; }
  .mobile-nav-v10__logo { max-height: calc(var(--header-height-mobile) - 30px) !important; width: auto !important; }
  .mobile-nav-v10__close { background: none !important; border: none !important; padding: 8px !important; color: var(--nav-light-text-primary) !important; }
  .mobile-nav-v10__close svg { width: 28px !important; height: 28px !important; }

  /* --- Scrollable Content --- */
  .mobile-nav-v10__content { overflow-y: auto !important; padding: 24px 0 !important; flex-grow: 1 !important; -webkit-overflow-scrolling: touch !important; }

  /* --- Group Titles --- */
  .mobile-nav-v10__group-title {
    font-size: 12px !important;
    font-weight: 600 !important;
    text-transform: uppercase !important;
    letter-spacing: 0.1em !important;
    color: var(--nav-light-text-secondary) !important;
    padding: 0 24px !important;
    margin: 16px 0 12px 0 !important;
  }
  .mobile-nav-v10__group-title:first-child {
    margin-top: 0 !important;
    color: var(--nav-accent-red) !important;           /* subtle emphasis for Quick Links */
    letter-spacing: 0.12em !important;
  }

  /* --- Lists --- */
  .mobile-nav-v10__list { list-style: none !important; margin: 0 !important; padding: 0 24px !important; }
  .mobile-nav-v10__list li { margin-bottom: 8px !important; }
  .mobile-nav-v10__list li:last-child { margin-bottom: 0 !important; }

  /* --- Primary Action Items (bigger tap targets) --- */
  .mobile-nav-v10__item--primary {
    display: block !important;
    padding: 0 20px !important;
    height: 60px !important;              /* 56 -> 60 */
    line-height: 60px !important;
    font-size: 18px !important;
    font-weight: 700 !important;
    text-decoration: none !important;
    color: var(--nav-accent-red) !important;
    background-color: var(--nav-light-bg) !important;
    border: 1px solid var(--nav-light-border) !important;
    border-radius: 12px !important;
    text-align: left !important;
    transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease !important;
  }
  .mobile-nav-v10__item--primary:hover,
  .mobile-nav-v10__item--primary:focus-visible {
    background-color: var(--nav-accent-red) !important;
    color: #FFFFFF !important;
    border-color: var(--nav-accent-red) !important;
    outline: none !important;
  }
  .mobile-nav-v10__item--primary span {
    display: flex !important; align-items: center !important; justify-content: flex-start !important; gap: 12px !important;
  }
  .mobile-nav-v10__icon { width: 22px !important; height: 22px !important; color: var(--nav-accent-red) !important; flex-shrink: 0 !important; }

  /* --- Accordions --- */
  .mobile-nav-v10__accordion { border-radius: 10px !important; }
  .mobile-nav-v10__accordion summary {
    display: flex !important; align-items: center !important; justify-content: space-between !important;
    width: 100% !important; padding: 0 16px !important; height: 52px !important;
    font-size: 16px !important; font-weight: 600 !important; color: var(--nav-light-text-primary) !important;
    background-color: var(--nav-light-bg) !important; border: 1px solid var(--nav-light-border) !important;
    border-radius: 10px !important; list-style: none !important; cursor: pointer !important;
  }
  .mobile-nav-v10__accordion[open] > summary { border-color: var(--nav-accent-red) !important; box-shadow: 0 0 0 1px var(--nav-accent-red) !important; }
  .mobile-nav-v10__accordion summary::-webkit-details-marker { display: none !important; }
  .mobile-nav-v10__accordion summary > span { display: flex !important; align-items: center !important; gap: 16px !important; }
  .mobile-nav-v10__chevron { width: 24px !important; height: 24px !important; color: var(--nav-light-text-secondary) !important; transition: transform 0.3s ease !important; flex-shrink: 0 !important; }
  .mobile-nav-v10__accordion[open] > summary .mobile-nav-v10__chevron { transform: rotate(90deg) !important; }
  .mobile-nav-v10__accordion-content { padding: 8px !important; }

  .mobile-nav-v10__accordion-links { list-style: none !important; margin: 0 !important; padding: 0 !important; }
  .mobile-nav-v10__main-link {
    display: block !important; padding: 12px 16px !important; font-size: 16px !important; font-weight: 600 !important;
    color: var(--nav-light-text-primary) !important; text-decoration: none !important; border-radius: 8px !important;
    transition: color 0.2s ease, background-color 0.2s ease !important;
  }
  .mobile-nav-v10__main-link:hover,
  .mobile-nav-v10__main-link:focus-visible { background-color: var(--nav-light-border) !important; outline: none !important; }
  .mobile-nav-v10__main-link--with-icon { display: flex !important; align-items: center !important; gap: 18px !important; }
  .mobile-nav-v10__main-link--special { color: var(--nav-accent-red) !important; }

  .mobile-nav-v10__accordion-links--sub {
    padding-left: 28px !important; border-left: 2px solid var(--nav-light-border) !important;
    margin: 4px 0 12px 14px !important;
  }
  .mobile-nav-v10__accordion-links--sub a {
    display: block !important; padding: 10px 16px !important; font-size: 15px !important; font-weight: 500 !important;
    color: var(--nav-light-text-secondary) !important; text-decoration: none !important; border-radius: 8px !important;
  }
  .mobile-nav-v10__accordion-links--sub a:hover,
  .mobile-nav-v10__accordion-links--sub a:focus-visible {
    color: var(--nav-light-text-primary) !important; background-color: var(--nav-light-border) !important; outline: none !important;
  }

  /* --- Footer (sticky) --- */
  .mobile-nav-v10__footer {
    position: sticky !important;
    bottom: 0 !important;
    padding: 16px 24px !important;
    padding-bottom: calc(16px + env(safe-area-inset-bottom)) !important;
    border-top: 1px solid var(--nav-light-border) !important;
    background-color: var(--nav-light-bg) !important;
    flex-shrink: 0 !important;
  }
  .mobile-nav-v10__footer-cta {
    display: flex !important; justify-content: center !important; align-items: center !important;
    gap: 12px !important; width: 100% !important; height: 56px !important;
    background-color: var(--nav-accent-red) !important; color: #FFFFFF !important; text-decoration: none !important;
    font-size: 18px !important; font-weight: 700 !important; border-radius: 12px !important;
    transition: background-color 0.2s ease !important;
  }
  .mobile-nav-v10__footer-cta:hover,
  .mobile-nav-v10__footer-cta:focus-visible { background-color: #a71f1f !important; outline: none !important; }
  .mobile-nav-v10__footer-cta svg { width: 22px !important; height: 22px !important; stroke: currentColor !important; }

  /* --- Focus ring helper for keyboard users --- */
  .mobile-nav-v10 a:focus-visible,
  .mobile-nav-v10 button:focus-visible { outline: 2px solid var(--nav-accent-red) !important; outline-offset: 2px !important; }
</style>

<nav id="mobile-nav" class="mobile-nav-v10" aria-hidden="true" aria-label="Mobile menu">
  <!-- == HEADER == -->
  <div class="mobile-nav-v10__header">
    <a href="{{ routes.root_url }}" class="mobile-nav-v10__logo-link">
      {{ section.settings.logo | image_url: width: 360 | image_tag: loading: 'lazy', class: 'mobile-nav-v10__logo', alt: shop.name }}
    </a>
    <button class="mobile-nav-v10__close" aria-label="Close menu" type="button">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </button>
  </div>

  <!-- == SCROLLABLE CONTENT == -->
  <div class="mobile-nav-v10__content">
    <h3 class="mobile-nav-v10__group-title">Quick Links</h3>
    <ul class="mobile-nav-v10__list">
      <li>
        <a href="/collections/signature-menu" class="mobile-nav-v10__item--primary">
          <span><svg class="mobile-nav-v10__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h18v18H3zM21 9H3M21 15H3M9 3v18M15 3v18"/></svg>Order Signature Meals</span>
        </a>
      </li>
      <li>
        <a href="/pages/mealplans" class="mobile-nav-v10__item--primary">
          <span><svg class="mobile-nav-v10__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>Shop Meal Plans</span>
        </a>
      </li>
    </ul>

    <h3 class="mobile-nav-v10__group-title">Explore</h3>
    <ul class="mobile-nav-v10__list">
      <!-- SHOP -->
      <li>
        <details class="mobile-nav-v10__accordion">
          <summary>
            <span><svg class="mobile-nav-v10__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>Shop</span>
            <svg class="mobile-nav-v10__chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
          </summary>
          <div class="mobile-nav-v10__accordion-content">
            <ul class="mobile-nav-v10__accordion-links">
              <li><a href="/collections/signature-menu" class="mobile-nav-v10__main-link">Signature Menu</a></li>
              <li>
                <div class="mobile-nav-v10__main-link">Custom Meals</div>
                <ul class="mobile-nav-v10__accordion-links--sub">
                  <li><a href="/products/custom-breakfast">Breakfast</a></li>
                  <li><a href="/products/custom-meals">Lunch & Dinner</a></li>
                </ul>
              </li>
              <li><a href="/collections/bulk-items" class="mobile-nav-v10__main-link">Bulk Items</a></li>
              <li>
                <div class="mobile-nav-v10__main-link">Meal Plans</div>
                <ul class="mobile-nav-v10__accordion-links--sub">
                  <li><a href="/products/icon-meal-plan">The ICON Plan</a></li>
                  <li><a href="/products/extreme-protein-meal-plan">Extreme Protein</a></li>
                  <li><a href="/products/get-lean-meal-plan">Get Lean</a></li>
                  <li><a href="/products/keto-meal-plan">Keto</a></li>
                </ul>
              </li>
              <li>
                <div class="mobile-nav-v10__main-link">Snacks & More</div>
                <ul class="mobile-nav-v10__accordion-links--sub">
                  <li><a href="/collections/snacks">View All</a></li>
                  <li><a href="/collections/proteinpopcorn">Protein Popcorn</a></li>
                  <li><a href="/collections/butters">Protein Butters</a></li>
                  <li><a href="/collections/seasonings">Seasonings</a></li>
                </ul>
              </li>
              <li>
                <a href="/pages/gift-cards" class="mobile-nav-v10__main-link mobile-nav-v10__main-link--with-icon mobile-nav-v10__main-link--special">
                  <svg class="mobile-nav-v10__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 12 20 22 4 22 4 12"></polyline><rect x="2" y="7" width="20" height="5"></rect><line x1="12" y1="22" x2="12" y2="7"></line><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"></path><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"></path></svg>
                  Gift Cards
                </a>
              </li>
            </ul>
          </div>
        </details>
      </li>

      <!-- LEARN -->
      <li>
        <details class="mobile-nav-v10__accordion">
          <summary>
            <span><svg class="mobile-nav-v10__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>Learn</span>
            <svg class="mobile-nav-v10__chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
          </summary>
          <div class="mobile-nav-v10__accordion-content">
            <ul class="mobile-nav-v10__accordion-links">
              <li><a href="/pages/howitworks" class="mobile-nav-v10__main-link">How It Works</a></li>
              <li><a href="/pages/about" class="mobile-nav-v10__main-link">About Us</a></li>
              <li><a href="/blogs/news" class="mobile-nav-v10__main-link">Blog</a></li>
            </ul>
          </div>
        </details>
      </li>

      <!-- MORE -->
      <li>
        <details class="mobile-nav-v10__accordion">
          <summary>
            <span><svg class="mobile-nav-v10__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>More</span>
            <svg class="mobile-nav-v10__chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
          </summary>
          <div class="mobile-nav-v10__accordion-content">
            <ul class="mobile-nav-v10__accordion-links">
              <li><a href="/apps/help-center" class="mobile-nav-v10__main-link">FAQs</a></li>
              <li><a href="/pages/rewards-program-page" class="mobile-nav-v10__main-link">Refer a Friend</a></li>
              <li><a href="/pages/wholesale" class="mobile-nav-v10__main-link">Wholesale</a></li>
              <li><a href="/pages/contact" class="mobile-nav-v10__main-link">Contact Us</a></li>
            </ul>
          </div>
        </details>
      </li>
    </ul>
  </div>

  <!-- == FOOTER CTA == -->
  <div class="mobile-nav-v10__footer">
    {% if customer %}
      <a href="{{ routes.account_url }}" class="mobile-nav-v10__footer-cta">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
        <span>My Account</span>
      </a>
    {% else %}
      <a href="{{ routes.account_login_url }}" class="mobile-nav-v10__footer-cta">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
        <span>Log In / Sign Up</span>
      </a>
    {% endif %}
  </div>
</nav>

<div id="mobile-nav-overlay" class="mobile-nav-overlay-v10" aria-hidden="true"></div>

<!-- == JAVASCRIPT == -->
<script>
  function initIconMobileNavV10() {
    // Rebind in theme editor reloads
    if (window.iconMobileNavInitialized) {
      const oldTriggers = document.querySelectorAll('.site-header__mobile-trigger');
      oldTriggers.forEach(btn => {
        const newBtn = btn.cloneNode(true);
        if (btn.parentNode) { btn.parentNode.replaceChild(newBtn, btn); }
      });
    }

    const nav = document.getElementById('mobile-nav');
    const overlay = document.getElementById('mobile-nav-overlay');
    const openTriggers = document.querySelectorAll('.site-header__mobile-trigger');
    if (!nav || !overlay) return;

    const closeBtn = nav.querySelector('.mobile-nav-v10__close');

    const openNav = (e) => {
      if (e) e.preventDefault();
      nav.classList.remove('is-closing');
      nav.classList.add('is-open');
      overlay.classList.add('is-open');
      document.body.style.overflow = 'hidden';
    };

    const closeNav = () => {
      // Fast close animation
      nav.classList.add('is-closing');
      nav.classList.remove('is-open');
      overlay.classList.remove('is-open');
      document.body.style.overflow = '';
      // Clean class after animation
      window.setTimeout(() => { nav.classList.remove('is-closing'); }, 260);
    };

    openTriggers.forEach(btn => { btn.addEventListener('click', openNav); });
    if (closeBtn) closeBtn.addEventListener('click', closeNav);
    overlay.addEventListener('click', closeNav);
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && nav.classList.contains('is-open')) closeNav(); });

    // Close on link click (except toggling within <summary>)
    nav.querySelectorAll('a[href]:not([href^="#"])').forEach(link => {
      if (!link.closest('summary')) {
        link.addEventListener('click', () => { if (nav.classList.contains('is-open')) closeNav(); });
      }
    });

    // Single-open accordion behavior
    const accordions = nav.querySelectorAll('.mobile-nav-v10__accordion');
    accordions.forEach(acc => {
      acc.addEventListener('toggle', () => {
        if (acc.open) {
          accordions.forEach(other => { if (other !== acc) other.removeAttribute('open'); });
        }
      });
    });

    window.iconMobileNavInitialized = true;
  }

  document.addEventListener('DOMContentLoaded', initIconMobileNavV10);
  document.addEventListener('shopify:section:load', () => {
    window.iconMobileNavInitialized = false;
    initIconMobileNavV10();
  });
</script>
