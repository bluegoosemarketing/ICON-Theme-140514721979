{%- comment -%}
  ==============================================================================
  GIFT CARD STATION: SANDBOXED EDITION üõ°Ô∏è
  - Strategy: Uses #icon-gc-widget ID to overwrite ALL theme globals.
  - Fixes: Unresponsive clicks, layout shifting, and text updates.
  ==============================================================================
{%- endcomment -%}

{%- liquid
  assign gift_product = product_obj
  
  # Map the IDs
  assign id_opt_1 = id_option_1
  assign id_opt_2 = id_option_2
  assign id_opt_3 = id_option_3
-%}

<style>
  /* --- WIDGET SCOPE (ID prevents theme conflicts) --- */
  #icon-gc-widget {
    --gc-red: #D21F2F; 
    --gc-white: #ffffff;
    --gc-black: #050505;
    --gc-border: #333;
    
    font-family: inherit; /* Use theme font but reset everything else */
    box-sizing: border-box;
    line-height: 1.5;
  }

  /* CONTAINER */
  #icon-gc-widget .gc-station {
    background: radial-gradient(circle at 90% 10%, #1a0505 0%, #000000 70%);
    border-radius: 8px; 
    margin-bottom: 40px;
    border: 1px solid var(--gc-border);
    color: #fff;
    box-shadow: 0 10px 40px rgba(0,0,0,0.4);
    position: relative;
    overflow: hidden;
    /* Ensure container doesn't have theme padding */
    padding: 0 !important;
  }

  /* ANIMATED BORDER (Left Side) */
  #icon-gc-widget .gc-station::before {
    content: "";
    position: absolute;
    top: 0; left: 0;
    width: 8px; height: 100%;
    z-index: 5;
    background: repeating-linear-gradient(
      45deg,
      var(--gc-red),
      var(--gc-red) 10px,
      var(--gc-white) 10px,
      var(--gc-white) 20px
    );
    background-size: 200% 200%;
    animation: gc-candy-rush 15s linear infinite;
    box-shadow: 0 0 15px rgba(210, 31, 47, 0.5);
    pointer-events: none; /* Crucial: Ensures border doesn't block clicks */
  }

  @keyframes gc-candy-rush {
    0% { background-position: 0% 50%; }
    100% { background-position: 0% 100%; }
  }

  #icon-gc-widget .gc-grid {
    display: grid;
    grid-template-columns: 1fr 1.3fr;
    min-height: 280px;
  }

  /* --- LEFT PANEL --- */
  #icon-gc-widget .gc-content {
    padding: 40px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    position: relative;
    z-index: 2;
  }

  #icon-gc-widget .gc-tag {
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    align-self: flex-start;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 6px;
    color: #fff;
  }

  #icon-gc-widget .gc-content h2 {
    font-size: 36px !important;
    font-weight: 900 !important;
    line-height: 0.95 !important;
    margin: 0 0 15px 0 !important;
    color: #fff !important;
    text-transform: uppercase !important;
    font-style: italic !important;
    letter-spacing: normal !important;
  }
  
  #icon-gc-widget .gc-content p {
    font-size: 15px !important;
    color: #aaa !important;
    line-height: 1.5 !important;
    margin: 0 0 25px 0 !important;
    max-width: 95%;
  }

  /* TIMER */
  #icon-gc-widget .gc-timer {
    display: flex;
    align-items: center;
    gap: 15px;
    background: rgba(0,0,0,0.5);
    padding: 12px 20px;
    border-radius: 6px;
    border: 1px solid #333;
    width: fit-content;
  }
  #icon-gc-widget .timer-block {
    text-align: center;
  }
  #icon-gc-widget .timer-num {
    display: block;
    font-size: 22px !important;
    font-weight: 800;
    color: #ffffff !important;
    text-shadow: 0 0 10px rgba(255,255,255,0.4);
    font-family: monospace;
    line-height: 1;
  }
  #icon-gc-widget .timer-label {
    font-size: 9px;
    text-transform: uppercase;
    color: #888;
    margin-top: 4px;
    display: block;
  }
  #icon-gc-widget .timer-text-right {
    font-size: 10px;
    color: #fff;
    font-weight: 700;
    padding-left: 15px;
    border-left: 1px solid #555;
    line-height: 1.3;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* --- RIGHT PANEL --- */
  #icon-gc-widget .gc-actions {
    padding: 30px 40px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    background: rgba(255,255,255,0.02);
    border-left: 1px solid #222;
    z-index: 10; /* Ensure this sits above everything */
  }
  
  #icon-gc-widget .gc-action-label {
    text-align: center;
    font-size: 11px !important;
    text-transform: uppercase;
    color: #888 !important;
    margin-bottom: 15px !important;
    font-weight: 700 !important;
    letter-spacing: 2px !important;
    display: block;
  }

  #icon-gc-widget .gc-options-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
  }

  /* --- THE NUCLEAR BUTTON RESET --- */
  /* Using ID specificity to override ANY theme styles */
  #icon-gc-widget button.gc-btn {
    all: unset !important; /* Removes default button styles */
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
    box-sizing: border-box !important;
    
    background: #0B0B0D !important;
    border: 1px solid #333 !important;
    color: #fff !important;
    border-radius: 4px !important;
    padding: 25px 5px !important;
    cursor: pointer !important;
    transition: all 0.2s !important;
    
    position: relative !important;
    height: auto !important;
    min-height: 110px !important;
    width: 100% !important;
    margin: 0 !important;
    box-shadow: none !important;
  }

  /* Pseudo-element clean up just in case theme adds icons */
  #icon-gc-widget button.gc-btn::before { content: none !important; }

  #icon-gc-widget button.gc-btn:hover {
    border-color: var(--gc-red) !important;
    background: #111 !important;
    transform: translateY(-3px);
    box-shadow: 0 5px 20px rgba(0,0,0,0.5) !important;
  }

  #icon-gc-widget .gc-btn span.emoji { 
    font-size: 20px !important; 
    margin-bottom: 5px !important; 
    display: block !important; 
    line-height: 1 !important;
  }
  
  #icon-gc-widget .gc-btn span.denom {
    font-size: 42px !important;
    font-weight: 900 !important;
    color: #fff !important;
    font-style: italic !important;
    line-height: 1 !important;
    display: block !important;
    margin-bottom: 5px !important;
    font-family: inherit !important;
  }

  #icon-gc-widget .gc-btn span.label {
    font-size: 10px !important;
    text-transform: uppercase !important;
    color: #666 !important;
    font-weight: 700 !important;
    letter-spacing: 0.5px !important;
    display: block !important;
    line-height: 1.2 !important;
  }
  #icon-gc-widget .gc-btn:hover span.label { color: #fff !important; }

  /* STATES */
  #icon-gc-widget .gc-btn.is-added { 
    background: var(--gc-red) !important; 
    border-color: var(--gc-red) !important; 
  }
  #icon-gc-widget .gc-btn.is-loading { opacity: 0.6; pointer-events: none; }
  
  /* Custom Spinner (Replacing theme spinner if any) */
  #icon-gc-widget .gc-btn.is-loading::after {
    content: "" !important; 
    position: absolute !important; 
    top: 10px !important; right: 10px !important;
    width: 14px !important; height: 14px !important; 
    border: 2px solid #fff !important; 
    border-top-color: transparent !important; 
    border-radius: 50% !important;
    animation: gc-spin 0.6s linear infinite !important;
    display: block !important;
  }
  @keyframes gc-spin { to { transform: rotate(360deg); } }

  #icon-gc-widget .gc-footer-note {
    text-align: center; 
    margin-top: 20px; 
    font-size: 12px !important; 
    color: #ccc !important;
    font-style: italic;
    letter-spacing: 0.5px;
    font-weight: 400 !important;
  }

  /* --- MOBILE RESPONSIVE --- */
  @media (max-width: 900px) {
    #icon-gc-widget .gc-grid { grid-template-columns: 1fr; }
    #icon-gc-widget .gc-station::before { width: 100%; height: 6px; top: 0; left: 0; }
    
    #icon-gc-widget .gc-content { 
      padding: 35px 20px; 
      align-items: center; 
      text-align: center; 
    }
    
    #icon-gc-widget .gc-actions { 
      border-left: none; 
      border-top: 1px solid #222; 
      padding: 30px 20px; 
    }
    
    /* Vertical Stack for Buttons */
    #icon-gc-widget .gc-options-grid {
      grid-template-columns: 1fr; 
      gap: 15px;
    }
    
    #icon-gc-widget button.gc-btn {
      min-height: 80px !important; 
      padding: 15px !important;
    }
    #icon-gc-widget .gc-btn span.denom { font-size: 32px !important; }
  }
</style>

<div id="icon-gc-widget">
  <div class="gc-station">
    <div class="gc-grid">
      
      <div class="gc-content">
        <div class="gc-tag">
          <span>üéÖ Santa Approved</span>
        </div>
        
        <h2>Save Christmas.<br>Instantly. üéÅ</h2>
        <p>Forgot to shop? We won't tell. Send a digital gift card instantly to their inbox. No shipping. No stress.</p>

        <div class="gc-timer" id="xmas-timer">
          <div class="timer-block">
            <span class="timer-num" id="d-days">00</span>
            <span class="timer-label">Days</span>
          </div>
          <div class="timer-block">
            <span class="timer-num" id="d-hours">00</span>
            <span class="timer-label">Hrs</span>
          </div>
          <div class="timer-block">
            <span class="timer-num" id="d-mins">00</span>
            <span class="timer-label">Mins</span>
          </div>
          <div class="timer-text-right">
            UNTIL<br>CHRISTMAS
          </div>
        </div>
      </div>

      <div class="gc-actions">
        <div class="gc-action-label">
          Select Gift Card Amount
        </div>
        
        <div class="gc-options-grid">
          <button class="gc-btn js-gc-add" data-variant-id="{{ id_opt_1 }}" type="button">
            <span class="emoji">‚ùÑÔ∏è</span>
            <span class="denom">$100</span>
            <span class="label">Standard</span>
          </button>

          <button class="gc-btn js-gc-add" data-variant-id="{{ id_opt_2 }}" type="button">
            <span class="emoji">üéÑ</span>
            <span class="denom">$250</span>
            <span class="label">Pro Choice</span>
          </button>

          <button class="gc-btn js-gc-add" data-variant-id="{{ id_opt_3 }}" type="button">
            <span class="emoji">üî•</span>
            <span class="denom">$500</span>
            <span class="label">The Ultimate</span>
          </button>
        </div>
        
        <div class="gc-footer-note">
          "Best. Gift. Ever." ‚Äî Your Gym Partner
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // --- COUNTDOWN LOGIC ---
    const timerEl = document.getElementById('xmas-timer');
    if(timerEl) {
      const now = new Date();
      let year = now.getFullYear();
      let xmas = new Date(year, 11, 25);
      
      if (now.getMonth() === 11 && now.getDate() > 25) {
        xmas.setFullYear(year + 1);
      }

      function updateTimer() {
        const current = new Date();
        const diff = xmas - current;

        if (diff <= 0) {
          timerEl.innerHTML = '<div style="font-weight:bold; color:#fff;">MERRY CHRISTMAS! üéÑ</div>';
          return;
        }

        const d = Math.floor(diff / (1000 * 60 * 60 * 24));
        const h = Math.floor((diff / (1000 * 60 * 60)) % 24);
        const m = Math.floor((diff / 1000 / 60) % 60);

        const dEl = document.getElementById('d-days');
        const hEl = document.getElementById('d-hours');
        const mEl = document.getElementById('d-mins');

        if(dEl) dEl.innerText = d < 10 ? '0'+d : d;
        if(hEl) hEl.innerText = h < 10 ? '0'+h : h;
        if(mEl) mEl.innerText = m < 10 ? '0'+m : m;
      }
      setInterval(updateTimer, 1000);
      updateTimer();
    }

    // --- ADD TO CART LOGIC ---
    const buttons = document.querySelectorAll('.js-gc-add');
    buttons.forEach(btn => {
      btn.addEventListener('click', async (e) => {
        // Stop bubbling just in case theme catches clicks
        e.stopPropagation();
        e.preventDefault();
        
        const variantId = btn.getAttribute('data-variant-id');
        if(!variantId) return;

        const originalHTML = btn.innerHTML;
        
        btn.classList.add('is-loading');

        try {
          const response = await fetch('/cart/add.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              items: [{ id: Number(variantId), quantity: 1 }]
            })
          });

          if(response.ok) {
            const cart = await response.json();
            
            btn.classList.remove('is-loading');
            btn.classList.add('is-added');
            btn.innerHTML = '<span style="font-size:20px; display:block;">üéÖ</span><span style="font-weight:bold; font-size:12px; display:block;">IN THE BAG</span>';
            
            document.dispatchEvent(new CustomEvent('cart:updated', { detail: { cart } }));

            setTimeout(() => {
              btn.classList.remove('is-added');
              btn.innerHTML = originalHTML;
            }, 3000);
          } else {
            throw new Error('Failed');
          }
        } catch (err) {
          console.error(err);
          btn.classList.remove('is-loading');
        }
      });
    });
  });
</script>
