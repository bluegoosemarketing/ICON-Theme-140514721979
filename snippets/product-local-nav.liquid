{% comment %}
<!--
************************************************************************************
*
*  Product Page - Local Navigation Header (v4.1 - Definitive Menu Fix)
*  --------------------------------------------------------------------------------
*  - REFACTOR: Replaced the old dropdown with the new, unified mega-menu structure.
*  - CONSISTENCY: Now provides the exact same hierarchical and responsive menu
*    experience as the main collection pages.
*  - BUG FIX: Corrected the mobile sub-panel header structure to ensure the title
*    remains perfectly centered, resolving the layout issue from the Codex patch.
*
************************************************************************************
-->
{% endcomment %}

{%- comment -%}
  ================================================================================
  CONFIGURATION
  ================================================================================
  1. Set the default fallback link text and URL below.
  2. Add new tag-to-collection mappings inside the `case` statement.
     The product tag MUST be an exact match to the `when '...'` value.
  ================================================================================
{%- endcomment -%}

{%- liquid
  assign fallback_title = "Signature Menu"
  assign fallback_url = "/collections/signature-menu"

  assign collection_title = fallback_title
  assign collection_url = fallback_url
-%}

{%- if product.handle contains 'meal-plan' or product.tags contains 'Meal Plan' or product.tags contains 'Meal Plans' -%}
  {%- assign collection_title = "Meal Plans" -%}
  {%- assign collection_url = "/pages/mealplans" -%}
{%- else -%}
  {%- comment -%}
    Loop through product tags to find the first match and set the correct
    collection title and URL. The `break` tag exits the loop after the first match.
  {%- endcomment -%}
  {%- for tag in product.tags -%}
    {%- case tag -%}
      {%- when 'Signature Menu' -%}
        {%- assign collection_title = "Signature Menu" -%}
        {%- assign collection_url = "/collections/signature-menu" -%}
        {%- break -%}

      {%- when 'Bulk Items' -%}
        {%- assign collection_title = "Bulk Items" -%}
        {%- assign collection_url = "/collections/bulk-items" -%}
        {%- break -%}

      {%- when 'Protein Popcorn' -%}
        {%- assign collection_title = "Protein Popcorn" -%}
        {%- assign collection_url = "/collections/proteinpopcorn" -%}
        {%- break -%}

      {%- when 'Protein Butters' -%}
        {%- assign collection_title = "Protein Butters" -%}
        {%- assign collection_url = "/collections/butters" -%}
        {%- break -%}

      {%- when 'Protein Coffee' -%}
        {%- assign collection_title = "Protein Coffee" -%}
        {%- assign collection_url = "/collections/proteincoffee" -%}
        {%- break -%}
    {%- endcase -%}
  {%- endfor -%}
{%- endif -%}

{% if product.handle == 'custom-meals' or product.handle == 'custom-breakfast' %}
  <div class="collection-header">
    <div class="collection-selector" id="CollectionSelectorSticky" aria-expanded="false">
      {% assign custom_title = product.title %}
      {% assign collection_menu = linklists[section.settings.collection_menu] %}
      {% if collection_menu and collection_menu.links != blank %}
        {% for l in collection_menu.links %}
          {% if l.url == product.url %}
            {% assign custom_title = l.title %}
          {% endif %}
        {% endfor %}
      {% endif %}
      <button class="collection-selector__toggle" type="button" aria-haspopup="true" aria-controls="CollectionMenuSticky">
        <span class="collection-header__title">{{ custom_title }}</span>
        <svg class="collection-selector__icon" viewBox="0 0 10 6" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M1 1l4 4 4-4" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <div class="collection-selector__overlay"></div>
      <nav id="CollectionMenuSticky" class="collection-selector__menu" role="navigation" aria-label="Product Categories">
          <div class="collection-selector__menu-content-wrapper">
              <div class="collection-selector__menu-main">
                  <div class="collection-selector__mobile-header">
                      <span class="collection-selector__mobile-title">Shop Our Menu</span>
                      <button class="collection-selector__mobile-close-btn" aria-label="Close menu">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12 5.7 16.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"></path></svg>
                      </button>
                  </div>
                    <button class="collection-selector__menu-main-trigger" data-target-panel="panel-meals-sticky" data-title="Shop Meals">
                      <span class="trigger-content">
                        <span class="trigger-title">Shop Meals</span>
                        <span class="trigger-subtitle">Signature, Custom & Bulk Prep</span>
                      </span>
                    </button>
                    <button class="collection-selector__menu-main-trigger" data-target-panel="panel-meal-plans-sticky" data-title="Meal Plans">
                      <span class="trigger-content">
                        <span class="trigger-title">Meal Plans</span>
                        <span class="trigger-subtitle">Goal-Focused â€¢ 12 or 24 Meals</span>
                      </span>
                    </button>
                    <button class="collection-selector__menu-main-trigger" data-target-panel="panel-snacks-sticky" data-title="Snacks">
                      <span class="trigger-content">
                        <span class="trigger-title">Snacks</span>
                        <span class="trigger-subtitle">Protein Popcorn & More</span>
                      </span>
                    </button>
                    <button class="collection-selector__menu-main-trigger" data-target-panel="panel-extras-sticky" data-title="Extras">
                      <span class="trigger-content">
                        <span class="trigger-title">Extras</span>
                        <span class="trigger-subtitle">Upgrade Your Order</span>
                      </span>
                    </button>
              </div>

              <div class="collection-selector__menu-sub-panels">
                  <div class="collection-selector__mobile-header">
                     <button class="collection-selector__mobile-back-btn" aria-label="Back to main menu">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20"><path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" /></svg>
                         <span>Back</span>
                     </button>
                     <span class="collection-selector__mobile-title" data-panel-title></span>
                     <button class="collection-selector__mobile-close-btn" aria-label="Close menu">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12 5.7 16.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"></path></svg>
                     </button>
                  </div>
                  
                  <div id="panel-meals-sticky" class="collection-selector__menu-sub-panel">
                      <h3 class="collection-selector__menu-header">Meals</h3>
                      <ul>
                        <li><a href="/collections/signature-menu" role="menuitem">Signature Meals</a></li>
                        <li><a href="/products/custom-meals" role="menuitem">Custom Meals</a></li>
                        <li><a href="/products/custom-breakfast" role="menuitem">Custom Breakfast</a></li>
                        <li><a href="/collections/bulk-items" role="menuitem">Bulk Items</a></li>
                      </ul>
                  </div>

                  <div id="panel-meal-plans-sticky" class="collection-selector__menu-sub-panel">
                      <h3 class="collection-selector__menu-header">Goal-Focused Meal Plans</h3>
                      <ul>
                        <li><a href="/products/build-your-own-meal-plan" role="menuitem">Build Your Own</a></li>
                        <li><a href="/products/icon-meal-plan" role="menuitem">The ICON Plan</a></li>
                        <li><a href="/products/extreme-protein-meal-plan" role="menuitem">Extreme Protein</a></li>
                        <li><a href="/products/get-lean-meal-plan" role="menuitem">Get Lean</a></li>
                        <li><a href="/products/lean-lifter-meal-plan" role="menuitem">Lean Lifter</a></li>
                        <li><a href="/products/keto-meal-plan" role="menuitem">Keto</a></li>
                      </ul>
                  </div>

                  <div id="panel-snacks-sticky" class="collection-selector__menu-sub-panel">
                      <h3 class="collection-selector__menu-header">Snacks</h3>
                      <ul>
                        <li><a href="/collections/proteinpopcorn" role="menuitem">Protein Popcorn</a></li>
                        <li><a href="/collections/butters" role="menuitem">Protein Butters</a></li>
                      </ul>
                  </div>

                  <div id="panel-extras-sticky" class="collection-selector__menu-sub-panel">
                      <h3 class="collection-selector__menu-header">Extras</h3>
                      <ul>
                        <li><a href="/collections/proteincoffee" role="menuitem">Protein Coffee</a></li>
                        <li><a href="/collections/seasonings" role="menuitem">Seasonings</a></li>
                      </ul>
                  </div>
              </div>
          </div>
      </nav>
    </div>
  </div>
{% else %}
  <div class="collection-header">
    <a href="{{ collection_url }}" class="collection-header__title back-to-collection-link">
      <svg class="back-arrow-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"></path></svg>
      <span>{{ collection_title }}</span>
    </a>
  </div>
{% endif %}

{% if product.handle == 'custom-meals' or product.handle == 'custom-breakfast' %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // --- World-Class Collection Menu Controller v1.2 (for Sticky Nav) ---
    const collectionSelector = document.getElementById('CollectionSelectorSticky');
    if (collectionSelector) {
        const toggleButton = collectionSelector.querySelector('.collection-selector__toggle');
        const menu = collectionSelector.querySelector('#CollectionMenuSticky');
        const mainTriggers = menu.querySelectorAll('.collection-selector__menu-main-trigger');
        const subPanels = menu.querySelectorAll('.collection-selector__menu-sub-panel');
        const mobileCloseBtns = menu.querySelectorAll('.collection-selector__mobile-close-btn');
        const mobileBackBtn = menu.querySelector('.collection-selector__mobile-back-btn');
        const mobilePanelTitle = menu.querySelector('[data-panel-title]');
        const overlay = collectionSelector.querySelector('.collection-selector__overlay');
        let isMobile = window.innerWidth <= 991;

        const openMenu = () => {
            collectionSelector.setAttribute('aria-expanded', 'true');
            if (isMobile) document.body.style.overflow = 'hidden';
        };

        const closeMenu = () => {
            collectionSelector.setAttribute('aria-expanded', 'false');
            if (isMobile) {
                document.body.style.overflow = '';
                menu.classList.remove('is-sub-menu-active');
                subPanels.forEach(p => p.classList.remove('is-active'));
                mainTriggers.forEach(t => t.classList.remove('is-active'));
            }
        };

        const toggleMenu = () => {
            const isOpen = collectionSelector.getAttribute('aria-expanded') === 'true';
            isOpen ? closeMenu() : openMenu();
        };

        const activatePanel = (panelId, triggerEl) => {
            mainTriggers.forEach(t => t.classList.remove('is-active'));
            subPanels.forEach(p => p.classList.remove('is-active'));
            
            if(triggerEl) triggerEl.classList.add('is-active');
            const targetPanel = document.getElementById(panelId);
            if (targetPanel) {
                targetPanel.classList.add('is-active');
            }
        };

        toggleButton.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleMenu();
        });

        mainTriggers.forEach(trigger => {
            const panelId = trigger.dataset.targetPanel;
            if (isMobile) {
                trigger.addEventListener('click', () => {
                    const title = trigger.dataset.title || trigger.querySelector('.trigger-title').textContent.trim();
                    if(mobilePanelTitle) mobilePanelTitle.textContent = title;
                    activatePanel(panelId, trigger);
                    menu.classList.add('is-sub-menu-active');
                });
            } else { // Desktop logic
                trigger.addEventListener('mouseenter', () => {
                    activatePanel(panelId, trigger);
                });
            }
        });
        
        if (!isMobile && mainTriggers.length > 0) {
            activatePanel(mainTriggers[0].dataset.targetPanel, mainTriggers[0]);
        }
        

        if(mobileBackBtn) {
            mobileBackBtn.addEventListener('click', () => {
                menu.classList.remove('is-sub-menu-active');
            });
        }

        if (mobileCloseBtns.length) {
            mobileCloseBtns.forEach(btn => btn.addEventListener('click', closeMenu));
        }
          
        document.addEventListener('click', (e) => {
          if (!collectionSelector.contains(e.target)) closeMenu();
        });
        if (overlay) {
          overlay.addEventListener('click', closeMenu);
        }
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && collectionSelector.getAttribute('aria-expanded') === 'true') closeMenu();
        });
        window.addEventListener('resize', () => { isMobile = window.innerWidth <= 991; if (!isMobile) closeMenu(); });
    }
  });
</script>
{% endif %}