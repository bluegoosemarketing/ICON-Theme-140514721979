{%- comment -%}
  Cart Preview Sidebar - V1.3 (Definitive Logic Fix & Full Footer Restore)
  - FIXED: The `has_meal_plan` check is now specific and no longer incorrectly identifies custom meals as meal plans.
  - RESTORED: The footer has been restored to its full, multi-action state to match the cart drawer.
{%- endcomment -%}

{%- liquid
  assign meal_target = 8

  assign has_meal_plan = false
  for progress_item in cart.items
    assign product_type_lower = progress_item.product.type | downcase
    if product_type_lower contains 'meal plan' or progress_item.product.handle contains 'meal-plan'
      assign has_meal_plan = true
      break
    endif
  endfor

  if has_meal_plan
    assign progress_current = meal_target
    assign progress_target = meal_target
    assign progress_percentage = 100
    assign checkout_url = '/pages/add-ons'
    assign progress_message = "Great! You have enough meals to checkout."
  elsif settings.enable_free_delivery_promo
    assign free_delivery_target = settings.free_delivery_threshold | default: 21
    assign progress_current = 0
    assign excluded_collections = 'proteinpopcorn,butters,proteincoffee,seasonings' | split: ','
    assign rc_progress_bundles = '|'
    for progress_item in cart.items
      assign rc_bundle_id = progress_item.properties._rc_bundle
      if rc_bundle_id != blank
        assign rc_bundle_token = '|' | append: rc_bundle_id | append: '|'
        if rc_progress_bundles contains rc_bundle_token
          continue
        endif
        assign rc_progress_bundles = rc_progress_bundles | append: rc_bundle_id | append: '|'
        assign bundle_quantity = progress_item.quantity | times: 1
        assign progress_current = progress_current | plus: bundle_quantity
        continue
      endif
      assign item_collections = progress_item.product.collections | map: 'handle'
      assign is_excluded = false
      for excluded in excluded_collections
        if item_collections contains excluded
          assign is_excluded = true
          break
        endif
      endfor
      assign product_type_lower = progress_item.product.type | downcase
      if product_type_lower contains 'meal plan' or progress_item.product.handle contains 'meal-plan' or progress_item.product.type == 'OPTIONS_HIDDEN_PRODUCT'
        assign is_excluded = true
      endif
      unless is_excluded
        assign item_multiplier = 1
        if progress_item.variant.title contains 'Meal'
          assign potential = progress_item.variant.title | split: ' ' | first | times: 1
          if potential > 0
            assign item_multiplier = potential
          endif
        endif
        assign item_meals = progress_item.quantity | times: item_multiplier
        assign progress_current = progress_current | plus: item_meals
      endunless
    endfor
    if progress_current < meal_target
      assign remaining_meals = meal_target | minus: progress_current
      if remaining_meals < 0
        assign remaining_meals = 0
      endif
      assign progress_percentage = progress_current | times: 100.0 | divided_by: meal_target
      assign progress_target = meal_target
      capture progress_message
        echo "Add " | append: remaining_meals | append: " more meals to checkout."
      endcapture
      assign checkout_url = '/pages/add-ons'
    else
      assign remaining_free_delivery = free_delivery_target | minus: progress_current
      if remaining_free_delivery < 0
        assign remaining_free_delivery = 0
      endif
      assign progress_percentage = progress_current | times: 100.0 | divided_by: free_delivery_target
      assign progress_target = free_delivery_target
      if progress_current >= free_delivery_target and settings.free_delivery_discount_code != blank
        assign checkout_url = '/pages/add-ons?discount=' | append: settings.free_delivery_discount_code
      else
        assign checkout_url = '/pages/add-ons'
      endif
      capture progress_message
        if progress_current >= free_delivery_target
          echo settings.free_delivery_unlocked_message
          if settings.free_delivery_discount_code != blank
            echo " Use code " | append: settings.free_delivery_discount_code | append: " at checkout."
          endif
        else
          echo settings.free_delivery_locked_message | replace: '{remaining}', remaining_free_delivery
        endif
      endcapture
    endif
  else
    assign progress_current = 0
    assign non_meal_types = 'peanut butter,protein popcorn,seasoning,beverage,options_hidden_product' | split: ','
    assign rc_progress_bundles = '|'
    for progress_item in cart.items
      assign rc_bundle_id = progress_item.properties._rc_bundle
      if rc_bundle_id != blank
        assign rc_bundle_token = '|' | append: rc_bundle_id | append: '|'
        if rc_progress_bundles contains rc_bundle_token
          continue
        endif
        assign rc_progress_bundles = rc_progress_bundles | append: rc_bundle_id | append: '|'
        assign bundle_quantity = progress_item.quantity | times: 1
        assign progress_current = progress_current | plus: bundle_quantity
        continue
      endif
      assign product_type_lower = progress_item.product.type | downcase
      if non_meal_types contains product_type_lower
        continue
      endif
      assign item_multiplier = 1
      if progress_item.variant.title contains 'Meal'
        assign potential = progress_item.variant.title | split: ' ' | first | times: 1
        if potential > 0
          assign item_multiplier = potential
        endif
      endif
      assign item_meals = progress_item.quantity | times: item_multiplier
      assign progress_current = progress_current | plus: item_meals
    endfor
    assign remaining_meals = meal_target | minus: progress_current
    if remaining_meals < 0
      assign remaining_meals = 0
    endif
    assign progress_percentage = progress_current | times: 100.0 | divided_by: meal_target
    assign progress_target = meal_target

    if progress_current >= meal_target
      assign progress_message = "Great! You have enough meals to checkout."
    else
      assign progress_message = "Add " | append: remaining_meals | append: " more meals to checkout."
    endif
    assign checkout_url = '/pages/add-ons'
  endif

  if progress_percentage > 100
    assign progress_percentage = 100
  endif
-%}

<div class="cart-sidebar-section-wrapper" data-wetheme-section-id="cart-preview-sidebar" data-wetheme-section-type="cart-sidebar-section">
  <div id="cart-sidebar" class="cart-sidebar">
    <div class="cart-sidebar__header">
      <h2 class="cart-sidebar__title">{{ 'cart.general.title' | t }}</h2>
    </div>
    {%- if cart.item_count > 0 -%}
      <div class="cart-progress cart-progress--green">
        <p class="cart-progress__text" aria-live="polite">{{ progress_message | strip }}</p>
        <div class="cart-progress__bar" role="progressbar" aria-label="Meal progress toward order minimum" aria-valuenow="{{ progress_current }}" aria-valuemin="0" aria-valuemax="{{ progress_target }}" aria-valuetext="{{ progress_current }} of {{ progress_target }} meals">
          <div class="cart-progress__bar-inner" style="width: {{ progress_percentage }}%;"></div>
        </div>
      </div>
    {%- endif -%}
    
    {% render 'cart-item-list', context: 'sidebar' %}

    {% if cart.item_count > 0 %}
      <div class="cart-sidebar__footer">
                  <div class="cart-sidebar__summary">
            <span class="cart-sidebar__summary-label">{{ 'cart.general.subtotal' | t }}</span>
            <span class="cart-sidebar__summary-value">
              {%- if cart.total_discount > 0 -%}<del class="money">{{ cart.original_total_price | money }}</del>{%- endif -%}
              <span class="money"><span style="display:none" class="tdf-cart-total-flag"></span>{{ cart.total_price | money }}</span>
            </span>
          </div>
        <p class="cart-drawer__subtext">{{ 'cart.general.taxes_and_shipping_at_checkout' | t }}</p>
        <div class="cart-sidebar__actions">
           <a href="{{ checkout_url }}" class="btn cart-sidebar__checkout-btn">
            Proceed to Checkout
          </a>
        </div>
        <div class="cart-drawer__continue-action">
          <a href="{{ routes.cart_url }}" class="cart-drawer__secondary-link">View Full Cart</a>
        </div>
      </div>
    {% endif %}
    <div class="cart-sidebar__loader-overlay">
      <div class="cart-sidebar__spinner"></div>
    </div>
  </div>
</div>