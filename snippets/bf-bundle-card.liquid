{%- liquid
  assign product = product_obj
  assign current_variant = product.selected_or_first_available_variant
  assign normalized_cta_type = cta_type | default: 'add_to_cart'
  assign cta_label = cta_text
  
  # --- TITLE OVERRIDE LOGIC ---
  assign display_title = title_override | default: product.title

  if normalized_cta_type == 'link_to_product'
    if cta_label == blank
      assign cta_label = 'View Product'
    endif
  else
    if cta_label == blank
      assign cta_label = 'Add Bundle'
    endif
  endif

  # Calculate discount percentage if needed
  assign discount_amt = 0
  if current_variant.compare_at_price > current_variant.price
    assign discount_amt = current_variant.compare_at_price | minus: current_variant.price | times: 100.0 | divided_by: current_variant.compare_at_price | round
  endif
-%}

{%- if product and current_variant -%}
  <div class="bf-bundle-card">
    
    {%- comment -%} IMAGE AREA {%- endcomment -%}
    <a class="bf-bundle-card__image-wrapper" href="{{ product.url }}">
      <div class="bf-bundle-card__image">
        {%- if product.featured_image -%}
          <img
            src="{{ product.featured_image | image_url: width: 800 }}"
            alt="{{ product.featured_image.alt | escape }}"
            width="400"
            height="240"
            loading="lazy"
          >
        {%- endif -%}
      </div>
      
      {%- comment -%} BADGES - Using Green for Savings to match price {%- endcomment -%}
      <div class="bf-bundle-card__badges">
        {% if badge_text != blank %}
          <span class="bf-badge bf-badge--custom">{{ badge_text }}</span>
        {% elsif discount_amt > 0 %}
          <span class="bf-badge bf-badge--save">Save {{ discount_amt }}%</span>
        {% endif %}
      </div>
    </a>

    {%- comment -%} CONTENT AREA {%- endcomment -%}
    <div class="bf-bundle-card__content">
      
      <div class="bf-bundle-card__header">
        <h3 class="bf-bundle-card__title">{{ display_title }}</h3>
        {%- if tagline != blank -%}
          <p class="bf-bundle-card__tagline">{{ tagline }}</p>
        {%- endif -%}
      </div>

      {%- comment -%} PRICE BREAKDOWN - RECEIPT STYLE {%- endcomment -%}
      <div class="bf-bundle-card__meta">
        
        {%- comment -%} Retail Value {%- endcomment -%}
        {% if compare_text != blank %}
          <div class="bf-meta-row bf-meta-row--compare">
            <span class="bf-meta-label">Retail Value:</span>
            <span class="bf-meta-value strike">{{ compare_text }}</span>
          </div>
        {% elsif current_variant.compare_at_price > current_variant.price %}
           <div class="bf-meta-row bf-meta-row--compare">
            <span class="bf-meta-label">Retail Value:</span>
            <span class="bf-meta-value strike">{{ current_variant.compare_at_price | money }}</span>
          </div>
        {% endif %}

        {%- comment -%} Black Friday Price - Neon Green {%- endcomment -%}
        <div class="bf-meta-row bf-meta-row--price">
          <span class="bf-meta-label">Black Friday Price:</span>
          <span class="bf-price-highlight">
            {% if price_override_text != blank %}
              {{ price_override_text }}
            {% else %}
              {{ current_variant.price | money }}
            {% endif %}
          </span>
        </div>

        {%- comment -%} Detail/Math - Sunny Yellow {%- endcomment -%}
        {% if bottom_detail_text != blank %}
           <div class="bf-meta-row bf-meta-row--detail">
            {{ bottom_detail_text }}
          </div>
        {% endif %}

      </div>

    </div>

    {%- comment -%} ACTION AREA {%- endcomment -%}
    <div class="bf-bundle-card__footer">
      {% if normalized_cta_type == 'link_to_product' %}
        <a class="bf-bundle-card__add-btn bf-bundle-card__link-cta" href="{{ product.url }}">
          <span>{{ cta_label }}</span>
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h13M12 5l7 7-7 7"/></svg>
        </a>
      {% else %}
        <form method="post" action="/cart/add" class="js-addons-form" data-slot="{{ slot }}" data-product-handle="{{ product.handle }}">
          <input type="hidden" name="id" value="{{ current_variant.id }}">
          <input type="hidden" name="quantity" value="1">
          <button
            type="submit"
            class="bf-bundle-card__add-btn js-add-to-cart-btn"
            {% unless current_variant.available %}disabled{% endunless %}
          >
            <span>{% if current_variant.available %}{{ cta_label }}{% else %}Sold Out{% endif %}</span>
            {% if current_variant.available %}
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            {% endif %}
          </button>
        </form>
      {% endif %}
    </div>
  </div>
{%- endif -%}